/* esm.sh - esbuild bundle(langchain@0.0.92/dist/llms/openai) denonext production */
import __Process$ from "node:process";
import{Configuration as pt,OpenAIApi as dt}from"/v135/openai@3.3.0/denonext/openai.mjs";var Se=()=>typeof window<"u"&&typeof window.document<"u",$e=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",je=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),be=()=>typeof Deno<"u",R=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!be(),ke=()=>{let n;return Se()?n="browser":R()?n="node":$e()?n="webworker":je()?n="jsdom":be()?n="deno":n="other",n},te;async function ge(){return te===void 0&&(te={library:"langchain-js",runtime:ke()}),te}function p(n){try{return typeof __Process$<"u"?__Process$.env?.[n]:void 0}catch{return}}import H from"/v135/axios@1.6.2/denonext/axios.mjs";var D="text/event-stream";async function we(n,e){let t=n.getReader();for(;;){let r=await t.read();if(r.done){e(new Uint8Array,!0);break}e(r.value)}}function _e(n){let e,t,r,i=!1;return function(o,s){if(s){n(o,0,!0);return}e===void 0?(e=o,t=0,r=-1):e=Me(e,o);let u=e.length,c=0;for(;t<u;){i&&(e[t]===10&&(c=++t),i=!1);let l=-1;for(;t<u&&l===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-c);break;case 13:i=!0;case 10:l=t;break}if(l===-1)break;n(e.subarray(c,l),r),c=t,r=-1}c===u?e=void 0:c!==0&&(e=e.subarray(c),t-=c)}}function Ae(n,e,t){let r=re(),i=new TextDecoder;return function(o,s,u){if(u){Ce(r)||(n?.(r),r=re());return}if(o.length===0)n?.(r),r=re();else if(s>0){let c=i.decode(o.subarray(0,s)),l=s+(o[s+1]===32?2:1),d=i.decode(o.subarray(l));switch(c){case"data":r.data=r.data?r.data+`
`+d:d;break;case"event":r.event=d;break;case"id":e?.(r.id=d);break;case"retry":{let h=parseInt(d,10);Number.isNaN(h)||t?.(r.retry=h);break}}}}}function Me(n,e){let t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function re(){return{data:"",event:"",id:"",retry:void 0}}function Ce(n){return n.data===""&&n.event===""&&n.id===""&&n.retry===void 0}function ze(n){try{return JSON.stringify(n)}catch{return n}}function Ke(n,e,t){let{validateStatus:r}=t.config;!t.status||!r||r(t.status)?n(t):e(V(`Request failed with status code ${t.status} and body ${typeof t.data=="string"?t.data:ze(t.data)}`,t.config,null,t.request,t))}function De(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}function He(n,e){return e?n.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):n}function Pe(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Ve(n,e,t){if(!e)return n;var r;if(t)r=t(e);else if(Je(e))r=e.toString();else{var i=[];Oe(e,function(s,u){s===null||typeof s>"u"||(xe(s)?u=`${u}[]`:s=[s],Oe(s,function(l){Ue(l)?l=l.toISOString():qe(l)&&(l=JSON.stringify(l)),i.push(`${Pe(u)}=${Pe(l)}`)}))}),r=i.join("&")}if(r){var a=n.indexOf("#");a!==-1&&(n=n.slice(0,a)),n+=(n.indexOf("?")===-1?"?":"&")+r}return n}function Be(n,e){return n&&!De(e)?He(n,e):e}function We(n){return typeof n>"u"}function qe(n){return n!==null&&typeof n=="object"}function Ue(n){return toString.call(n)==="[object Date]"}function Je(n){return toString.call(n)==="[object URLSearchParams]"}function xe(n){return Array.isArray(n)}function Oe(n,e){if(!(n===null||typeof n>"u"))if(typeof n!="object"&&(n=[n]),xe(n))for(var t=0,r=n.length;t<r;t++)e.call(null,n[t],t,n);else for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&e.call(null,n[i],i,n)}function Ge(n){return toString.call(n)==="[object FormData]"}function Ye(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof window<"u"&&typeof document<"u"}async function O(n){let e=Ze(n),t=await Fe(e,n);return new Promise((r,i)=>{t instanceof Error?i(t):Object.prototype.toString.call(n.settle)==="[object Function]"?n.settle(r,i,t):Ke(r,i,t)})}async function Fe(n,e){let t;try{t=await fetch(n)}catch(a){return a&&a.name==="AbortError"?V("Request aborted",e,"ECONNABORTED",n):a&&a.name==="TimeoutError"?V("Request timeout",e,"ECONNABORTED",n):V("Network Error",e,"ERR_NETWORK",n)}let r={};t.headers.forEach((a,o)=>{r[o]=a});let i={ok:t.ok,status:t.status,statusText:t.statusText,headers:r,config:e,request:n};if(t.status>=200&&t.status!==204)if(e.responseType==="stream"){let a=t.headers.get("content-type");if(!a?.startsWith(D)){if(t.status>=400)return a?.startsWith("application/json")?(i.data=await t.json(),i):(i.data=await t.text(),i);throw new Error(`Expected content-type to be ${D}, Actual: ${a}`)}await we(t.body,_e(Ae(e.onmessage)))}else switch(e.responseType){case"arraybuffer":i.data=await t.arrayBuffer();break;case"blob":i.data=await t.blob();break;case"json":i.data=await t.json();break;case"formData":i.data=await t.formData();break;default:i.data=await t.text();break}return i}function Ze(n){let e=new Headers(n.headers);if(n.auth){let o=n.auth.username||"",s=n.auth.password?decodeURI(encodeURIComponent(n.auth.password)):"";e.set("Authorization",`Basic ${btoa(`${o}:${s}`)}`)}let t=n.method.toUpperCase(),r={headers:e,method:t};t!=="GET"&&t!=="HEAD"&&(r.body=n.data,Ge(r.body)&&Ye()&&e.delete("Content-Type")),typeof r.body=="string"&&(r.body=new TextEncoder().encode(r.body)),n.mode&&(r.mode=n.mode),n.cache&&(r.cache=n.cache),n.integrity&&(r.integrity=n.integrity),n.redirect&&(r.redirect=n.redirect),n.referrer&&(r.referrer=n.referrer),n.timeout&&n.timeout>0&&(r.signal=AbortSignal.timeout(n.timeout)),n.signal&&(r.signal=n.signal),We(n.withCredentials)||(r.credentials=n.withCredentials?"include":"omit"),n.responseType==="stream"&&r.headers.set("Accept",D);let i=Be(n.baseURL,n.url),a=Ve(i,n.params,n.paramsSerializer);return new Request(a,r)}function V(n,e,t,r,i){if(H.AxiosError&&typeof H.AxiosError=="function")return new H.AxiosError(n,H.AxiosError[t],e,r,i);let a=new Error(n);return Qe(a,e,t,r,i)}function Qe(n,e,t,r,i){return n.config=e,t&&(n.code=t),n.request=r,n.response=i,n.isAxiosError=!0,n.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},n}var ne=(n,e)=>n.reduce((t,r,i)=>{let a=Math.floor(i/e),o=t[a]||[];return t[a]=o.concat([r]),t},[]);import Xe from"/v135/object-hash@3.0.0/denonext/object-hash.mjs";var ie=(...n)=>Xe(n.join("_"));var Ee="__run",ae=class{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e}toJSON(){return{type:this._getType(),data:{content:this.text,role:"role"in this?this.role:void 0}}}};var B=class extends ae{_getType(){return"ai"}};var W=class{};var et=new Map,q=class n extends W{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(ie(e,t))??null)}async update(e,t,r){this.cache.set(ie(e,t),r)}static global(){return new n(et)}};import tt from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import se from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var rt=[400,401,403,404,405,406,407,408,409],_=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let t="default"in se?se.default:se;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>tt(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let i=r?.response?.status;if(i&&rt.includes(+i))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((i,a)=>{e.signal?.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};import{Tiktoken as nt,getEncodingNameForModel as it}from"/v135/js-tiktoken@1.0.8/denonext/lite.js";var U={},at=new _({});async function st(n,e){return n in U||(U[n]=at.fetch(`https://tiktoken.pages.dev/js/${n}.json`,{signal:e?.signal}).then(t=>t.json()).catch(t=>{throw delete U[n],t})),new nt(await U[n],e?.extendedSpecialTokens)}async function J(n,e){return st(it(n),e)}var oe=n=>n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k-")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n;var ot=n=>{switch(oe(n)){case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":return 4097;case"text-curie-001":return 2048;case"text-babbage-001":return 2048;case"text-ada-001":return 2048;case"code-davinci-002":return 8e3;case"code-cushman-001":return 2048;default:return 4097}},ue=async({prompt:n,modelName:e})=>{let t=Math.ceil(n.length/4);try{t=(await J(e)).encode(n).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count")}return ot(e)-t};var ut=()=>!1,le=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??ut(),this.callbacks=e.callbacks}},G=class extends le{get callKeys(){return["stop","timeout","signal"]}constructor(e){super({verbose:e.verbose,callbacks:e.callbacks??e.callbackManager}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new _(e??{})}async getNumTokens(e){let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await J("modelName"in this?oe(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return this._encoding&&(t=this._encoding.encode(e).length),t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...i}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let a={openai:(await import("/v135/langchain@0.0.92/denonext/dist/chat_models/openai.js")).ChatOpenAI}[t];if(a===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new a(i)}};import{v4 as $}from"/v135/uuid@9.0.1/denonext/uuid.mjs";import*as ve from"/v135/uuid@9.0.1/denonext/uuid.mjs";var ce=class{},x=class n extends ce{constructor(e){super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ve.v4()}),Object.assign(this,e)}}return new t}};import Ie from"/v135/ansi-styles@5.2.0/denonext/ansi-styles.mjs";var A=class extends x{constructor(){super(),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}_startTrace(e){if(e.parent_run_id!==void 0){let t=this.runMap.get(e.parent_run_id);t&&this._addChildRun(t,e)}this.runMap.set(e.id,e)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,i,a){let o=this._getExecutionOrder(i),s={id:r,name:e.name,parent_run_id:i,start_time:Date.now(),serialized:e,inputs:{prompts:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:a};this._startTrace(s),await this.onLLMStart?.(s)}async handleChatModelStart(e,t,r,i,a){let o=this._getExecutionOrder(i),s={id:r,name:e.name,parent_run_id:i,start_time:Date.now(),serialized:e,inputs:{messages:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:a};this._startTrace(s),await this.onLLMStart?.(s)}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.outputs=e,await this.onLLMEnd?.(r),await this._endTrace(r)}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.error=e.message,await this.onLLMError?.(r),await this._endTrace(r)}async handleChainStart(e,t,r,i){let a=this._getExecutionOrder(i),o={id:r,name:e.name,parent_run_id:i,start_time:Date.now(),serialized:e,inputs:t,execution_order:a,child_execution_order:a,run_type:"chain",child_runs:[]};this._startTrace(o),await this.onChainStart?.(o)}async handleChainEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.outputs=e,await this.onChainEnd?.(r),await this._endTrace(r)}async handleChainError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.error=e.message,await this.onChainError?.(r),await this._endTrace(r)}async handleToolStart(e,t,r,i){let a=this._getExecutionOrder(i),o={id:r,name:e.name,parent_run_id:i,start_time:Date.now(),serialized:e,inputs:{input:t},execution_order:a,child_execution_order:a,run_type:"tool",child_runs:[]};this._startTrace(o),await this.onToolStart?.(o)}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.outputs={output:e},await this.onToolEnd?.(r),await this._endTrace(r)}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.error=e.message,await this.onToolError?.(r),await this._endTrace(r)}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let i=r;i.actions=i.actions||[],i.actions.push(e),await this.onAgentAction?.(r)}};function y(n,e){return`${n.open}${e}${n.close}`}function P(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function v(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:g}=Ie,S=class extends A{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let i=this.runMap.get(r.parent_run_id);if(i)t.push(i),r=i;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((i,a,o)=>{let s=`${i.execution_order}:${i.run_type}:${i.name}`;return a===o.length-1?y(Ie.bold,s):s}).join(" > ");return y(g.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${y(g.green,"[chain/start]")} [${t}] Entering Chain run with input: ${P(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${y(g.cyan,"[chain/end]")} [${t}] [${v(e)}] Exiting Chain run with output: ${P(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${y(g.red,"[chain/error]")} [${t}] [${v(e)}] Chain run errored with error: ${P(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(i=>i.trim())}:e.inputs;console.log(`${y(g.green,"[llm/start]")} [${t}] Entering LLM run with input: ${P(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${y(g.cyan,"[llm/end]")} [${t}] [${v(e)}] Exiting LLM run with output: ${P(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${y(g.red,"[llm/error]")} [${t}] [${v(e)}] LLM run errored with error: ${P(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${y(g.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${y(g.cyan,"[tool/end]")} [${t}] [${v(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${y(g.red,"[tool/error]")} [${t}] [${v(e)}] Tool run errored with error: ${P(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${y(g.blue,"[agent/action]")} [${r}] Agent selected action: ${P(t.actions[t.actions.length-1],"[action]")}`)}};var Y=class extends A{constructor({exampleId:e,sessionName:t,callerParams:r,timeout:i}={}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:p("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"sessionName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:5e3});let a=p("LANGCHAIN_API_KEY");a&&(this.headers["x-api-key"]=a),this.sessionName=t??p("LANGCHAIN_SESSION"),this.exampleId=e,this.timeout=i??this.timeout,this.caller=new _(r??{maxRetries:2})}async _convertToCreate(e,t=void 0){let r=e.extra??{};return r.runtime=await ge(),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.parent_run_id?void 0:t,extra:r,parent_run_id:e.parent_run_id,execution_order:e.execution_order,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs??{},session_name:this.sessionName,child_runs:[]}}async persistRun(e){}async _persistRunSingle(e){let t=await this._convertToCreate(e,this.exampleId),r=`${this.endpoint}/runs`,i=await this.caller.call(fetch,r,{method:"POST",headers:this.headers,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout)}),a=await i.text();if(!i.ok)throw new Error(`Failed to persist run: ${i.status} ${i.statusText} ${a}`)}async _updateRunSingle(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,parent_run_id:e.parent_run_id,reference_example_id:e.reference_example_id},r=`${this.endpoint}/runs/${e.id}`,i=await this.caller.call(fetch,r,{method:"PATCH",headers:this.headers,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout)}),a=await i.text();if(!i.ok)throw new Error(`Failed to update run: ${i.status} ${i.statusText} ${a}`)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}};function I(n,e="Human",t="AI"){let r=[];for(let i of n){let a;if(i._getType()==="human")a=e;else if(i._getType()==="ai")a=t;else if(i._getType()==="system")a="System";else if(i._getType()==="generic")a=i.role;else throw new Error(`Got unsupported message type: ${i}`);r.push(`${a}: ${i.text}`)}return r.join(`
`)}var F=class extends A{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:p("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let e=p("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let t=this.session??await this.loadDefaultSession(),r=e.serialized,i;if(e.run_type==="llm"){let a=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(s=>I(s));i={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,prompts:a,response:e.outputs}}else if(e.run_type==="chain"){let a=await Promise.all(e.child_runs.map(s=>this.convertV2RunToRun(s)));i={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:a.filter(s=>s.type==="llm"),child_chain_runs:a.filter(s=>s.type==="chain"),child_tool_runs:a.filter(s=>s.type==="tool")}}else if(e.run_type==="tool"){let a=await Promise.all(e.child_runs.map(s=>this.convertV2RunToRun(s)));i={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(r),child_llm_runs:a.filter(s=>s.type==="llm"),child_chain_runs:a.filter(s=>s.type==="chain"),child_tool_runs:a.filter(s=>s.type==="tool")}}else throw new Error(`Unknown run type: ${e.run_type}`);return i}async persistRun(e){let t,r;e.run_type!==void 0?r=await this.convertV2RunToRun(e):r=e,r.type==="llm"?t=`${this.endpoint}/llm-runs`:r.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`;let i=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});i.ok||console.error(`Failed to persist run: ${i.status} ${i.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;let i=await t.json();return i.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=i,this.session=r,r)}};async function Te(n){let e=new F;return n?await e.loadSession(n):await e.loadDefaultSession(),e}async function Ne(){return new Y}var pe=class{setHandler(e){return this.setHandlers([e])}},j=class{constructor(e,t,r,i){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:i})}async handleText(e){await Promise.all(this.handlers.map(async t=>{try{await t.handleText?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`)}}))}},Z=class extends j{async handleLLMNewToken(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${r}`)}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`)}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`)}}))}},de=class extends j{getChild(){let e=new T(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${r}`)}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${r}`)}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`)}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`)}}))}},he=class extends j{getChild(){let e=new T(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`)}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`)}}))}},T=class n extends pe{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=$(),i=void 0,a=void 0){return await Promise.all(this.handlers.map(async o=>{if(!o.ignoreLLM)try{await o.handleLLMStart?.(e,t,r,this._parentRunId,a)}catch(s){console.error(`Error in handler ${o.constructor.name}, handleLLMStart: ${s}`)}})),new Z(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChatModelStart(e,t,r=$(),i=void 0,a=void 0){let o;return await Promise.all(this.handlers.map(async s=>{if(!s.ignoreLLM)try{s.handleChatModelStart?await s.handleChatModelStart?.(e,t,r,this._parentRunId,a):s.handleLLMStart&&(o=t.map(u=>I(u)),await s.handleLLMStart?.(e,o,r,this._parentRunId,a))}catch(u){console.error(`Error in handler ${s.constructor.name}, handleLLMStart: ${u}`)}})),new Z(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,t,r=$()){return await Promise.all(this.handlers.map(async i=>{if(!i.ignoreChain)try{await i.handleChainStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${i.constructor.name}, handleChainStart: ${a}`)}})),new de(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,t,r=$()){return await Promise.all(this.handlers.map(async i=>{if(!i.ignoreAgent)try{await i.handleToolStart?.(e,t,r,this._parentRunId)}catch(a){console.error(`Error in handler ${i.constructor.name}, handleToolStart: ${a}`)}})),new he(r,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let i of this.handlers){let a=this.inheritableHandlers.includes(i);r.addHandler(i,a)}for(let i of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===i.name)||r.addHandler(i,t);return r}static fromHandlers(e){class t extends x{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:$()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r){let i;(e||t)&&(Array.isArray(e)||!e?(i=new n,i.setHandlers(e?.map(Le)??[],!0)):i=e,i=i.copy(Array.isArray(t)?t.map(Le):t?.handlers,!1));let a=p("LANGCHAIN_VERBOSE")||r?.verbose,o=p("LANGCHAIN_TRACING_V2")??!1,s=o||(p("LANGCHAIN_TRACING")??!1);if(a||s){if(i||(i=new n),a&&!i.handlers.some(u=>u.name===S.prototype.name)){let u=new S;i.addHandler(u,!0)}if(s&&!i.handlers.some(u=>u.name==="langchain_tracer"))if(o)i.addHandler(await Ne(),!0);else{let u=p("LANGCHAIN_SESSION");i.addHandler(await Te(u),!0)}}return i}};function Le(n){return"name"in n?n:x.fromMethods(n)}var k=class extends G{constructor({cache:e,concurrency:t,...r}){super(t?{maxConcurrency:t,...r}:r),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof e=="object"?this.cache=e:e?this.cache=q.global():this.cache=void 0}async generatePrompt(e,t,r){let i=e.map(a=>a.toString());return this.generate(i,t,r)}invocationParams(){return{}}async _generateUncached(e,t,r){let i=await T.configure(r,this.callbacks,{verbose:this.verbose}),a={invocation_params:this?.invocationParams()},o=await i?.handleLLMStart({name:this._llmType()},e,void 0,void 0,a),s;try{s=await this._generate(e,t,o)}catch(u){throw await o?.handleLLMError(u),u}return await o?.handleLLMEnd(s),Object.defineProperty(s,Ee,{value:o?{runId:o?.runId}:void 0,configurable:!0}),s}async generate(e,t,r){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let i;if(Array.isArray(t)?i={stop:t}:t?.timeout&&!t.signal?i={...t,signal:AbortSignal.timeout(t.timeout)}:i=t??{},!this.cache)return this._generateUncached(e,i,r);let{cache:a}=this,o=this.serialize();o.stop=i.stop??o.stop;let s=`${Object.entries(o).sort()}`,u=[],c=await Promise.all(e.map(async(d,h)=>{let f=await a.lookup(d,s);return f||u.push(h),f})),l={};if(u.length>0){let d=await this._generateUncached(u.map(h=>e[h]),i,r);await Promise.all(d.generations.map(async(h,f)=>{let m=u[f];return c[m]=h,a.update(e[m],s,h)})),l=d.llmOutput??{}}return{generations:c,llmOutput:l}}async call(e,t,r){let{generations:i}=await this.generate([e],t??{},r);return i[0][0].text}async predict(e,t,r){return this.call(e,t,r)}async predictMessages(e,t,r){let i=I(e),a=await this.call(i,t,r);return new B(a)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}static async deserialize(e){let{_type:t,_model:r,...i}=e;if(r&&r!=="base_llm")throw new Error(`Cannot load LLM with model ${r}`);let a={openai:(await import("/v135/langchain@0.0.92/denonext/dist/llms/openai.js")).OpenAI}[t];if(a===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new a(i)}},Q=class extends k{async _generate(e,t,r){return{generations:await Promise.all(e.map(a=>this._call(a,t,r).then(o=>[{text:o}])))}}};import{Configuration as lt,OpenAIApi as ct}from"/v135/openai@3.3.0/denonext/openai.mjs";var X=async(n,e,t,r,i,a,o,s,u)=>(await n.call(fetch,"https://api.promptlayer.com/track-request",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({function_name:e,provider:"langchain",args:t,kwargs:r,tags:i,request_response:a,request_start_time:Math.floor(o/1e3),request_end_time:Math.floor(s/1e3),api_key:u})})).json();var N=class extends Q{get callKeys(){return["stop","signal","timeout","options"]}constructor(e,t){super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"prefixMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??p("OPENAI_API_KEY"),i=e?.azureOpenAIApiKey??p("AZURE_OPENAI_API_KEY");if(!i&&!r)throw new Error("(Azure) OpenAI API key not found");let a=e?.azureOpenAIApiInstanceName??p("AZURE_OPENAI_API_INSTANCE_NAME"),o=e?.azureOpenAIApiDeploymentName??p("AZURE_OPENAI_API_DEPLOYMENT_NAME"),s=e?.azureOpenAIApiVersion??p("AZURE_OPENAI_API_VERSION");if(this.modelName=e?.modelName??this.modelName,this.prefixMessages=e?.prefixMessages??this.prefixMessages,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.maxTokens=e?.maxTokens,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=s,this.azureOpenAIApiKey=i,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=o,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,logit_bias:this.logitBias,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}formatMessages(e){let t={role:"user",content:e};return this.prefixMessages?[...this.prefixMessages,t]:[t]}async _call(e,t,r){let{stop:i}=t,a=this.invocationParams();return a.stop=i??a.stop,(a.stream?await new Promise((s,u)=>{let c,l=!1,d=!1;this.completionWithRetry({...a,messages:this.formatMessages(e)},{signal:t.signal,...t.options,adapter:O,responseType:"stream",onmessage:h=>{if(h.data?.trim?.()==="[DONE]"){if(d)return;d=!0,s(c)}else{let f=JSON.parse(h.data);c||(c={id:f.id,object:f.object,created:f.created,model:f.model,choices:[]});for(let m of f.choices)if(m!=null){let w=c.choices.find(ee=>ee.index===m.index);w||(w={index:m.index,finish_reason:m.finish_reason??void 0},c.choices.push(w)),w.message||(w.message={role:m.delta?.role,content:m.delta?.content??""}),w.message.content+=m.delta?.content??"",r?.handleLLMNewToken(m.delta?.content??"")}!d&&f.choices.every(m=>m.finish_reason!=null)&&(d=!0,s(c))}}}).catch(h=>{l||(l=!0,u(h))})}):await this.completionWithRetry({...a,messages:this.formatMessages(e)},{signal:t.signal,...t.options})).choices[0].message?.content??""}async completionWithRetry(e,t){if(!this.client){let i=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,a=new lt({...this.clientConfig,basePath:i,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new ct(a)}let r={adapter:R()?void 0:O,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(i=>i.data)}_llmType(){return"openai"}},me=class extends N{constructor(e){if(super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.plTags=e?.plTags??[],this.returnPromptLayerId=e?.returnPromptLayerId??!1,this.promptLayerApiKey=e?.promptLayerApiKey??p("PROMPTLAYER_API_KEY"),!this.promptLayerApiKey)throw new Error("Missing PromptLayer API key")}async completionWithRetry(e,t){return e.stream?super.completionWithRetry(e,t):await super.completionWithRetry(e)}async _generate(e,t,r){let i;return{generations:await Promise.all(e.map(async o=>{let s=Date.now(),u=await this._call(o,t,r),c=Date.now();i=[{text:u}];let l={text:u},d=await X(this.caller,"langchain.PromptLayerOpenAIChat",[o],this._identifyingParams(),this.plTags,l,s,c,this.promptLayerApiKey);return this.returnPromptLayerId===!0&&d.success===!0&&(i[0].generationInfo={promptLayerRequestId:d.request_id}),i}))}}};var fe=class extends k{get callKeys(){return["stop","signal","timeout","options"]}constructor(e,t){if(e?.modelName?.startsWith("gpt-3.5-turbo")||e?.modelName?.startsWith("gpt-4")||e?.modelName?.startsWith("gpt-4-32k"))return new N(e,t);super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"bestOf",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-davinci-003"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??p("OPENAI_API_KEY"),i=e?.azureOpenAIApiKey??p("AZURE_OPENAI_API_KEY");if(!i&&!r)throw new Error("(Azure) OpenAI API key not found");let a=e?.azureOpenAIApiInstanceName??p("AZURE_OPENAI_API_INSTANCE_NAME"),o=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??(p("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||p("AZURE_OPENAI_API_DEPLOYMENT_NAME")),s=e?.azureOpenAIApiVersion??p("AZURE_OPENAI_API_VERSION");if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.batchSize=e?.batchSize??this.batchSize,this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.maxTokens=e?.maxTokens??this.maxTokens,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.bestOf=e?.bestOf??this.bestOf,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=s,this.azureOpenAIApiKey=i,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=o,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.streaming&&this.bestOf>1)throw new Error("Cannot stream results when bestOf > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,best_of:this.bestOf,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let{stop:i}=t,a=ne(e,this.batchSize),o=[],s={};if(this.stop&&i)throw new Error("Stop found in input and default params");let u=this.invocationParams();if(u.stop=i??u.stop,u.max_tokens===-1){if(e.length!==1)throw new Error("max_tokens set to -1 not supported for multiple inputs");u.max_tokens=await ue({prompt:e[0],modelName:this.modelName})}for(let l=0;l<a.length;l+=1){let d=u.stream?await new Promise((w,ee)=>{let E=[],M,ye=!1,C=!1;this.completionWithRetry({...u,prompt:a[l]},{signal:t.signal,...t.options,adapter:O,responseType:"stream",onmessage:z=>{if(z.data?.trim?.()==="[DONE]"){if(C)return;C=!0,w({...M,choices:E})}else{let L=JSON.parse(z.data);M||(M={id:L.id,object:L.object,created:L.created,model:L.model});for(let b of L.choices)if(b!=null&&b.index!=null){E[b.index]||(E[b.index]={});let K=E[b.index];K.text=(K.text??"")+(b.text??""),K.finish_reason=b.finish_reason,K.logprobs=b.logprobs,r?.handleLLMNewToken(b.text??"")}!C&&E.every(b=>b.finish_reason!=null)&&(C=!0,w({...M,choices:E}))}}}).catch(z=>{ye||(ye=!0,ee(z))})}):await this.completionWithRetry({...u,prompt:a[l]},{signal:t.signal,...t.options});o.push(...d.choices);let{completion_tokens:h,prompt_tokens:f,total_tokens:m}=d.usage??{};h&&(s.completionTokens=(s.completionTokens??0)+h),f&&(s.promptTokens=(s.promptTokens??0)+f),m&&(s.totalTokens=(s.totalTokens??0)+m)}return{generations:ne(o,this.n).map(l=>l.map(d=>({text:d.text??"",generationInfo:{finishReason:d.finish_reason,logprobs:d.logprobs}}))),llmOutput:{tokenUsage:s}}}async completionWithRetry(e,t){if(!this.client){let i=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,a=new pt({...this.clientConfig,basePath:i,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new dt(a)}let r={adapter:R()?void 0:O,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createCompletion.bind(this.client),e,r).then(i=>i.data)}_llmType(){return"openai"}},Re=class extends fe{constructor(e){if(super(e),Object.defineProperty(this,"promptLayerApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"plTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnPromptLayerId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.plTags=e?.plTags??[],this.promptLayerApiKey=e?.promptLayerApiKey??p("PROMPTLAYER_API_KEY"),this.returnPromptLayerId=e?.returnPromptLayerId,!this.promptLayerApiKey)throw new Error("Missing PromptLayer API key")}async completionWithRetry(e,t){return e.stream?super.completionWithRetry(e,t):await super.completionWithRetry(e)}async _generate(e,t,r){let i=Date.now(),a=await super._generate(e,t,r);for(let o=0;o<a.generations.length;o+=1){let s=Date.now(),u={text:a.generations[o][0].text,llm_output:a.llmOutput},c=await X(this.caller,"langchain.PromptLayerOpenAI",[e[o]],this._identifyingParams(),this.plTags,u,i,s,this.promptLayerApiKey),l;this.returnPromptLayerId===!0&&(c&&c.success===!0&&(l=c.request_id),a.generations[o][0].generationInfo={...a.generations[o][0].generationInfo,promptLayerRequestId:l})}return a}};export{fe as OpenAI,N as OpenAIChat,Re as PromptLayerOpenAI,me as PromptLayerOpenAIChat};
//# sourceMappingURL=openai.js.map