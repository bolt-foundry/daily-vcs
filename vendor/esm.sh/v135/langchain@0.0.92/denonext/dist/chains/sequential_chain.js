/* esm.sh - esbuild bundle(langchain@0.0.92/dist/chains/sequential_chain) denonext production */
import __Process$ from "node:process";
var N="__run";import{v4 as w}from"/v135/uuid@9.0.1/denonext/uuid.mjs";import*as K from"/v135/uuid@9.0.1/denonext/uuid.mjs";var P=class{},m=class s extends P{constructor(e){super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class r extends s{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:K.v4()}),Object.assign(this,e)}}return new r}};import z from"/v135/ansi-styles@5.2.0/denonext/ansi-styles.mjs";var d=class extends m{constructor(){super(),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,r){e.child_runs.push(r)}_startTrace(e){if(e.parent_run_id!==void 0){let r=this.runMap.get(e.parent_run_id);r&&this._addChildRun(r,e)}this.runMap.set(e.id,e)}async _endTrace(e){let r=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);r?r.child_execution_order=Math.max(r.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id)}_getExecutionOrder(e){let r=e!==void 0&&this.runMap.get(e);return r?r.child_execution_order+1:1}async handleLLMStart(e,r,t,n,i){let a=this._getExecutionOrder(n),o={id:t,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{prompts:r},execution_order:a,child_runs:[],child_execution_order:a,run_type:"llm",extra:i};this._startTrace(o),await this.onLLMStart?.(o)}async handleChatModelStart(e,r,t,n,i){let a=this._getExecutionOrder(n),o={id:t,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{messages:r},execution_order:a,child_runs:[],child_execution_order:a,run_type:"llm",extra:i};this._startTrace(o),await this.onLLMStart?.(o)}async handleLLMEnd(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="llm")throw new Error("No LLM run to end.");t.end_time=Date.now(),t.outputs=e,await this.onLLMEnd?.(t),await this._endTrace(t)}async handleLLMError(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="llm")throw new Error("No LLM run to end.");t.end_time=Date.now(),t.error=e.message,await this.onLLMError?.(t),await this._endTrace(t)}async handleChainStart(e,r,t,n){let i=this._getExecutionOrder(n),a={id:t,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:r,execution_order:i,child_execution_order:i,run_type:"chain",child_runs:[]};this._startTrace(a),await this.onChainStart?.(a)}async handleChainEnd(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="chain")throw new Error("No chain run to end.");t.end_time=Date.now(),t.outputs=e,await this.onChainEnd?.(t),await this._endTrace(t)}async handleChainError(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="chain")throw new Error("No chain run to end.");t.end_time=Date.now(),t.error=e.message,await this.onChainError?.(t),await this._endTrace(t)}async handleToolStart(e,r,t,n){let i=this._getExecutionOrder(n),a={id:t,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{input:r},execution_order:i,child_execution_order:i,run_type:"tool",child_runs:[]};this._startTrace(a),await this.onToolStart?.(a)}async handleToolEnd(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="tool")throw new Error("No tool run to end");t.end_time=Date.now(),t.outputs={output:e},await this.onToolEnd?.(t),await this._endTrace(t)}async handleToolError(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="tool")throw new Error("No tool run to end");t.end_time=Date.now(),t.error=e.message,await this.onToolError?.(t),await this._endTrace(t)}async handleAgentAction(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="chain")return;let n=t;n.actions=n.actions||[],n.actions.push(e),await this.onAgentAction?.(t)}};function c(s,e){return`${s.open}${e}${s.close}`}function p(s,e){try{return JSON.stringify(s,null,2)}catch{return e}}function y(s){if(!s.end_time)return"";let e=s.end_time-s.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:h}=z,_=class extends d{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let r=[],t=e;for(;t.parent_run_id;){let n=this.runMap.get(t.parent_run_id);if(n)r.push(n),t=n;else break}return r}getBreadcrumbs(e){let t=[...this.getParents(e).reverse(),e].map((n,i,a)=>{let o=`${n.execution_order}:${n.run_type}:${n.name}`;return i===a.length-1?c(z.bold,o):o}).join(" > ");return c(h.grey,t)}onChainStart(e){let r=this.getBreadcrumbs(e);console.log(`${c(h.green,"[chain/start]")} [${r}] Entering Chain run with input: ${p(e.inputs,"[inputs]")}`)}onChainEnd(e){let r=this.getBreadcrumbs(e);console.log(`${c(h.cyan,"[chain/end]")} [${r}] [${y(e)}] Exiting Chain run with output: ${p(e.outputs,"[outputs]")}`)}onChainError(e){let r=this.getBreadcrumbs(e);console.log(`${c(h.red,"[chain/error]")} [${r}] [${y(e)}] Chain run errored with error: ${p(e.error,"[error]")}`)}onLLMStart(e){let r=this.getBreadcrumbs(e),t="prompts"in e.inputs?{prompts:e.inputs.prompts.map(n=>n.trim())}:e.inputs;console.log(`${c(h.green,"[llm/start]")} [${r}] Entering LLM run with input: ${p(t,"[inputs]")}`)}onLLMEnd(e){let r=this.getBreadcrumbs(e);console.log(`${c(h.cyan,"[llm/end]")} [${r}] [${y(e)}] Exiting LLM run with output: ${p(e.outputs,"[response]")}`)}onLLMError(e){let r=this.getBreadcrumbs(e);console.log(`${c(h.red,"[llm/error]")} [${r}] [${y(e)}] LLM run errored with error: ${p(e.error,"[error]")}`)}onToolStart(e){let r=this.getBreadcrumbs(e);console.log(`${c(h.green,"[tool/start]")} [${r}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let r=this.getBreadcrumbs(e);console.log(`${c(h.cyan,"[tool/end]")} [${r}] [${y(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let r=this.getBreadcrumbs(e);console.log(`${c(h.red,"[tool/error]")} [${r}] [${y(e)}] Tool run errored with error: ${p(e.error,"[error]")}`)}onAgentAction(e){let r=e,t=this.getBreadcrumbs(e);console.log(`${c(h.blue,"[agent/action]")} [${t}] Agent selected action: ${p(r.actions[r.actions.length-1],"[action]")}`)}};import U from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import R from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var Y=[400,401,403,404,405,406,407,408,409],b=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let r="default"in R?R.default:R;this.queue=new r({concurrency:this.maxConcurrency})}call(e,...r){return this.queue.add(()=>U(()=>e(...r).catch(t=>{throw t instanceof Error?t:new Error(t)}),{onFailedAttempt(t){if(t.message.startsWith("Cancel")||t.message.startsWith("TimeoutError")||t.message.startsWith("AbortError")||t?.code==="ECONNABORTED")throw t;let n=t?.response?.status;if(n&&Y.includes(+n))throw t},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,r,...t){return e.signal?Promise.race([this.call(r,...t),new Promise((n,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(r,...t)}fetch(...e){return this.call(()=>fetch(...e).then(r=>r.ok?r:Promise.reject(r)))}};var Q=()=>typeof window<"u"&&typeof window.document<"u",X=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Z=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),H=()=>typeof Deno<"u",ee=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!H(),te=()=>{let s;return Q()?s="browser":ee()?s="node":X()?s="webworker":Z()?s="jsdom":H()?s="deno":s="other",s},M;async function V(){return M===void 0&&(M={library:"langchain-js",runtime:te()}),M}function l(s){try{return typeof __Process$<"u"?__Process$.env?.[s]:void 0}catch{return}}var $=class extends d{constructor({exampleId:e,sessionName:r,callerParams:t,timeout:n}={}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:l("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"sessionName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:5e3});let i=l("LANGCHAIN_API_KEY");i&&(this.headers["x-api-key"]=i),this.sessionName=r??l("LANGCHAIN_SESSION"),this.exampleId=e,this.timeout=n??this.timeout,this.caller=new b(t??{maxRetries:2})}async _convertToCreate(e,r=void 0){let t=e.extra??{};return t.runtime=await V(),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.parent_run_id?void 0:r,extra:t,parent_run_id:e.parent_run_id,execution_order:e.execution_order,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs??{},session_name:this.sessionName,child_runs:[]}}async persistRun(e){}async _persistRunSingle(e){let r=await this._convertToCreate(e,this.exampleId),t=`${this.endpoint}/runs`,n=await this.caller.call(fetch,t,{method:"POST",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout)}),i=await n.text();if(!n.ok)throw new Error(`Failed to persist run: ${n.status} ${n.statusText} ${i}`)}async _updateRunSingle(e){let r={end_time:e.end_time,error:e.error,outputs:e.outputs,parent_run_id:e.parent_run_id,reference_example_id:e.reference_example_id},t=`${this.endpoint}/runs/${e.id}`,n=await this.caller.call(fetch,t,{method:"PATCH",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout)}),i=await n.text();if(!n.ok)throw new Error(`Failed to update run: ${n.status} ${n.statusText} ${i}`)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}};function T(s,e="Human",r="AI"){let t=[];for(let n of s){let i;if(n._getType()==="human")i=e;else if(n._getType()==="ai")i=r;else if(n._getType()==="system")i="System";else if(n._getType()==="generic")i=n.role;else throw new Error(`Got unsupported message type: ${n}`);t.push(`${i}: ${n.text}`)}return t.join(`
`)}var S=class extends d{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:l("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let e=l("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let r={start_time:Date.now(),name:e},t=await this.persistSession(r);return this.session=t,t}async loadSession(e){let r=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(r)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let r=this.session??await this.loadDefaultSession(),t=e.serialized,n;if(e.run_type==="llm"){let i=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(o=>T(o));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:t,type:e.run_type,session_id:r.id,prompts:i,response:e.outputs}}else if(e.run_type==="chain"){let i=await Promise.all(e.child_runs.map(o=>this.convertV2RunToRun(o)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:t,type:e.run_type,session_id:r.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:i.filter(o=>o.type==="llm"),child_chain_runs:i.filter(o=>o.type==="chain"),child_tool_runs:i.filter(o=>o.type==="tool")}}else if(e.run_type==="tool"){let i=await Promise.all(e.child_runs.map(o=>this.convertV2RunToRun(o)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:t,type:e.run_type,session_id:r.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(t),child_llm_runs:i.filter(o=>o.type==="llm"),child_chain_runs:i.filter(o=>o.type==="chain"),child_tool_runs:i.filter(o=>o.type==="tool")}}else throw new Error(`Unknown run type: ${e.run_type}`);return n}async persistRun(e){let r,t;e.run_type!==void 0?t=await this.convertV2RunToRun(e):t=e,t.type==="llm"?r=`${this.endpoint}/llm-runs`:t.type==="chain"?r=`${this.endpoint}/chain-runs`:r=`${this.endpoint}/tool-runs`;let n=await fetch(r,{method:"POST",headers:this.headers,body:JSON.stringify(t)});n.ok||console.error(`Failed to persist run: ${n.status} ${n.statusText}`)}async persistSession(e){let r=`${this.endpoint}/sessions`,t=await fetch(r,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return t.ok?{id:(await t.json()).id,...e}:(console.error(`Failed to persist session: ${t.status} ${t.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let r=await fetch(e,{method:"GET",headers:this.headers}),t;if(!r.ok)return console.error(`Failed to load session: ${r.status} ${r.statusText}`),t={id:1,start_time:Date.now()},this.session=t,t;let n=await r.json();return n.length===0?(t={id:1,start_time:Date.now()},this.session=t,t):([t]=n,this.session=t,t)}};async function D(s){let e=new S;return s?await e.loadSession(s):await e.loadDefaultSession(),e}async function G(){return new $}var k=class{setHandler(e){return this.setHandlers([e])}},x=class{constructor(e,r,t,n){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:n})}async handleText(e){await Promise.all(this.handlers.map(async r=>{try{await r.handleText?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleText: ${t}`)}}))}},L=class extends x{async handleLLMNewToken(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreLLM)try{await r.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${t}`)}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreLLM)try{await r.handleLLMError?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleLLMError: ${t}`)}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreLLM)try{await r.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleLLMEnd: ${t}`)}}))}},A=class extends x{getChild(){let e=new g(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreChain)try{await r.handleChainError?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleChainError: ${t}`)}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreChain)try{await r.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleChainEnd: ${t}`)}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreAgent)try{await r.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleAgentAction: ${t}`)}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreAgent)try{await r.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleAgentEnd: ${t}`)}}))}},j=class extends x{getChild(){let e=new g(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreAgent)try{await r.handleToolError?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleToolError: ${t}`)}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreAgent)try{await r.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleToolEnd: ${t}`)}}))}},g=class s extends k{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,r,t=w(),n=void 0,i=void 0){return await Promise.all(this.handlers.map(async a=>{if(!a.ignoreLLM)try{await a.handleLLMStart?.(e,r,t,this._parentRunId,i)}catch(o){console.error(`Error in handler ${a.constructor.name}, handleLLMStart: ${o}`)}})),new L(t,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChatModelStart(e,r,t=w(),n=void 0,i=void 0){let a;return await Promise.all(this.handlers.map(async o=>{if(!o.ignoreLLM)try{o.handleChatModelStart?await o.handleChatModelStart?.(e,r,t,this._parentRunId,i):o.handleLLMStart&&(a=r.map(u=>T(u)),await o.handleLLMStart?.(e,a,t,this._parentRunId,i))}catch(u){console.error(`Error in handler ${o.constructor.name}, handleLLMStart: ${u}`)}})),new L(t,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,r,t=w()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreChain)try{await n.handleChainStart?.(e,r,t,this._parentRunId)}catch(i){console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${i}`)}})),new A(t,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,r,t=w()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreAgent)try{await n.handleToolStart?.(e,r,t,this._parentRunId)}catch(i){console.error(`Error in handler ${n.constructor.name}, handleToolStart: ${i}`)}})),new j(t,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,r=!0){this.handlers.push(e),r&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(r=>r!==e),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==e)}setHandlers(e,r=!0){this.handlers=[],this.inheritableHandlers=[];for(let t of e)this.addHandler(t,r)}copy(e=[],r=!0){let t=new s(this._parentRunId);for(let n of this.handlers){let i=this.inheritableHandlers.includes(n);t.addHandler(n,i)}for(let n of e)t.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===n.name)||t.addHandler(n,r);return t}static fromHandlers(e){class r extends m{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:w()}),Object.assign(this,e)}}let t=new this;return t.addHandler(new r),t}static async configure(e,r,t){let n;(e||r)&&(Array.isArray(e)||!e?(n=new s,n.setHandlers(e?.map(q)??[],!0)):n=e,n=n.copy(Array.isArray(r)?r.map(q):r?.handlers,!1));let i=l("LANGCHAIN_VERBOSE")||t?.verbose,a=l("LANGCHAIN_TRACING_V2")??!1,o=a||(l("LANGCHAIN_TRACING")??!1);if(i||o){if(n||(n=new s),i&&!n.handlers.some(u=>u.name===_.prototype.name)){let u=new _;n.addHandler(u,!0)}if(o&&!n.handlers.some(u=>u.name==="langchain_tracer"))if(a)n.addHandler(await G(),!0);else{let u=l("LANGCHAIN_SESSION");n.addHandler(await D(u),!0)}}return n}};function q(s){return"name"in s?s:m.fromMethods(s)}import{Tiktoken as je,getEncodingNameForModel as Ie}from"/v135/js-tiktoken@1.0.8/denonext/lite.js";var ne=()=>!1,C=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??ne(),this.callbacks=e.callbacks}};var f=class extends C{constructor(e,r,t){if(arguments.length===1&&typeof e=="object"&&!("saveContext"in e)){let{memory:n,callbackManager:i,...a}=e;super({...a,callbacks:i??a.callbacks}),this.memory=n}else super({verbose:r,callbacks:t}),this.memory=e}serialize(){throw new Error("Method not implemented.")}async run(e,r){if(!(this.inputKeys.length<=1))throw new Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);let n=this.inputKeys.length?{[this.inputKeys[0]]:e}:{},i=await this.call(n,r),a=Object.keys(i);if(a.length===1)return i[a[0]];throw new Error("return values have multiple keys, `run` only supported when one key currently")}async call(e,r){let t={...e};if(this.memory!=null){let o=await this.memory.loadMemoryVariables(e);for(let[u,E]of Object.entries(o))t[u]=E}let i=await(await g.configure(r,this.callbacks,{verbose:this.verbose}))?.handleChainStart({name:this._chainType()},t),a;try{a=await this._call(t,i)}catch(o){throw await i?.handleChainError(o),o}return this.memory!=null&&await this.memory.saveContext(e,a),await i?.handleChainEnd(a),Object.defineProperty(a,N,{value:i?{runId:i?.runId}:void 0,configurable:!0}),a}async apply(e,r){return Promise.all(e.map(async(t,n)=>this.call(t,r?.[n])))}static async deserialize(e,r={}){switch(e._type){case"llm_chain":{let{LLMChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/llm_chain.js");return t.deserialize(e)}case"sequential_chain":{let{SequentialChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/sequential_chain.js");return t.deserialize(e)}case"simple_sequential_chain":{let{SimpleSequentialChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/sequential_chain.js");return t.deserialize(e)}case"stuff_documents_chain":{let{StuffDocumentsChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return t.deserialize(e)}case"map_reduce_documents_chain":{let{MapReduceDocumentsChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return t.deserialize(e)}case"refine_documents_chain":{let{RefineDocumentsChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return t.deserialize(e)}case"vector_db_qa":{let{VectorDBQAChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/vector_db_qa.js");return t.deserialize(e,r)}case"api_chain":{let{APIChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/api/api_chain.js");return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}};function I(s,e){let r=new Set;for(let t of e)s.has(t)&&r.add(t);return r}function F(s,e){let r=new Set(s);for(let t of e)r.add(t);return r}function O(s,e){let r=new Set(s);for(let t of e)r.delete(t);return r}function v(s){return Array.from(s).map(e=>`"${e}"`).join(", ")}var W=class s extends f{get inputKeys(){return this.inputVariables}get outputKeys(){return this.outputVariables}constructor(e){if(super(e),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.inputVariables=e.inputVariables,this.outputVariables=e.outputVariables??[],this.outputVariables.length>0&&e.returnAll)throw new Error("Either specify variables to return using `outputVariables` or use `returnAll` param. Cannot apply both conditions at the same time.");this.returnAll=e.returnAll??!1,this._validateChains()}_validateChains(){if(this.chains.length===0)throw new Error("Sequential chain must have at least one chain.");let e=this.memory?.memoryKeys??[],r=new Set(this.inputKeys),t=new Set(e),n=I(r,t);if(n.size>0)throw new Error(`The following keys: ${v(n)} are overlapping between memory and input keys of the chain variables. This can lead to unexpected behaviour. Please use input and memory keys that don't overlap.`);let i=F(r,t);for(let a of this.chains){let o=O(new Set(a.inputKeys),i);if(o.size>0)throw new Error(`Missing variables for chain "${a._chainType()}": ${v(o)}. Only got the following variables: ${v(i)}.`);let u=new Set(a.outputKeys),E=I(i,u);if(E.size>0)throw new Error(`The following output variables for chain "${a._chainType()}" are overlapping: ${v(E)}. This can lead to unexpected behaviour.`);for(let B of u)i.add(B)}if(this.outputVariables.length===0)if(this.returnAll){let a=O(i,r);this.outputVariables=Array.from(a)}else this.outputVariables=this.chains[this.chains.length-1].outputKeys;else{let a=O(new Set(this.outputVariables),new Set(i));if(a.size>0)throw new Error(`The following output variables were expected to be in the final chain output but were not found: ${v(a)}.`)}}async _call(e,r){let t={},n=e;for(let a of this.chains){t=await a.call(n,r?.getChild());for(let o of Object.keys(t))n[o]=t[o]}let i={};for(let a of this.outputVariables)i[a]=n[a];return i}_chainType(){return"sequential_chain"}static async deserialize(e){let r=[],t=e.input_variables,n=e.output_variables,i=e.chains;for(let a of i){let o=await f.deserialize(a);r.push(o)}return new s({chains:r,inputVariables:t,outputVariables:n})}serialize(){let e=[];for(let r of this.chains)e.push(r.serialize());return{_type:this._chainType(),input_variables:this.inputVariables,output_variables:this.outputVariables,chains:e}}},J=class s extends f{get inputKeys(){return[this.inputKey]}get outputKeys(){return[this.outputKey]}constructor(e){super(e.memory,e.verbose,e.callbacks??e.callbackManager),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output"}),Object.defineProperty(this,"trimOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.trimOutputs=e.trimOutputs??!1,this._validateChains()}_validateChains(){for(let e of this.chains){if(e.inputKeys.length!==1)throw new Error(`Chains used in SimpleSequentialChain should all have one input, got ${e.inputKeys.length} for ${e._chainType()}.`);if(e.outputKeys.length!==1)throw new Error(`Chains used in SimpleSequentialChain should all have one output, got ${e.outputKeys.length} for ${e._chainType()}.`)}}async _call(e,r){let t=e[this.inputKey];for(let n of this.chains)t=await n.run(t,r?.getChild()),this.trimOutputs&&(t=t.trim()),await r?.handleText(t);return{[this.outputKey]:t}}_chainType(){return"simple_sequential_chain"}static async deserialize(e){let r=[],t=e.chains;for(let n of t){let i=await f.deserialize(n);r.push(i)}return new s({chains:r})}serialize(){let e=[];for(let r of this.chains)e.push(r.serialize());return{_type:this._chainType(),chains:e}}};export{W as SequentialChain,J as SimpleSequentialChain};
//# sourceMappingURL=sequential_chain.js.map