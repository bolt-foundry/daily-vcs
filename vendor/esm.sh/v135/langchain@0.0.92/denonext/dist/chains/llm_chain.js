/* esm.sh - esbuild bundle(langchain@0.0.92/dist/chains/llm_chain) denonext production */
import __Process$ from "node:process";
var N="__run";import{v4 as b}from"/v135/uuid@9.0.1/denonext/uuid.mjs";import*as H from"/v135/uuid@9.0.1/denonext/uuid.mjs";var C=class{},f=class a extends C{constructor(e){super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class r extends a{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:H.v4()}),Object.assign(this,e)}}return new r}};import z from"/v135/ansi-styles@5.2.0/denonext/ansi-styles.mjs";var h=class extends f{constructor(){super(),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,r){e.child_runs.push(r)}_startTrace(e){if(e.parent_run_id!==void 0){let r=this.runMap.get(e.parent_run_id);r&&this._addChildRun(r,e)}this.runMap.set(e.id,e)}async _endTrace(e){let r=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);r?r.child_execution_order=Math.max(r.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id)}_getExecutionOrder(e){let r=e!==void 0&&this.runMap.get(e);return r?r.child_execution_order+1:1}async handleLLMStart(e,r,t,n,i){let o=this._getExecutionOrder(n),s={id:t,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{prompts:r},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:i};this._startTrace(s),await this.onLLMStart?.(s)}async handleChatModelStart(e,r,t,n,i){let o=this._getExecutionOrder(n),s={id:t,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{messages:r},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:i};this._startTrace(s),await this.onLLMStart?.(s)}async handleLLMEnd(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="llm")throw new Error("No LLM run to end.");t.end_time=Date.now(),t.outputs=e,await this.onLLMEnd?.(t),await this._endTrace(t)}async handleLLMError(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="llm")throw new Error("No LLM run to end.");t.end_time=Date.now(),t.error=e.message,await this.onLLMError?.(t),await this._endTrace(t)}async handleChainStart(e,r,t,n){let i=this._getExecutionOrder(n),o={id:t,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:r,execution_order:i,child_execution_order:i,run_type:"chain",child_runs:[]};this._startTrace(o),await this.onChainStart?.(o)}async handleChainEnd(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="chain")throw new Error("No chain run to end.");t.end_time=Date.now(),t.outputs=e,await this.onChainEnd?.(t),await this._endTrace(t)}async handleChainError(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="chain")throw new Error("No chain run to end.");t.end_time=Date.now(),t.error=e.message,await this.onChainError?.(t),await this._endTrace(t)}async handleToolStart(e,r,t,n){let i=this._getExecutionOrder(n),o={id:t,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{input:r},execution_order:i,child_execution_order:i,run_type:"tool",child_runs:[]};this._startTrace(o),await this.onToolStart?.(o)}async handleToolEnd(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="tool")throw new Error("No tool run to end");t.end_time=Date.now(),t.outputs={output:e},await this.onToolEnd?.(t),await this._endTrace(t)}async handleToolError(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="tool")throw new Error("No tool run to end");t.end_time=Date.now(),t.error=e.message,await this.onToolError?.(t),await this._endTrace(t)}async handleAgentAction(e,r){let t=this.runMap.get(r);if(!t||t?.run_type!=="chain")return;let n=t;n.actions=n.actions||[],n.actions.push(e),await this.onAgentAction?.(t)}};function l(a,e){return`${a.open}${e}${a.close}`}function p(a,e){try{return JSON.stringify(a,null,2)}catch{return e}}function y(a){if(!a.end_time)return"";let e=a.end_time-a.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:d}=z,_=class extends h{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let r=[],t=e;for(;t.parent_run_id;){let n=this.runMap.get(t.parent_run_id);if(n)r.push(n),t=n;else break}return r}getBreadcrumbs(e){let t=[...this.getParents(e).reverse(),e].map((n,i,o)=>{let s=`${n.execution_order}:${n.run_type}:${n.name}`;return i===o.length-1?l(z.bold,s):s}).join(" > ");return l(d.grey,t)}onChainStart(e){let r=this.getBreadcrumbs(e);console.log(`${l(d.green,"[chain/start]")} [${r}] Entering Chain run with input: ${p(e.inputs,"[inputs]")}`)}onChainEnd(e){let r=this.getBreadcrumbs(e);console.log(`${l(d.cyan,"[chain/end]")} [${r}] [${y(e)}] Exiting Chain run with output: ${p(e.outputs,"[outputs]")}`)}onChainError(e){let r=this.getBreadcrumbs(e);console.log(`${l(d.red,"[chain/error]")} [${r}] [${y(e)}] Chain run errored with error: ${p(e.error,"[error]")}`)}onLLMStart(e){let r=this.getBreadcrumbs(e),t="prompts"in e.inputs?{prompts:e.inputs.prompts.map(n=>n.trim())}:e.inputs;console.log(`${l(d.green,"[llm/start]")} [${r}] Entering LLM run with input: ${p(t,"[inputs]")}`)}onLLMEnd(e){let r=this.getBreadcrumbs(e);console.log(`${l(d.cyan,"[llm/end]")} [${r}] [${y(e)}] Exiting LLM run with output: ${p(e.outputs,"[response]")}`)}onLLMError(e){let r=this.getBreadcrumbs(e);console.log(`${l(d.red,"[llm/error]")} [${r}] [${y(e)}] LLM run errored with error: ${p(e.error,"[error]")}`)}onToolStart(e){let r=this.getBreadcrumbs(e);console.log(`${l(d.green,"[tool/start]")} [${r}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let r=this.getBreadcrumbs(e);console.log(`${l(d.cyan,"[tool/end]")} [${r}] [${y(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let r=this.getBreadcrumbs(e);console.log(`${l(d.red,"[tool/error]")} [${r}] [${y(e)}] Tool run errored with error: ${p(e.error,"[error]")}`)}onAgentAction(e){let r=e,t=this.getBreadcrumbs(e);console.log(`${l(d.blue,"[agent/action]")} [${t}] Agent selected action: ${p(r.actions[r.actions.length-1],"[action]")}`)}};import B from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import M from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var U=[400,401,403,404,405,406,407,408,409],m=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let r="default"in M?M.default:M;this.queue=new r({concurrency:this.maxConcurrency})}call(e,...r){return this.queue.add(()=>B(()=>e(...r).catch(t=>{throw t instanceof Error?t:new Error(t)}),{onFailedAttempt(t){if(t.message.startsWith("Cancel")||t.message.startsWith("TimeoutError")||t.message.startsWith("AbortError")||t?.code==="ECONNABORTED")throw t;let n=t?.response?.status;if(n&&U.includes(+n))throw t},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,r,...t){return e.signal?Promise.race([this.call(r,...t),new Promise((n,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(r,...t)}fetch(...e){return this.call(()=>fetch(...e).then(r=>r.ok?r:Promise.reject(r)))}};var Y=()=>typeof window<"u"&&typeof window.document<"u",Q=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",X=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),V=()=>typeof Deno<"u",Z=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!V(),ee=()=>{let a;return Y()?a="browser":Z()?a="node":Q()?a="webworker":X()?a="jsdom":V()?a="deno":a="other",a},R;async function D(){return R===void 0&&(R={library:"langchain-js",runtime:ee()}),R}function c(a){try{return typeof __Process$<"u"?__Process$.env?.[a]:void 0}catch{return}}var v=class extends h{constructor({exampleId:e,sessionName:r,callerParams:t,timeout:n}={}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:c("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"sessionName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:5e3});let i=c("LANGCHAIN_API_KEY");i&&(this.headers["x-api-key"]=i),this.sessionName=r??c("LANGCHAIN_SESSION"),this.exampleId=e,this.timeout=n??this.timeout,this.caller=new m(t??{maxRetries:2})}async _convertToCreate(e,r=void 0){let t=e.extra??{};return t.runtime=await D(),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.parent_run_id?void 0:r,extra:t,parent_run_id:e.parent_run_id,execution_order:e.execution_order,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs??{},session_name:this.sessionName,child_runs:[]}}async persistRun(e){}async _persistRunSingle(e){let r=await this._convertToCreate(e,this.exampleId),t=`${this.endpoint}/runs`,n=await this.caller.call(fetch,t,{method:"POST",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout)}),i=await n.text();if(!n.ok)throw new Error(`Failed to persist run: ${n.status} ${n.statusText} ${i}`)}async _updateRunSingle(e){let r={end_time:e.end_time,error:e.error,outputs:e.outputs,parent_run_id:e.parent_run_id,reference_example_id:e.reference_example_id},t=`${this.endpoint}/runs/${e.id}`,n=await this.caller.call(fetch,t,{method:"PATCH",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout)}),i=await n.text();if(!n.ok)throw new Error(`Failed to update run: ${n.status} ${n.statusText} ${i}`)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}};function E(a,e="Human",r="AI"){let t=[];for(let n of a){let i;if(n._getType()==="human")i=e;else if(n._getType()==="ai")i=r;else if(n._getType()==="system")i="System";else if(n._getType()==="generic")i=n.role;else throw new Error(`Got unsupported message type: ${n}`);t.push(`${i}: ${n.text}`)}return t.join(`
`)}var T=class extends h{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:c("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let e=c("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let r={start_time:Date.now(),name:e},t=await this.persistSession(r);return this.session=t,t}async loadSession(e){let r=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(r)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let r=this.session??await this.loadDefaultSession(),t=e.serialized,n;if(e.run_type==="llm"){let i=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(s=>E(s));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:t,type:e.run_type,session_id:r.id,prompts:i,response:e.outputs}}else if(e.run_type==="chain"){let i=await Promise.all(e.child_runs.map(s=>this.convertV2RunToRun(s)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:t,type:e.run_type,session_id:r.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:i.filter(s=>s.type==="llm"),child_chain_runs:i.filter(s=>s.type==="chain"),child_tool_runs:i.filter(s=>s.type==="tool")}}else if(e.run_type==="tool"){let i=await Promise.all(e.child_runs.map(s=>this.convertV2RunToRun(s)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:t,type:e.run_type,session_id:r.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(t),child_llm_runs:i.filter(s=>s.type==="llm"),child_chain_runs:i.filter(s=>s.type==="chain"),child_tool_runs:i.filter(s=>s.type==="tool")}}else throw new Error(`Unknown run type: ${e.run_type}`);return n}async persistRun(e){let r,t;e.run_type!==void 0?t=await this.convertV2RunToRun(e):t=e,t.type==="llm"?r=`${this.endpoint}/llm-runs`:t.type==="chain"?r=`${this.endpoint}/chain-runs`:r=`${this.endpoint}/tool-runs`;let n=await fetch(r,{method:"POST",headers:this.headers,body:JSON.stringify(t)});n.ok||console.error(`Failed to persist run: ${n.status} ${n.statusText}`)}async persistSession(e){let r=`${this.endpoint}/sessions`,t=await fetch(r,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return t.ok?{id:(await t.json()).id,...e}:(console.error(`Failed to persist session: ${t.status} ${t.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let r=await fetch(e,{method:"GET",headers:this.headers}),t;if(!r.ok)return console.error(`Failed to load session: ${r.status} ${r.statusText}`),t={id:1,start_time:Date.now()},this.session=t,t;let n=await r.json();return n.length===0?(t={id:1,start_time:Date.now()},this.session=t,t):([t]=n,this.session=t,t)}};async function K(a){let e=new T;return a?await e.loadSession(a):await e.loadDefaultSession(),e}async function F(){return new v}var j=class{setHandler(e){return this.setHandlers([e])}},w=class{constructor(e,r,t,n){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:n})}async handleText(e){await Promise.all(this.handlers.map(async r=>{try{await r.handleText?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleText: ${t}`)}}))}},$=class extends w{async handleLLMNewToken(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreLLM)try{await r.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${t}`)}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreLLM)try{await r.handleLLMError?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleLLMError: ${t}`)}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreLLM)try{await r.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleLLMEnd: ${t}`)}}))}},k=class extends w{getChild(){let e=new g(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreChain)try{await r.handleChainError?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleChainError: ${t}`)}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreChain)try{await r.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleChainEnd: ${t}`)}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreAgent)try{await r.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleAgentAction: ${t}`)}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreAgent)try{await r.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleAgentEnd: ${t}`)}}))}},A=class extends w{getChild(){let e=new g(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreAgent)try{await r.handleToolError?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleToolError: ${t}`)}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async r=>{if(!r.ignoreAgent)try{await r.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(t){console.error(`Error in handler ${r.constructor.name}, handleToolEnd: ${t}`)}}))}},g=class a extends j{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,r,t=b(),n=void 0,i=void 0){return await Promise.all(this.handlers.map(async o=>{if(!o.ignoreLLM)try{await o.handleLLMStart?.(e,r,t,this._parentRunId,i)}catch(s){console.error(`Error in handler ${o.constructor.name}, handleLLMStart: ${s}`)}})),new $(t,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChatModelStart(e,r,t=b(),n=void 0,i=void 0){let o;return await Promise.all(this.handlers.map(async s=>{if(!s.ignoreLLM)try{s.handleChatModelStart?await s.handleChatModelStart?.(e,r,t,this._parentRunId,i):s.handleLLMStart&&(o=r.map(u=>E(u)),await s.handleLLMStart?.(e,o,t,this._parentRunId,i))}catch(u){console.error(`Error in handler ${s.constructor.name}, handleLLMStart: ${u}`)}})),new $(t,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,r,t=b()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreChain)try{await n.handleChainStart?.(e,r,t,this._parentRunId)}catch(i){console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${i}`)}})),new k(t,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,r,t=b()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreAgent)try{await n.handleToolStart?.(e,r,t,this._parentRunId)}catch(i){console.error(`Error in handler ${n.constructor.name}, handleToolStart: ${i}`)}})),new A(t,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,r=!0){this.handlers.push(e),r&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(r=>r!==e),this.inheritableHandlers=this.inheritableHandlers.filter(r=>r!==e)}setHandlers(e,r=!0){this.handlers=[],this.inheritableHandlers=[];for(let t of e)this.addHandler(t,r)}copy(e=[],r=!0){let t=new a(this._parentRunId);for(let n of this.handlers){let i=this.inheritableHandlers.includes(n);t.addHandler(n,i)}for(let n of e)t.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===n.name)||t.addHandler(n,r);return t}static fromHandlers(e){class r extends f{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:b()}),Object.assign(this,e)}}let t=new this;return t.addHandler(new r),t}static async configure(e,r,t){let n;(e||r)&&(Array.isArray(e)||!e?(n=new a,n.setHandlers(e?.map(G)??[],!0)):n=e,n=n.copy(Array.isArray(r)?r.map(G):r?.handlers,!1));let i=c("LANGCHAIN_VERBOSE")||t?.verbose,o=c("LANGCHAIN_TRACING_V2")??!1,s=o||(c("LANGCHAIN_TRACING")??!1);if(i||s){if(n||(n=new a),i&&!n.handlers.some(u=>u.name===_.prototype.name)){let u=new _;n.addHandler(u,!0)}if(s&&!n.handlers.some(u=>u.name==="langchain_tracer"))if(o)n.addHandler(await F(),!0);else{let u=c("LANGCHAIN_SESSION");n.addHandler(await K(u),!0)}}return n}};function G(a){return"name"in a?a:f.fromMethods(a)}import{Tiktoken as te,getEncodingNameForModel as re}from"/v135/js-tiktoken@1.0.8/denonext/lite.js";var P={},ne=new m({});async function ie(a,e){return a in P||(P[a]=ne.fetch(`https://tiktoken.pages.dev/js/${a}.json`,{signal:e?.signal}).then(r=>r.json()).catch(r=>{throw delete P[a],r})),new te(await P[a],e?.extendedSpecialTokens)}async function I(a,e){return ie(re(a),e)}var W=a=>a.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":a.startsWith("gpt-4-32k-")?"gpt-4-32k":a.startsWith("gpt-4-")?"gpt-4":a;var ae=()=>!1,x=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??ae(),this.callbacks=e.callbacks}},L=class extends x{get callKeys(){return["stop","timeout","signal"]}constructor(e){super({verbose:e.verbose,callbacks:e.callbacks??e.callbackManager}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new m(e??{})}async getNumTokens(e){let r=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await I("modelName"in this?W(this.modelName):"gpt2")}catch(t){console.warn("Failed to calculate number of tokens, falling back to approximate count",t)}return this._encoding&&(r=this._encoding.encode(e).length),r}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:r,_model:t,...n}=e;if(t&&t!=="base_chat_model")throw new Error(`Cannot load LLM with model ${t}`);let i={openai:(await import("/v135/langchain@0.0.92/denonext/dist/chat_models/openai.js")).ChatOpenAI}[r];if(i===void 0)throw new Error(`Cannot load  LLM with type ${r}`);return new i(n)}};var S=class extends x{constructor(e,r,t){if(arguments.length===1&&typeof e=="object"&&!("saveContext"in e)){let{memory:n,callbackManager:i,...o}=e;super({...o,callbacks:i??o.callbacks}),this.memory=n}else super({verbose:r,callbacks:t}),this.memory=e}serialize(){throw new Error("Method not implemented.")}async run(e,r){if(!(this.inputKeys.length<=1))throw new Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);let n=this.inputKeys.length?{[this.inputKeys[0]]:e}:{},i=await this.call(n,r),o=Object.keys(i);if(o.length===1)return i[o[0]];throw new Error("return values have multiple keys, `run` only supported when one key currently")}async call(e,r){let t={...e};if(this.memory!=null){let s=await this.memory.loadMemoryVariables(e);for(let[u,q]of Object.entries(s))t[u]=q}let i=await(await g.configure(r,this.callbacks,{verbose:this.verbose}))?.handleChainStart({name:this._chainType()},t),o;try{o=await this._call(t,i)}catch(s){throw await i?.handleChainError(s),s}return this.memory!=null&&await this.memory.saveContext(e,o),await i?.handleChainEnd(o),Object.defineProperty(o,N,{value:i?{runId:i?.runId}:void 0,configurable:!0}),o}async apply(e,r){return Promise.all(e.map(async(t,n)=>this.call(t,r?.[n])))}static async deserialize(e,r={}){switch(e._type){case"llm_chain":{let{LLMChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/llm_chain.js");return t.deserialize(e)}case"sequential_chain":{let{SequentialChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/sequential_chain.js");return t.deserialize(e)}case"simple_sequential_chain":{let{SimpleSequentialChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/sequential_chain.js");return t.deserialize(e)}case"stuff_documents_chain":{let{StuffDocumentsChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return t.deserialize(e)}case"map_reduce_documents_chain":{let{MapReduceDocumentsChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return t.deserialize(e)}case"refine_documents_chain":{let{RefineDocumentsChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return t.deserialize(e)}case"vector_db_qa":{let{VectorDBQAChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/vector_db_qa.js");return t.deserialize(e,r)}case"api_chain":{let{APIChain:t}=await import("/v135/langchain@0.0.92/denonext/dist/chains/api/api_chain.js");return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}};var O=class{constructor(e){Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:r}=e;if(r.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let r=this.partialVariables??{},t={};for(let[i,o]of Object.entries(r))typeof o=="string"?t[i]=o:t[i]=await o();return{...t,...e}}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:r}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/prompt.js");return r.deserialize(e)}case void 0:{let{PromptTemplate:r}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/prompt.js");return r.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:r}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/few_shot.js");return r.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}};var J=class a extends S{get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(e){if(super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"text"}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,this.llm=e.llm,this.outputKey=e.outputKey??this.outputKey,this.outputParser=e.outputParser??this.outputParser,this.prompt.outputParser){if(this.outputParser)throw new Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}async _getFinalOutput(e,r,t){let n=e[0].text,i;return this.outputParser?i=await this.outputParser.parseWithPrompt(n,r,t?.getChild()):i=n,i}call(e,r){return super.call(e,r)}async _call(e,r){let t={...e},n={};for(let s of this.llm.callKeys)s in e&&(n[s]=e[s],delete t[s]);let i=await this.prompt.formatPromptValue(t),{generations:o}=await this.llm.generatePrompt([i],n,r?.getChild());return{[this.outputKey]:await this._getFinalOutput(o[0],i,r)}}async predict(e,r){return(await this.call(e,r))[this.outputKey]}_chainType(){return"llm_chain"}static async deserialize(e){let{llm:r,prompt:t}=e;if(!r)throw new Error("LLMChain must have llm");if(!t)throw new Error("LLMChain must have prompt");return new a({llm:await L.deserialize(r),prompt:await O.deserialize(t)})}serialize(){return{_type:this._chainType(),llm:this.llm.serialize(),prompt:this.prompt.serialize()}}};export{J as LLMChain};
//# sourceMappingURL=llm_chain.js.map