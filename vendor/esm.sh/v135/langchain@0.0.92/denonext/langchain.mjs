/* esm.sh - esbuild bundle(langchain@0.0.92) denonext production */
import __Process$ from "node:process";
var Q="__run",Y=class{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e}toJSON(){return{type:this._getType(),data:{content:this.text,role:"role"in this?this.role:void 0}}}},k=class extends Y{_getType(){return"human"}},R=class extends Y{_getType(){return"ai"}};var $=class{};var Z=class{};var X=class extends ${constructor(e){super(),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new k(this.value)]}},_=class{constructor(e){Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},r={};for(let[i,o]of Object.entries(t))typeof o=="string"?r[i]=o:r[i]=await o();return{...r,...e}}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/prompt.js");return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/prompt.js");return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/few_shot.js");return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}},A=class extends _{async formatPromptValue(e){let t=await this.format(e);return new X(t)}};var je=n=>{let e=n.split(""),t=[],r=(i,o)=>{for(let s=o;s<e.length;s+=1)if(i.includes(e[s]))return s;return-1},a=0;for(;a<e.length;)if(e[a]==="{"&&a+1<e.length&&e[a+1]==="{")t.push({type:"literal",text:"{"}),a+=2;else if(e[a]==="}"&&a+1<e.length&&e[a+1]==="}")t.push({type:"literal",text:"}"}),a+=2;else if(e[a]==="{"){let i=r("}",a);if(i<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(a+1,i).join("")}),a=i+1}else{if(e[a]==="}")throw new Error("Single '}' in template.");{let i=r("{}",a),o=(i<0?e.slice(a):e.slice(a,i)).join("");t.push({type:"literal",text:o}),a=i<0?e.length:i}}return t},Be=(n,e)=>je(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`Missing value for input ${r.name}`)}return t+r.text},""),he={"f-string":Be,jinja2:(n,e)=>""},Ue={"f-string":je,jinja2:n=>[]},L=(n,e,t)=>he[e](n,t),de=(n,e)=>Ue[e](n),z=(n,e,t)=>{if(!(e in he)){let r=Object.keys(he);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{let r=t.reduce((a,i)=>(a[i]="foo",a),{});L(n,e,r)}catch{throw new Error("Invalid prompt schema.")}};var E=class n extends A{constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),z(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return L(this.template,this.templateFormat,t)}static fromExamples(e,t,r,a=`

`,i=""){let o=[i,...e,t].join(a);return new n({inputVariables:r,template:o})}static fromTemplate(e,{templateFormat:t="f-string",...r}={}){let a=new Set;return de(e,t).forEach(i=>{i.type==="variable"&&a.add(i.name)}),new n({inputVariables:[...a],templateFormat:t,template:e,...r})}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new n(t)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new n({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}};var ee=class n extends A{constructor(e){if(super(e),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),z(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new n(t)}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),a=await Promise.all(r.map(o=>this.examplePrompt.format(o))),i=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return L(i,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let r=await E.deserialize(t),a;if(Array.isArray(e.examples))a=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new n({inputVariables:e.input_variables,examplePrompt:r,examples:a,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}};import{v4 as D}from"/v135/uuid@9.0.1/denonext/uuid.mjs";import*as Le from"/v135/uuid@9.0.1/denonext/uuid.mjs";var fe=class{},T=class n extends fe{constructor(e){super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Le.v4()}),Object.assign(this,e)}}return new t}};import Se from"/v135/ansi-styles@5.2.0/denonext/ansi-styles.mjs";var x=class extends T{constructor(){super(),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}_startTrace(e){if(e.parent_run_id!==void 0){let t=this.runMap.get(e.parent_run_id);t&&this._addChildRun(t,e)}this.runMap.set(e.id,e)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,i){let o=this._getExecutionOrder(a),s={id:r,name:e.name,parent_run_id:a,start_time:Date.now(),serialized:e,inputs:{prompts:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:i};this._startTrace(s),await this.onLLMStart?.(s)}async handleChatModelStart(e,t,r,a,i){let o=this._getExecutionOrder(a),s={id:r,name:e.name,parent_run_id:a,start_time:Date.now(),serialized:e,inputs:{messages:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:i};this._startTrace(s),await this.onLLMStart?.(s)}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.outputs=e,await this.onLLMEnd?.(r),await this._endTrace(r)}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.error=e.message,await this.onLLMError?.(r),await this._endTrace(r)}async handleChainStart(e,t,r,a){let i=this._getExecutionOrder(a),o={id:r,name:e.name,parent_run_id:a,start_time:Date.now(),serialized:e,inputs:t,execution_order:i,child_execution_order:i,run_type:"chain",child_runs:[]};this._startTrace(o),await this.onChainStart?.(o)}async handleChainEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.outputs=e,await this.onChainEnd?.(r),await this._endTrace(r)}async handleChainError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.error=e.message,await this.onChainError?.(r),await this._endTrace(r)}async handleToolStart(e,t,r,a){let i=this._getExecutionOrder(a),o={id:r,name:e.name,parent_run_id:a,start_time:Date.now(),serialized:e,inputs:{input:t},execution_order:i,child_execution_order:i,run_type:"tool",child_runs:[]};this._startTrace(o),await this.onToolStart?.(o)}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.outputs={output:e},await this.onToolEnd?.(r),await this._endTrace(r)}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.error=e.message,await this.onToolError?.(r),await this._endTrace(r)}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),await this.onAgentAction?.(r)}};function b(n,e){return`${n.open}${e}${n.close}`}function P(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function S(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:g}=Se,V=class extends x{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,i,o)=>{let s=`${a.execution_order}:${a.run_type}:${a.name}`;return i===o.length-1?b(Se.bold,s):s}).join(" > ");return b(g.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${b(g.green,"[chain/start]")} [${t}] Entering Chain run with input: ${P(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${b(g.cyan,"[chain/end]")} [${t}] [${S(e)}] Exiting Chain run with output: ${P(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${b(g.red,"[chain/error]")} [${t}] [${S(e)}] Chain run errored with error: ${P(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${b(g.green,"[llm/start]")} [${t}] Entering LLM run with input: ${P(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${b(g.cyan,"[llm/end]")} [${t}] [${S(e)}] Exiting LLM run with output: ${P(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${b(g.red,"[llm/error]")} [${t}] [${S(e)}] LLM run errored with error: ${P(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${b(g.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${b(g.cyan,"[tool/end]")} [${t}] [${S(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${b(g.red,"[tool/error]")} [${t}] [${S(e)}] Tool run errored with error: ${P(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${b(g.blue,"[agent/action]")} [${r}] Agent selected action: ${P(t.actions[t.actions.length-1],"[action]")}`)}};import Fe from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import be from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var We=[400,401,403,404,405,406,407,408,409],v=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let t="default"in be?be.default:be;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Fe(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let a=r?.response?.status;if(a&&We.includes(+a))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var Je=()=>typeof window<"u"&&typeof window.document<"u",Ge=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Ye=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Ne=()=>typeof Deno<"u",K=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!Ne(),Ze=()=>{let n;return Je()?n="browser":K()?n="node":Ge()?n="webworker":Ye()?n="jsdom":Ne()?n="deno":n="other",n},ye;async function Me(){return ye===void 0&&(ye={library:"langchain-js",runtime:Ze()}),ye}function c(n){try{return typeof __Process$<"u"?__Process$.env?.[n]:void 0}catch{return}}var te=class extends x{constructor({exampleId:e,sessionName:t,callerParams:r,timeout:a}={}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:c("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"sessionName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:5e3});let i=c("LANGCHAIN_API_KEY");i&&(this.headers["x-api-key"]=i),this.sessionName=t??c("LANGCHAIN_SESSION"),this.exampleId=e,this.timeout=a??this.timeout,this.caller=new v(r??{maxRetries:2})}async _convertToCreate(e,t=void 0){let r=e.extra??{};return r.runtime=await Me(),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.parent_run_id?void 0:t,extra:r,parent_run_id:e.parent_run_id,execution_order:e.execution_order,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs??{},session_name:this.sessionName,child_runs:[]}}async persistRun(e){}async _persistRunSingle(e){let t=await this._convertToCreate(e,this.exampleId),r=`${this.endpoint}/runs`,a=await this.caller.call(fetch,r,{method:"POST",headers:this.headers,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout)}),i=await a.text();if(!a.ok)throw new Error(`Failed to persist run: ${a.status} ${a.statusText} ${i}`)}async _updateRunSingle(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,parent_run_id:e.parent_run_id,reference_example_id:e.reference_example_id},r=`${this.endpoint}/runs/${e.id}`,a=await this.caller.call(fetch,r,{method:"PATCH",headers:this.headers,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout)}),i=await a.text();if(!a.ok)throw new Error(`Failed to update run: ${a.status} ${a.statusText} ${i}`)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}};function N(n,e="Human",t="AI"){let r=[];for(let a of n){let i;if(a._getType()==="human")i=e;else if(a._getType()==="ai")i=t;else if(a._getType()==="system")i="System";else if(a._getType()==="generic")i=a.role;else throw new Error(`Got unsupported message type: ${a}`);r.push(`${i}: ${a.text}`)}return r.join(`
`)}var re=class extends x{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:c("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let e=c("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let t=this.session??await this.loadDefaultSession(),r=e.serialized,a;if(e.run_type==="llm"){let i=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(s=>N(s));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,prompts:i,response:e.outputs}}else if(e.run_type==="chain"){let i=await Promise.all(e.child_runs.map(s=>this.convertV2RunToRun(s)));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:i.filter(s=>s.type==="llm"),child_chain_runs:i.filter(s=>s.type==="chain"),child_tool_runs:i.filter(s=>s.type==="tool")}}else if(e.run_type==="tool"){let i=await Promise.all(e.child_runs.map(s=>this.convertV2RunToRun(s)));a={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(r),child_llm_runs:i.filter(s=>s.type==="llm"),child_chain_runs:i.filter(s=>s.type==="chain"),child_tool_runs:i.filter(s=>s.type==="tool")}}else throw new Error(`Unknown run type: ${e.run_type}`);return a}async persistRun(e){let t,r;e.run_type!==void 0?r=await this.convertV2RunToRun(e):r=e,r.type==="llm"?t=`${this.endpoint}/llm-runs`:r.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`;let a=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});a.ok||console.error(`Failed to persist run: ${a.status} ${a.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;let a=await t.json();return a.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=a,this.session=r,r)}};async function Ce(n){let e=new re;return n?await e.loadSession(n):await e.loadDefaultSession(),e}async function ke(){return new te}var ge=class{setHandler(e){return this.setHandlers([e])}},H=class{constructor(e,t,r,a){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:a})}async handleText(e){await Promise.all(this.handlers.map(async t=>{try{await t.handleText?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`)}}))}},ne=class extends H{async handleLLMNewToken(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${r}`)}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`)}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`)}}))}},we=class extends H{getChild(){let e=new O(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${r}`)}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${r}`)}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`)}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`)}}))}},_e=class extends H{getChild(){let e=new O(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`)}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`)}}))}},O=class n extends ge{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=D(),a=void 0,i=void 0){return await Promise.all(this.handlers.map(async o=>{if(!o.ignoreLLM)try{await o.handleLLMStart?.(e,t,r,this._parentRunId,i)}catch(s){console.error(`Error in handler ${o.constructor.name}, handleLLMStart: ${s}`)}})),new ne(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChatModelStart(e,t,r=D(),a=void 0,i=void 0){let o;return await Promise.all(this.handlers.map(async s=>{if(!s.ignoreLLM)try{s.handleChatModelStart?await s.handleChatModelStart?.(e,t,r,this._parentRunId,i):s.handleLLMStart&&(o=t.map(u=>N(u)),await s.handleLLMStart?.(e,o,r,this._parentRunId,i))}catch(u){console.error(`Error in handler ${s.constructor.name}, handleLLMStart: ${u}`)}})),new ne(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,t,r=D()){return await Promise.all(this.handlers.map(async a=>{if(!a.ignoreChain)try{await a.handleChainStart?.(e,t,r,this._parentRunId)}catch(i){console.error(`Error in handler ${a.constructor.name}, handleChainStart: ${i}`)}})),new we(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,t,r=D()){return await Promise.all(this.handlers.map(async a=>{if(!a.ignoreAgent)try{await a.handleToolStart?.(e,t,r,this._parentRunId)}catch(i){console.error(`Error in handler ${a.constructor.name}, handleToolStart: ${i}`)}})),new _e(r,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let i=this.inheritableHandlers.includes(a);r.addHandler(a,i)}for(let a of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends T{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:D()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r){let a;(e||t)&&(Array.isArray(e)||!e?(a=new n,a.setHandlers(e?.map(Re)??[],!0)):a=e,a=a.copy(Array.isArray(t)?t.map(Re):t?.handlers,!1));let i=c("LANGCHAIN_VERBOSE")||r?.verbose,o=c("LANGCHAIN_TRACING_V2")??!1,s=o||(c("LANGCHAIN_TRACING")??!1);if(i||s){if(a||(a=new n),i&&!a.handlers.some(u=>u.name===V.prototype.name)){let u=new V;a.addHandler(u,!0)}if(s&&!a.handlers.some(u=>u.name==="langchain_tracer"))if(o)a.addHandler(await ke(),!0);else{let u=c("LANGCHAIN_SESSION");a.addHandler(await Ce(u),!0)}}return a}};function Re(n){return"name"in n?n:T.fromMethods(n)}import{Tiktoken as Qe,getEncodingNameForModel as Xe}from"/v135/js-tiktoken@1.0.8/denonext/lite.js";var ae={},et=new v({});async function tt(n,e){return n in ae||(ae[n]=et.fetch(`https://tiktoken.pages.dev/js/${n}.json`,{signal:e?.signal}).then(t=>t.json()).catch(t=>{throw delete ae[n],t})),new Qe(await ae[n],e?.extendedSpecialTokens)}async function ie(n,e){return tt(Xe(n),e)}var xe=n=>n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k-")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n;var rt=n=>{switch(xe(n)){case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":return 4097;case"text-curie-001":return 2048;case"text-babbage-001":return 2048;case"text-ada-001":return 2048;case"code-davinci-002":return 8e3;case"code-cushman-001":return 2048;default:return 4097}},Pe=async({prompt:n,modelName:e})=>{let t=Math.ceil(n.length/4);try{t=(await ie(e)).encode(n).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count")}return rt(e)-t};var nt=()=>!1,B=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??nt(),this.callbacks=e.callbacks}},M=class extends B{get callKeys(){return["stop","timeout","signal"]}constructor(e){super({verbose:e.verbose,callbacks:e.callbacks??e.callbackManager}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new v(e??{})}async getNumTokens(e){let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await ie("modelName"in this?xe(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return this._encoding&&(t=this._encoding.encode(e).length),t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...a}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let i={openai:(await import("/v135/langchain@0.0.92/denonext/dist/chat_models/openai.js")).ChatOpenAI}[t];if(i===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new i(a)}};var se=class extends B{constructor(e,t,r){if(arguments.length===1&&typeof e=="object"&&!("saveContext"in e)){let{memory:a,callbackManager:i,...o}=e;super({...o,callbacks:i??o.callbacks}),this.memory=a}else super({verbose:t,callbacks:r}),this.memory=e}serialize(){throw new Error("Method not implemented.")}async run(e,t){if(!(this.inputKeys.length<=1))throw new Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);let a=this.inputKeys.length?{[this.inputKeys[0]]:e}:{},i=await this.call(a,t),o=Object.keys(i);if(o.length===1)return i[o[0]];throw new Error("return values have multiple keys, `run` only supported when one key currently")}async call(e,t){let r={...e};if(this.memory!=null){let s=await this.memory.loadMemoryVariables(e);for(let[u,p]of Object.entries(s))r[u]=p}let i=await(await O.configure(t,this.callbacks,{verbose:this.verbose}))?.handleChainStart({name:this._chainType()},r),o;try{o=await this._call(r,i)}catch(s){throw await i?.handleChainError(s),s}return this.memory!=null&&await this.memory.saveContext(e,o),await i?.handleChainEnd(o),Object.defineProperty(o,Q,{value:i?{runId:i?.runId}:void 0,configurable:!0}),o}async apply(e,t){return Promise.all(e.map(async(r,a)=>this.call(r,t?.[a])))}static async deserialize(e,t={}){switch(e._type){case"llm_chain":{let{LLMChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/llm_chain.js");return r.deserialize(e)}case"sequential_chain":{let{SequentialChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/sequential_chain.js");return r.deserialize(e)}case"simple_sequential_chain":{let{SimpleSequentialChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/sequential_chain.js");return r.deserialize(e)}case"stuff_documents_chain":{let{StuffDocumentsChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return r.deserialize(e)}case"map_reduce_documents_chain":{let{MapReduceDocumentsChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return r.deserialize(e)}case"refine_documents_chain":{let{RefineDocumentsChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return r.deserialize(e)}case"vector_db_qa":{let{VectorDBQAChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/vector_db_qa.js");return r.deserialize(e,t)}case"api_chain":{let{APIChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/api/api_chain.js");return r.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}};var ve=class n extends se{get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(e){if(super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"text"}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,this.llm=e.llm,this.outputKey=e.outputKey??this.outputKey,this.outputParser=e.outputParser??this.outputParser,this.prompt.outputParser){if(this.outputParser)throw new Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}async _getFinalOutput(e,t,r){let a=e[0].text,i;return this.outputParser?i=await this.outputParser.parseWithPrompt(a,t,r?.getChild()):i=a,i}call(e,t){return super.call(e,t)}async _call(e,t){let r={...e},a={};for(let s of this.llm.callKeys)s in e&&(a[s]=e[s],delete r[s]);let i=await this.prompt.formatPromptValue(r),{generations:o}=await this.llm.generatePrompt([i],a,t?.getChild());return{[this.outputKey]:await this._getFinalOutput(o[0],i,t)}}async predict(e,t){return(await this.call(e,t))[this.outputKey]}_chainType(){return"llm_chain"}static async deserialize(e){let{llm:t,prompt:r}=e;if(!t)throw new Error("LLMChain must have llm");if(!r)throw new Error("LLMChain must have prompt");return new n({llm:await M.deserialize(t),prompt:await _.deserialize(r)})}serialize(){return{_type:this._chainType(),llm:this.llm.serialize(),prompt:this.prompt.serialize()}}};import{Configuration as Et,OpenAIApi as Tt}from"/v135/openai@3.3.0/denonext/openai.mjs";import ue from"/v135/axios@1.6.2/denonext/axios.mjs";var oe="text/event-stream";async function $e(n,e){let t=n.getReader();for(;;){let r=await t.read();if(r.done){e(new Uint8Array,!0);break}e(r.value)}}function ze(n){let e,t,r,a=!1;return function(o,s){if(s){n(o,0,!0);return}e===void 0?(e=o,t=0,r=-1):e=at(e,o);let u=e.length,p=0;for(;t<u;){a&&(e[t]===10&&(p=++t),a=!1);let l=-1;for(;t<u&&l===-1;++t)switch(e[t]){case 58:r===-1&&(r=t-p);break;case 13:a=!0;case 10:l=t;break}if(l===-1)break;n(e.subarray(p,l),r),p=t,r=-1}p===u?e=void 0:p!==0&&(e=e.subarray(p),t-=p)}}function Ve(n,e,t){let r=Oe(),a=new TextDecoder;return function(o,s,u){if(u){it(r)||(n?.(r),r=Oe());return}if(o.length===0)n?.(r),r=Oe();else if(s>0){let p=a.decode(o.subarray(0,s)),l=s+(o[s+1]===32?2:1),m=a.decode(o.subarray(l));switch(p){case"data":r.data=r.data?r.data+`
`+m:m;break;case"event":r.event=m;break;case"id":e?.(r.id=m);break;case"retry":{let h=parseInt(m,10);Number.isNaN(h)||t?.(r.retry=h);break}}}}}function at(n,e){let t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function Oe(){return{data:"",event:"",id:"",retry:void 0}}function it(n){return n.data===""&&n.event===""&&n.id===""&&n.retry===void 0}function st(n){try{return JSON.stringify(n)}catch{return n}}function ot(n,e,t){let{validateStatus:r}=t.config;!t.status||!r||r(t.status)?n(t):e(le(`Request failed with status code ${t.status} and body ${typeof t.data=="string"?t.data:st(t.data)}`,t.config,null,t.request,t))}function ut(n){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(n)}function lt(n,e){return e?n.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,""):n}function Ke(n){return encodeURIComponent(n).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function ct(n,e,t){if(!e)return n;var r;if(t)r=t(e);else if(ft(e))r=e.toString();else{var a=[];De(e,function(s,u){s===null||typeof s>"u"||(He(s)?u=`${u}[]`:s=[s],De(s,function(l){dt(l)?l=l.toISOString():ht(l)&&(l=JSON.stringify(l)),a.push(`${Ke(u)}=${Ke(l)}`)}))}),r=a.join("&")}if(r){var i=n.indexOf("#");i!==-1&&(n=n.slice(0,i)),n+=(n.indexOf("?")===-1?"?":"&")+r}return n}function pt(n,e){return n&&!ut(e)?lt(n,e):e}function mt(n){return typeof n>"u"}function ht(n){return n!==null&&typeof n=="object"}function dt(n){return toString.call(n)==="[object Date]"}function ft(n){return toString.call(n)==="[object URLSearchParams]"}function He(n){return Array.isArray(n)}function De(n,e){if(!(n===null||typeof n>"u"))if(typeof n!="object"&&(n=[n]),He(n))for(var t=0,r=n.length;t<r;t++)e.call(null,n[t],t,n);else for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&e.call(null,n[a],a,n)}function bt(n){return toString.call(n)==="[object FormData]"}function yt(){return typeof navigator<"u"&&(navigator.product==="ReactNative"||navigator.product==="NativeScript"||navigator.product==="NS")?!1:typeof window<"u"&&typeof document<"u"}async function I(n){let e=wt(n),t=await gt(e,n);return new Promise((r,a)=>{t instanceof Error?a(t):Object.prototype.toString.call(n.settle)==="[object Function]"?n.settle(r,a,t):ot(r,a,t)})}async function gt(n,e){let t;try{t=await fetch(n)}catch(i){return i&&i.name==="AbortError"?le("Request aborted",e,"ECONNABORTED",n):i&&i.name==="TimeoutError"?le("Request timeout",e,"ECONNABORTED",n):le("Network Error",e,"ERR_NETWORK",n)}let r={};t.headers.forEach((i,o)=>{r[o]=i});let a={ok:t.ok,status:t.status,statusText:t.statusText,headers:r,config:e,request:n};if(t.status>=200&&t.status!==204)if(e.responseType==="stream"){let i=t.headers.get("content-type");if(!i?.startsWith(oe)){if(t.status>=400)return i?.startsWith("application/json")?(a.data=await t.json(),a):(a.data=await t.text(),a);throw new Error(`Expected content-type to be ${oe}, Actual: ${i}`)}await $e(t.body,ze(Ve(e.onmessage)))}else switch(e.responseType){case"arraybuffer":a.data=await t.arrayBuffer();break;case"blob":a.data=await t.blob();break;case"json":a.data=await t.json();break;case"formData":a.data=await t.formData();break;default:a.data=await t.text();break}return a}function wt(n){let e=new Headers(n.headers);if(n.auth){let o=n.auth.username||"",s=n.auth.password?decodeURI(encodeURIComponent(n.auth.password)):"";e.set("Authorization",`Basic ${btoa(`${o}:${s}`)}`)}let t=n.method.toUpperCase(),r={headers:e,method:t};t!=="GET"&&t!=="HEAD"&&(r.body=n.data,bt(r.body)&&yt()&&e.delete("Content-Type")),typeof r.body=="string"&&(r.body=new TextEncoder().encode(r.body)),n.mode&&(r.mode=n.mode),n.cache&&(r.cache=n.cache),n.integrity&&(r.integrity=n.integrity),n.redirect&&(r.redirect=n.redirect),n.referrer&&(r.referrer=n.referrer),n.timeout&&n.timeout>0&&(r.signal=AbortSignal.timeout(n.timeout)),n.signal&&(r.signal=n.signal),mt(n.withCredentials)||(r.credentials=n.withCredentials?"include":"omit"),n.responseType==="stream"&&r.headers.set("Accept",oe);let a=pt(n.baseURL,n.url),i=ct(a,n.params,n.paramsSerializer);return new Request(i,r)}function le(n,e,t,r,a){if(ue.AxiosError&&typeof ue.AxiosError=="function")return new ue.AxiosError(n,ue.AxiosError[t],e,r,a);let i=new Error(n);return _t(i,e,t,r,a)}function _t(n,e,t,r,a){return n.config=e,t&&(n.code=t),n.request=r,n.response=a,n.isAxiosError=!0,n.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}},n}var Ae=(n,e)=>n.reduce((t,r,a)=>{let i=Math.floor(a/e),o=t[i]||[];return t[i]=o.concat([r]),t},[]);import xt from"/v135/object-hash@3.0.0/denonext/object-hash.mjs";var Ee=(...n)=>xt(n.join("_"));var Pt=new Map,ce=class n extends Z{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Ee(e,t))??null)}async update(e,t,r){this.cache.set(Ee(e,t),r)}static global(){return new n(Pt)}};var U=class extends M{constructor({cache:e,concurrency:t,...r}){super(t?{maxConcurrency:t,...r}:r),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof e=="object"?this.cache=e:e?this.cache=ce.global():this.cache=void 0}async generatePrompt(e,t,r){let a=e.map(i=>i.toString());return this.generate(a,t,r)}invocationParams(){return{}}async _generateUncached(e,t,r){let a=await O.configure(r,this.callbacks,{verbose:this.verbose}),i={invocation_params:this?.invocationParams()},o=await a?.handleLLMStart({name:this._llmType()},e,void 0,void 0,i),s;try{s=await this._generate(e,t,o)}catch(u){throw await o?.handleLLMError(u),u}return await o?.handleLLMEnd(s),Object.defineProperty(s,Q,{value:o?{runId:o?.runId}:void 0,configurable:!0}),s}async generate(e,t,r){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let a;if(Array.isArray(t)?a={stop:t}:t?.timeout&&!t.signal?a={...t,signal:AbortSignal.timeout(t.timeout)}:a=t??{},!this.cache)return this._generateUncached(e,a,r);let{cache:i}=this,o=this.serialize();o.stop=a.stop??o.stop;let s=`${Object.entries(o).sort()}`,u=[],p=await Promise.all(e.map(async(m,h)=>{let f=await i.lookup(m,s);return f||u.push(h),f})),l={};if(u.length>0){let m=await this._generateUncached(u.map(h=>e[h]),a,r);await Promise.all(m.generations.map(async(h,f)=>{let d=u[f];return p[d]=h,i.update(e[d],s,h)})),l=m.llmOutput??{}}return{generations:p,llmOutput:l}}async call(e,t,r){let{generations:a}=await this.generate([e],t??{},r);return a[0][0].text}async predict(e,t,r){return this.call(e,t,r)}async predictMessages(e,t,r){let a=N(e),i=await this.call(a,t,r);return new R(i)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}static async deserialize(e){let{_type:t,_model:r,...a}=e;if(r&&r!=="base_llm")throw new Error(`Cannot load LLM with model ${r}`);let i={openai:(await import("/v135/langchain@0.0.92/denonext/dist/llms/openai.js")).OpenAI}[t];if(i===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new i(a)}},pe=class extends U{async _generate(e,t,r){return{generations:await Promise.all(e.map(i=>this._call(i,t,r).then(o=>[{text:o}])))}}};import{Configuration as Ot,OpenAIApi as At}from"/v135/openai@3.3.0/denonext/openai.mjs";var q=class extends pe{get callKeys(){return["stop","signal","timeout","options"]}constructor(e,t){super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"prefixMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??c("OPENAI_API_KEY"),a=e?.azureOpenAIApiKey??c("AZURE_OPENAI_API_KEY");if(!a&&!r)throw new Error("(Azure) OpenAI API key not found");let i=e?.azureOpenAIApiInstanceName??c("AZURE_OPENAI_API_INSTANCE_NAME"),o=e?.azureOpenAIApiDeploymentName??c("AZURE_OPENAI_API_DEPLOYMENT_NAME"),s=e?.azureOpenAIApiVersion??c("AZURE_OPENAI_API_VERSION");if(this.modelName=e?.modelName??this.modelName,this.prefixMessages=e?.prefixMessages??this.prefixMessages,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.maxTokens=e?.maxTokens,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=s,this.azureOpenAIApiKey=a,this.azureOpenAIApiInstanceName=i,this.azureOpenAIApiDeploymentName=o,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,logit_bias:this.logitBias,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}formatMessages(e){let t={role:"user",content:e};return this.prefixMessages?[...this.prefixMessages,t]:[t]}async _call(e,t,r){let{stop:a}=t,i=this.invocationParams();return i.stop=a??i.stop,(i.stream?await new Promise((s,u)=>{let p,l=!1,m=!1;this.completionWithRetry({...i,messages:this.formatMessages(e)},{signal:t.signal,...t.options,adapter:I,responseType:"stream",onmessage:h=>{if(h.data?.trim?.()==="[DONE]"){if(m)return;m=!0,s(p)}else{let f=JSON.parse(h.data);p||(p={id:f.id,object:f.object,created:f.created,model:f.model,choices:[]});for(let d of f.choices)if(d!=null){let w=p.choices.find(me=>me.index===d.index);w||(w={index:d.index,finish_reason:d.finish_reason??void 0},p.choices.push(w)),w.message||(w.message={role:d.delta?.role,content:d.delta?.content??""}),w.message.content+=d.delta?.content??"",r?.handleLLMNewToken(d.delta?.content??"")}!m&&f.choices.every(d=>d.finish_reason!=null)&&(m=!0,s(p))}}}).catch(h=>{l||(l=!0,u(h))})}):await this.completionWithRetry({...i,messages:this.formatMessages(e)},{signal:t.signal,...t.options})).choices[0].message?.content??""}async completionWithRetry(e,t){if(!this.client){let a=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,i=new Ot({...this.clientConfig,basePath:a,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new At(i)}let r={adapter:K()?void 0:I,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createChatCompletion.bind(this.client),e,r).then(a=>a.data)}_llmType(){return"openai"}};var Te=class extends U{get callKeys(){return["stop","signal","timeout","options"]}constructor(e,t){if(e?.modelName?.startsWith("gpt-3.5-turbo")||e?.modelName?.startsWith("gpt-4")||e?.modelName?.startsWith("gpt-4-32k"))return new q(e,t);super(e??{}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"bestOf",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-davinci-003"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.openAIApiKey??c("OPENAI_API_KEY"),a=e?.azureOpenAIApiKey??c("AZURE_OPENAI_API_KEY");if(!a&&!r)throw new Error("(Azure) OpenAI API key not found");let i=e?.azureOpenAIApiInstanceName??c("AZURE_OPENAI_API_INSTANCE_NAME"),o=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??(c("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||c("AZURE_OPENAI_API_DEPLOYMENT_NAME")),s=e?.azureOpenAIApiVersion??c("AZURE_OPENAI_API_VERSION");if(this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.batchSize=e?.batchSize??this.batchSize,this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.maxTokens=e?.maxTokens??this.maxTokens,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.bestOf=e?.bestOf??this.bestOf,this.logitBias=e?.logitBias,this.stop=e?.stop,this.streaming=e?.streaming??!1,this.azureOpenAIApiVersion=s,this.azureOpenAIApiKey=a,this.azureOpenAIApiInstanceName=i,this.azureOpenAIApiDeploymentName=o,this.streaming&&this.n>1)throw new Error("Cannot stream results when n > 1");if(this.streaming&&this.bestOf>1)throw new Error("Cannot stream results when bestOf > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found")}this.clientConfig={apiKey:r,...t}}invocationParams(){return{model:this.modelName,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,best_of:this.bestOf,logit_bias:this.logitBias,stop:this.stop,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let{stop:a}=t,i=Ae(e,this.batchSize),o=[],s={};if(this.stop&&a)throw new Error("Stop found in input and default params");let u=this.invocationParams();if(u.stop=a??u.stop,u.max_tokens===-1){if(e.length!==1)throw new Error("max_tokens set to -1 not supported for multiple inputs");u.max_tokens=await Pe({prompt:e[0],modelName:this.modelName})}for(let l=0;l<i.length;l+=1){let m=u.stream?await new Promise((w,me)=>{let j=[],F,Ie=!1,W=!1;this.completionWithRetry({...u,prompt:i[l]},{signal:t.signal,...t.options,adapter:I,responseType:"stream",onmessage:J=>{if(J.data?.trim?.()==="[DONE]"){if(W)return;W=!0,w({...F,choices:j})}else{let C=JSON.parse(J.data);F||(F={id:C.id,object:C.object,created:C.created,model:C.model});for(let y of C.choices)if(y!=null&&y.index!=null){j[y.index]||(j[y.index]={});let G=j[y.index];G.text=(G.text??"")+(y.text??""),G.finish_reason=y.finish_reason,G.logprobs=y.logprobs,r?.handleLLMNewToken(y.text??"")}!W&&j.every(y=>y.finish_reason!=null)&&(W=!0,w({...F,choices:j}))}}}).catch(J=>{Ie||(Ie=!0,me(J))})}):await this.completionWithRetry({...u,prompt:i[l]},{signal:t.signal,...t.options});o.push(...m.choices);let{completion_tokens:h,prompt_tokens:f,total_tokens:d}=m.usage??{};h&&(s.completionTokens=(s.completionTokens??0)+h),f&&(s.promptTokens=(s.promptTokens??0)+f),d&&(s.totalTokens=(s.totalTokens??0)+d)}return{generations:Ae(o,this.n).map(l=>l.map(m=>({text:m.text??"",generationInfo:{finishReason:m.finish_reason,logprobs:m.logprobs}}))),llmOutput:{tokenUsage:s}}}async completionWithRetry(e,t){if(!this.client){let a=this.azureOpenAIApiKey?`https://${this.azureOpenAIApiInstanceName}.openai.azure.com/openai/deployments/${this.azureOpenAIApiDeploymentName}`:this.clientConfig.basePath,i=new Et({...this.clientConfig,basePath:a,baseOptions:{timeout:this.timeout,...this.clientConfig.baseOptions}});this.client=new Tt(i)}let r={adapter:K()?void 0:I,...this.clientConfig.baseOptions,...t};return this.azureOpenAIApiKey&&(r.headers={"api-key":this.azureOpenAIApiKey,...r.headers},r.params={"api-version":this.azureOpenAIApiVersion,...r.params}),this.caller.call(this.client.createCompletion.bind(this.client),e,r).then(a=>a.data)}_llmType(){return"openai"}};export{_ as BasePromptTemplate,ee as FewShotPromptTemplate,ve as LLMChain,Te as OpenAI,E as PromptTemplate};
//# sourceMappingURL=langchain.mjs.map