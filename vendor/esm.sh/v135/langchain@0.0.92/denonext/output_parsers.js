/* esm.sh - esbuild bundle(langchain@0.0.92/output_parsers) denonext production */
import __Process$ from "node:process";
var c=class{async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},l=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}};var x=class extends c{},H=class extends x{async parse(e){try{return e.trim().split(",").map(t=>t.trim())}catch{throw new l(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},K=class extends x{constructor({length:e,separator:t}){super(),Object.defineProperty(this,"length",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"separator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.length=e,this.separator=t||","}async parse(e){try{let t=e.trim().split(this.separator).map(r=>r.trim());if(this.length!==void 0&&t.length!==this.length)throw new l(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){throw Object.getPrototypeOf(t)===l.prototype?t:new l(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length} items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}};var J=class extends c{constructor(e,t,r){super(),Object.defineProperty(this,"regex",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKeys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultOutputKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.regex=typeof e=="string"?new RegExp(e):e,this.outputKeys=t,this.defaultOutputKey=r}_type(){return"regex_parser"}async parse(e){let t=e.match(this.regex);if(t)return this.outputKeys.reduce((r,n,i)=>(r[n]=t[i+1],r),{});if(this.defaultOutputKey===void 0)throw new l(`Could not parse output: ${e}`,e);return this.outputKeys.reduce((r,n)=>(r[n]=n===this.defaultOutputKey?e:"",r),{})}getFormatInstructions(){return`Your response should match the following regex: ${this.regex}`}};import{z as j}from"/v135/zod@3.22.4/denonext/zod.mjs";import{zodToJsonSchema as oe}from"/v135/zod-to-json-schema@3.22.0/denonext/zod-to-json-schema.mjs";var L=class extends c{constructor(e){super(),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=j.object(Object.fromEntries(Object.entries(e).map(([r,n])=>[r,j.string().describe(n)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(oe(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim();return this.schema.parseAsync(JSON.parse(t))}catch(t){throw new l(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}},w=class extends L{getFormatInstructions(e){let t=e?.interpolationDepth??1;if(t<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(oe(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}
\`\`\``}_schemaToInstruction(e,t=2){let r=e;if("type"in r){let n=!1,i;if(Array.isArray(r.type)){let u=r.type.findIndex(O=>O==="null");u!==-1&&(n=!0,r.type.splice(u,1)),i=r.type.join(" | ")}else i=r.type;if(r.type==="object"&&r.properties){let u=r.description?` // ${r.description}`:"";return`{
${Object.entries(r.properties).map(([ae,xe])=>{let ve=r.required?.includes(ae)?"":" (optional)";return`${" ".repeat(t)}"${ae}": ${this._schemaToInstruction(xe,t+2)}${ve}`}).join(`
`)}
${" ".repeat(t-2)}}${u}`}if(r.type==="array"&&r.items){let u=r.description?` // ${r.description}`:"";return`array[
${" ".repeat(t)}${this._schemaToInstruction(r.items,t+2)}
${" ".repeat(t-2)}] ${u}`}let o=n?" (nullable)":"",a=r.description?` // ${r.description}`:"";return`${i}${a}${o}`}if("anyOf"in r)return r.anyOf.map(n=>this._schemaToInstruction(n,t)).join(`
${" ".repeat(t-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=j.object(Object.fromEntries(Object.entries(e).map(([r,n])=>[r,j.string().describe(n)])));return new this(t)}},G=class extends c{constructor(e){super(),Object.defineProperty(this,"inputSchema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"structuredInputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.structuredInputParser=new w(e)}async parse(e){let t;try{t=await this.structuredInputParser.parse(e)}catch(r){throw new l(`Failed to parse. Text: "${e}". Error: ${r}`,e)}return this.outputProcessor(t)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}};var ue="__run",B=class{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e}toJSON(){return{type:this._getType(),data:{content:this.text,role:"role"in this?this.role:void 0}}}},S=class extends B{_getType(){return"human"}};var I=class{};import{v4 as E}from"/v135/uuid@9.0.1/denonext/uuid.mjs";import*as le from"/v135/uuid@9.0.1/denonext/uuid.mjs";var W=class{},y=class s extends W{constructor(e){super(),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}copy(){return new this.constructor(this)}static fromMethods(e){class t extends s{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:le.v4()}),Object.assign(this,e)}}return new t}};import ce from"/v135/ansi-styles@5.2.0/denonext/ansi-styles.mjs";var m=class extends y{constructor(){super(),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}_startTrace(e){if(e.parent_run_id!==void 0){let t=this.runMap.get(e.parent_run_id);t&&this._addChildRun(t,e)}this.runMap.set(e.id,e)}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,n,i){let o=this._getExecutionOrder(n),a={id:r,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{prompts:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:i};this._startTrace(a),await this.onLLMStart?.(a)}async handleChatModelStart(e,t,r,n,i){let o=this._getExecutionOrder(n),a={id:r,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{messages:t},execution_order:o,child_runs:[],child_execution_order:o,run_type:"llm",extra:i};this._startTrace(a),await this.onLLMStart?.(a)}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.outputs=e,await this.onLLMEnd?.(r),await this._endTrace(r)}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");r.end_time=Date.now(),r.error=e.message,await this.onLLMError?.(r),await this._endTrace(r)}async handleChainStart(e,t,r,n){let i=this._getExecutionOrder(n),o={id:r,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:t,execution_order:i,child_execution_order:i,run_type:"chain",child_runs:[]};this._startTrace(o),await this.onChainStart?.(o)}async handleChainEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.outputs=e,await this.onChainEnd?.(r),await this._endTrace(r)}async handleChainError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")throw new Error("No chain run to end.");r.end_time=Date.now(),r.error=e.message,await this.onChainError?.(r),await this._endTrace(r)}async handleToolStart(e,t,r,n){let i=this._getExecutionOrder(n),o={id:r,name:e.name,parent_run_id:n,start_time:Date.now(),serialized:e,inputs:{input:t},execution_order:i,child_execution_order:i,run_type:"tool",child_runs:[]};this._startTrace(o),await this.onToolStart?.(o)}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.outputs={output:e},await this.onToolEnd?.(r),await this._endTrace(r)}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");r.end_time=Date.now(),r.error=e.message,await this.onToolError?.(r),await this._endTrace(r)}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let n=r;n.actions=n.actions||[],n.actions.push(e),await this.onAgentAction?.(r)}};function p(s,e){return`${s.open}${e}${s.close}`}function f(s,e){try{return JSON.stringify(s,null,2)}catch{return e}}function g(s){if(!s.end_time)return"";let e=s.end_time-s.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:d}=ce,v=class extends m{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let n=this.runMap.get(r.parent_run_id);if(n)t.push(n),r=n;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((n,i,o)=>{let a=`${n.execution_order}:${n.run_type}:${n.name}`;return i===o.length-1?p(ce.bold,a):a}).join(" > ");return p(d.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${p(d.green,"[chain/start]")} [${t}] Entering Chain run with input: ${f(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${p(d.cyan,"[chain/end]")} [${t}] [${g(e)}] Exiting Chain run with output: ${f(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${p(d.red,"[chain/error]")} [${t}] [${g(e)}] Chain run errored with error: ${f(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(n=>n.trim())}:e.inputs;console.log(`${p(d.green,"[llm/start]")} [${t}] Entering LLM run with input: ${f(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${p(d.cyan,"[llm/end]")} [${t}] [${g(e)}] Exiting LLM run with output: ${f(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${p(d.red,"[llm/error]")} [${t}] [${g(e)}] LLM run errored with error: ${f(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${p(d.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${p(d.cyan,"[tool/end]")} [${t}] [${g(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${p(d.red,"[tool/error]")} [${t}] [${g(e)}] Tool run errored with error: ${f(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${p(d.blue,"[agent/action]")} [${r}] Agent selected action: ${f(t.actions[t.actions.length-1],"[action]")}`)}};import Ee from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import U from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var $e=[400,401,403,404,405,406,407,408,409],b=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;let t="default"in U?U.default:U;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Ee(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||r?.code==="ECONNABORTED")throw r;let n=r?.response?.status;if(n&&$e.includes(+n))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((n,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var Pe=()=>typeof window<"u"&&typeof window.document<"u",Te=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Oe=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),pe=()=>typeof Deno<"u",je=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!pe(),Le=()=>{let s;return Pe()?s="browser":je()?s="node":Te()?s="webworker":Oe()?s="jsdom":pe()?s="deno":s="other",s},q;async function he(){return q===void 0&&(q={library:"langchain-js",runtime:Le()}),q}function h(s){try{return typeof __Process$<"u"?__Process$.env?.[s]:void 0}catch{return}}var C=class extends m{constructor({exampleId:e,sessionName:t,callerParams:r,timeout:n}={}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:h("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"sessionName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:5e3});let i=h("LANGCHAIN_API_KEY");i&&(this.headers["x-api-key"]=i),this.sessionName=t??h("LANGCHAIN_SESSION"),this.exampleId=e,this.timeout=n??this.timeout,this.caller=new b(r??{maxRetries:2})}async _convertToCreate(e,t=void 0){let r=e.extra??{};return r.runtime=await he(),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.parent_run_id?void 0:t,extra:r,parent_run_id:e.parent_run_id,execution_order:e.execution_order,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs??{},session_name:this.sessionName,child_runs:[]}}async persistRun(e){}async _persistRunSingle(e){let t=await this._convertToCreate(e,this.exampleId),r=`${this.endpoint}/runs`,n=await this.caller.call(fetch,r,{method:"POST",headers:this.headers,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout)}),i=await n.text();if(!n.ok)throw new Error(`Failed to persist run: ${n.status} ${n.statusText} ${i}`)}async _updateRunSingle(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,parent_run_id:e.parent_run_id,reference_example_id:e.reference_example_id},r=`${this.endpoint}/runs/${e.id}`,n=await this.caller.call(fetch,r,{method:"PATCH",headers:this.headers,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout)}),i=await n.text();if(!n.ok)throw new Error(`Failed to update run: ${n.status} ${n.statusText} ${i}`)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}};function M(s,e="Human",t="AI"){let r=[];for(let n of s){let i;if(n._getType()==="human")i=e;else if(n._getType()==="ai")i=t;else if(n._getType()==="system")i="System";else if(n._getType()==="generic")i=n.role;else throw new Error(`Got unsupported message type: ${n}`);r.push(`${i}: ${n.text}`)}return r.join(`
`)}var A=class extends m{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:h("LANGCHAIN_ENDPOINT")||"http://localhost:1984"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let e=h("LANGCHAIN_API_KEY");e&&(this.headers["x-api-key"]=e)}async newSession(e){let t={start_time:Date.now(),name:e},r=await this.persistSession(t);return this.session=r,r}async loadSession(e){let t=`${this.endpoint}/sessions?name=${e}`;return this._handleSessionResponse(t)}async loadDefaultSession(){let e=`${this.endpoint}/sessions?name=default`;return this._handleSessionResponse(e)}async convertV2RunToRun(e){let t=this.session??await this.loadDefaultSession(),r=e.serialized,n;if(e.run_type==="llm"){let i=e.inputs.prompts?e.inputs.prompts:e.inputs.messages.map(a=>M(a));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,prompts:i,response:e.outputs}}else if(e.run_type==="chain"){let i=await Promise.all(e.child_runs.map(a=>this.convertV2RunToRun(a)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,inputs:e.inputs,outputs:e.outputs,child_llm_runs:i.filter(a=>a.type==="llm"),child_chain_runs:i.filter(a=>a.type==="chain"),child_tool_runs:i.filter(a=>a.type==="tool")}}else if(e.run_type==="tool"){let i=await Promise.all(e.child_runs.map(a=>this.convertV2RunToRun(a)));n={uuid:e.id,start_time:e.start_time,end_time:e.end_time,execution_order:e.execution_order,child_execution_order:e.child_execution_order,serialized:r,type:e.run_type,session_id:t.id,tool_input:e.inputs.input,output:e.outputs?.output,action:JSON.stringify(r),child_llm_runs:i.filter(a=>a.type==="llm"),child_chain_runs:i.filter(a=>a.type==="chain"),child_tool_runs:i.filter(a=>a.type==="tool")}}else throw new Error(`Unknown run type: ${e.run_type}`);return n}async persistRun(e){let t,r;e.run_type!==void 0?r=await this.convertV2RunToRun(e):r=e,r.type==="llm"?t=`${this.endpoint}/llm-runs`:r.type==="chain"?t=`${this.endpoint}/chain-runs`:t=`${this.endpoint}/tool-runs`;let n=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(r)});n.ok||console.error(`Failed to persist run: ${n.status} ${n.statusText}`)}async persistSession(e){let t=`${this.endpoint}/sessions`,r=await fetch(t,{method:"POST",headers:this.headers,body:JSON.stringify(e)});return r.ok?{id:(await r.json()).id,...e}:(console.error(`Failed to persist session: ${r.status} ${r.statusText}, using default session.`),{id:1,...e})}async _handleSessionResponse(e){let t=await fetch(e,{method:"GET",headers:this.headers}),r;if(!t.ok)return console.error(`Failed to load session: ${t.status} ${t.statusText}`),r={id:1,start_time:Date.now()},this.session=r,r;let n=await t.json();return n.length===0?(r={id:1,start_time:Date.now()},this.session=r,r):([r]=n,this.session=r,r)}};async function de(s){let e=new A;return s?await e.loadSession(s):await e.loadDefaultSession(),e}async function me(){return new C}var Y=class{setHandler(e){return this.setHandlers([e])}},$=class{constructor(e,t,r,n){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:n})}async handleText(e){await Promise.all(this.handlers.map(async t=>{try{await t.handleText?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`)}}))}},R=class extends ${async handleLLMNewToken(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMNewToken?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMNewToken: ${r}`)}}))}async handleLLMError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`)}}))}async handleLLMEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`)}}))}},Q=class extends ${getChild(){let e=new _(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleChainError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${r}`)}}))}async handleChainEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${r}`)}}))}async handleAgentAction(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`)}}))}async handleAgentEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`)}}))}},X=class extends ${getChild(){let e=new _(this.runId);return e.setHandlers(this.inheritableHandlers),e}async handleToolError(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`)}}))}async handleToolEnd(e){await Promise.all(this.handlers.map(async t=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId)}catch(r){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`)}}))}},_=class s extends Y{constructor(e){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[],this.inheritableHandlers=[],this._parentRunId=e}async handleLLMStart(e,t,r=E(),n=void 0,i=void 0){return await Promise.all(this.handlers.map(async o=>{if(!o.ignoreLLM)try{await o.handleLLMStart?.(e,t,r,this._parentRunId,i)}catch(a){console.error(`Error in handler ${o.constructor.name}, handleLLMStart: ${a}`)}})),new R(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChatModelStart(e,t,r=E(),n=void 0,i=void 0){let o;return await Promise.all(this.handlers.map(async a=>{if(!a.ignoreLLM)try{a.handleChatModelStart?await a.handleChatModelStart?.(e,t,r,this._parentRunId,i):a.handleLLMStart&&(o=t.map(u=>M(u)),await a.handleLLMStart?.(e,o,r,this._parentRunId,i))}catch(u){console.error(`Error in handler ${a.constructor.name}, handleLLMStart: ${u}`)}})),new R(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleChainStart(e,t,r=E()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreChain)try{await n.handleChainStart?.(e,t,r,this._parentRunId)}catch(i){console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${i}`)}})),new Q(r,this.handlers,this.inheritableHandlers,this._parentRunId)}async handleToolStart(e,t,r=E()){return await Promise.all(this.handlers.map(async n=>{if(!n.ignoreAgent)try{await n.handleToolStart?.(e,t,r,this._parentRunId)}catch(i){console.error(`Error in handler ${n.constructor.name}, handleToolStart: ${i}`)}})),new X(r,this.handlers,this.inheritableHandlers,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}copy(e=[],t=!0){let r=new s(this._parentRunId);for(let n of this.handlers){let i=this.inheritableHandlers.includes(n);r.addHandler(n,i)}for(let n of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){class t extends y{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:E()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r){let n;(e||t)&&(Array.isArray(e)||!e?(n=new s,n.setHandlers(e?.map(fe)??[],!0)):n=e,n=n.copy(Array.isArray(t)?t.map(fe):t?.handlers,!1));let i=h("LANGCHAIN_VERBOSE")||r?.verbose,o=h("LANGCHAIN_TRACING_V2")??!1,a=o||(h("LANGCHAIN_TRACING")??!1);if(i||a){if(n||(n=new s),i&&!n.handlers.some(u=>u.name===v.prototype.name)){let u=new v;n.addHandler(u,!0)}if(a&&!n.handlers.some(u=>u.name==="langchain_tracer"))if(o)n.addHandler(await me(),!0);else{let u=h("LANGCHAIN_SESSION");n.addHandler(await de(u),!0)}}return n}};function fe(s){return"name"in s?s:y.fromMethods(s)}import{Tiktoken as Se,getEncodingNameForModel as Ie}from"/v135/js-tiktoken@1.0.8/denonext/lite.js";var k={},Ce=new b({});async function Me(s,e){return s in k||(k[s]=Ce.fetch(`https://tiktoken.pages.dev/js/${s}.json`,{signal:e?.signal}).then(t=>t.json()).catch(t=>{throw delete k[s],t})),new Se(await k[s],e?.extendedSpecialTokens)}async function Z(s,e){return Me(Ie(s),e)}var be=s=>s.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":s.startsWith("gpt-4-32k-")?"gpt-4-32k":s.startsWith("gpt-4-")?"gpt-4":s;var Ae=()=>!1,P=class{constructor(e){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??Ae(),this.callbacks=e.callbacks}},N=class extends P{get callKeys(){return["stop","timeout","signal"]}constructor(e){super({verbose:e.verbose,callbacks:e.callbacks??e.callbackManager}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new b(e??{})}async getNumTokens(e){let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Z("modelName"in this?be(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return this._encoding&&(t=this._encoding.encode(e).length),t}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){let{_type:t,_model:r,...n}=e;if(r&&r!=="base_chat_model")throw new Error(`Cannot load LLM with model ${r}`);let i={openai:(await import("/v135/langchain@0.0.92/denonext/dist/chat_models/openai.js")).ChatOpenAI}[t];if(i===void 0)throw new Error(`Cannot load  LLM with type ${t}`);return new i(n)}};var D=class extends P{constructor(e,t,r){if(arguments.length===1&&typeof e=="object"&&!("saveContext"in e)){let{memory:n,callbackManager:i,...o}=e;super({...o,callbacks:i??o.callbacks}),this.memory=n}else super({verbose:t,callbacks:r}),this.memory=e}serialize(){throw new Error("Method not implemented.")}async run(e,t){if(!(this.inputKeys.length<=1))throw new Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);let n=this.inputKeys.length?{[this.inputKeys[0]]:e}:{},i=await this.call(n,t),o=Object.keys(i);if(o.length===1)return i[o[0]];throw new Error("return values have multiple keys, `run` only supported when one key currently")}async call(e,t){let r={...e};if(this.memory!=null){let a=await this.memory.loadMemoryVariables(e);for(let[u,O]of Object.entries(a))r[u]=O}let i=await(await _.configure(t,this.callbacks,{verbose:this.verbose}))?.handleChainStart({name:this._chainType()},r),o;try{o=await this._call(r,i)}catch(a){throw await i?.handleChainError(a),a}return this.memory!=null&&await this.memory.saveContext(e,o),await i?.handleChainEnd(o),Object.defineProperty(o,ue,{value:i?{runId:i?.runId}:void 0,configurable:!0}),o}async apply(e,t){return Promise.all(e.map(async(r,n)=>this.call(r,t?.[n])))}static async deserialize(e,t={}){switch(e._type){case"llm_chain":{let{LLMChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/llm_chain.js");return r.deserialize(e)}case"sequential_chain":{let{SequentialChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/sequential_chain.js");return r.deserialize(e)}case"simple_sequential_chain":{let{SimpleSequentialChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/sequential_chain.js");return r.deserialize(e)}case"stuff_documents_chain":{let{StuffDocumentsChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return r.deserialize(e)}case"map_reduce_documents_chain":{let{MapReduceDocumentsChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return r.deserialize(e)}case"refine_documents_chain":{let{RefineDocumentsChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/combine_docs_chain.js");return r.deserialize(e)}case"vector_db_qa":{let{VectorDBQAChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/vector_db_qa.js");return r.deserialize(e,t)}case"api_chain":{let{APIChain:r}=await import("/v135/langchain@0.0.92/denonext/dist/chains/api/api_chain.js");return r.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}};var ee=class extends I{constructor(e){super(),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new S(this.value)]}},T=class{constructor(e){Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},r={};for(let[i,o]of Object.entries(t))typeof o=="string"?r[i]=o:r[i]=await o();return{...r,...e}}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/prompt.js");return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/prompt.js");return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await import("/v135/langchain@0.0.92/denonext/dist/prompts/few_shot.js");return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}},V=class extends T{async formatPromptValue(e){let t=await this.format(e);return new ee(t)}};var z=class s extends D{get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(e){if(super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"text"}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,this.llm=e.llm,this.outputKey=e.outputKey??this.outputKey,this.outputParser=e.outputParser??this.outputParser,this.prompt.outputParser){if(this.outputParser)throw new Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}async _getFinalOutput(e,t,r){let n=e[0].text,i;return this.outputParser?i=await this.outputParser.parseWithPrompt(n,t,r?.getChild()):i=n,i}call(e,t){return super.call(e,t)}async _call(e,t){let r={...e},n={};for(let a of this.llm.callKeys)a in e&&(n[a]=e[a],delete r[a]);let i=await this.prompt.formatPromptValue(r),{generations:o}=await this.llm.generatePrompt([i],n,t?.getChild());return{[this.outputKey]:await this._getFinalOutput(o[0],i,t)}}async predict(e,t){return(await this.call(e,t))[this.outputKey]}_chainType(){return"llm_chain"}static async deserialize(e){let{llm:t,prompt:r}=e;if(!t)throw new Error("LLMChain must have llm");if(!r)throw new Error("LLMChain must have prompt");return new s({llm:await N.deserialize(t),prompt:await T.deserialize(r)})}serialize(){return{_type:this._chainType(),llm:this.llm.serialize(),prompt:this.prompt.serialize()}}};var ye=s=>{let e=s.split(""),t=[],r=(i,o)=>{for(let a=o;a<e.length;a+=1)if(i.includes(e[a]))return a;return-1},n=0;for(;n<e.length;)if(e[n]==="{"&&n+1<e.length&&e[n+1]==="{")t.push({type:"literal",text:"{"}),n+=2;else if(e[n]==="}"&&n+1<e.length&&e[n+1]==="}")t.push({type:"literal",text:"}"}),n+=2;else if(e[n]==="{"){let i=r("}",n);if(i<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(n+1,i).join("")}),n=i+1}else{if(e[n]==="}")throw new Error("Single '}' in template.");{let i=r("{}",n),o=(i<0?e.slice(n):e.slice(n,i)).join("");t.push({type:"literal",text:o}),n=i<0?e.length:i}}return t},Re=(s,e)=>ye(s).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`Missing value for input ${r.name}`)}return t+r.text},""),te={"f-string":Re,jinja2:(s,e)=>""},ke={"f-string":ye,jinja2:s=>[]},re=(s,e,t)=>te[e](s,t),we=(s,e)=>ke[e](s),ge=(s,e,t)=>{if(!(e in te)){let r=Object.keys(te);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{let r=t.reduce((n,i)=>(n[i]="foo",n),{});re(s,e,r)}catch{throw new Error("Invalid prompt schema.")}};var F=class s extends V{constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),ge(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return re(this.template,this.templateFormat,t)}static fromExamples(e,t,r,n=`

`,i=""){let o=[i,...e,t].join(n);return new s({inputVariables:r,template:o})}static fromTemplate(e,{templateFormat:t="f-string",...r}={}){let n=new Set;return we(e,t).forEach(i=>{i.type==="variable"&&n.add(i.name)}),new s({inputVariables:[...n],templateFormat:t,template:e,...r})}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new s(t)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new s({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}};var Ne=`Instructions:
--------------
{instructions}
--------------
Completion:
--------------
{completion}
--------------

Above, the Completion did not satisfy the constraints given in the Instructions.
Error:
--------------
{error}
--------------

Please try again. Please only respond with an answer that satisfies the constraints laid out in the Instructions:`,_e=F.fromTemplate(Ne);var ne=class s extends c{static fromLLM(e,t,r){let n=r?.prompt??_e,i=new z({llm:e,prompt:n});return new s({parser:t,retryChain:i})}constructor({parser:e,retryChain:t}){super(),Object.defineProperty(this,"parser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"retryChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.parser=e,this.retryChain=t}async parse(e,t){try{return await this.parser.parse(e,t)}catch(r){if(r instanceof l){let i=(await this.retryChain.call({instructions:this.parser.getFormatInstructions(),completion:e,error:r},t))[this.retryChain.outputKey];return this.parser.parse(i)}throw r}}getFormatInstructions(){return this.parser.getFormatInstructions()}};var ie=class extends c{constructor(...e){super(),Object.defineProperty(this,"parsers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputDelimiter",{enumerable:!0,configurable:!0,writable:!0,value:"-----"}),this.parsers=e}async parse(e,t){let r=e.trim().split(new RegExp(`${this.outputDelimiter}Output \\d+${this.outputDelimiter}`)).slice(1),n={};for(let[i,o]of this.parsers.entries()){let a;try{let u=r[i].includes("```")?r[i].trim().split(/```/)[1]:r[i].trim();u.endsWith(this.outputDelimiter)&&(u=u.slice(0,-this.outputDelimiter.length)),a=await o.parse(u,t)}catch{a=await o.parse(e.trim(),t)}Object.assign(n,a)}return n}getFormatInstructions(){return`${[`Return the following ${this.parsers.length} outputs, each formatted as described below. Include the delimiter characters "${this.outputDelimiter}" in your response:`,...this.parsers.map((e,t)=>`${this.outputDelimiter}Output ${t+1}${this.outputDelimiter}
${e.getFormatInstructions().trim()}
${this.outputDelimiter}`)].join(`

`)}
`}};var se=class extends w{constructor(e,t){super(e),Object.defineProperty(this,"defaultDestination",{enumerable:!0,configurable:!0,writable:!0,value:"DEFAULT"}),this.defaultDestination=t?.defaultDestination??this.defaultDestination}async parse(e){try{let t=await super.parse(e);return t.destination?.toLowerCase()===this.defaultDestination.toLowerCase()&&(t.destination=null),t}catch(t){throw new l(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};export{G as AsymmetricStructuredOutputParser,ie as CombiningOutputParser,H as CommaSeparatedListOutputParser,K as CustomListOutputParser,w as JsonMarkdownStructuredOutputParser,x as ListOutputParser,ne as OutputFixingParser,J as RegexParser,se as RouterOutputParser,L as StructuredOutputParser};
//# sourceMappingURL=output_parsers.js.map