/* esm.sh - esbuild bundle(@langchain/openai@0.2.5) denonext production */
import{OpenAI as Ht,toFile as Wt}from"/v135/openai@4.53.0/denonext/openai.mjs";import{OpenAI as ee}from"/v135/openai@4.53.0/denonext/openai.mjs";import{AIMessage as te,AIMessageChunk as q,ChatMessage as B,ChatMessageChunk as re,FunctionMessageChunk as ne,HumanMessageChunk as ie,SystemMessageChunk as ae,ToolMessageChunk as oe,isAIMessage as V}from"/v135/@langchain/core@0.2.18/denonext/messages.js";import{ChatGenerationChunk as C}from"/v135/@langchain/core@0.2.18/denonext/outputs.js";import{getEnvironmentVariable as _}from"/v135/@langchain/core@0.2.18/denonext/utils/env.js";import{BaseChatModel as se}from"/v135/@langchain/core@0.2.18/denonext/language_models/chat_models.js";import{convertToOpenAITool as x}from"/v135/@langchain/core@0.2.18/denonext/utils/function_calling.js";import{RunnablePassthrough as U,RunnableSequence as ue}from"/v135/@langchain/core@0.2.18/denonext/runnables.js";import{JsonOutputParser as pe,StructuredOutputParser as le}from"/v135/@langchain/core@0.2.18/denonext/output_parsers.js";import{JsonOutputKeyToolsParser as D,convertLangChainToolCallToOpenAI as ce,makeInvalidToolCall as me,parseToolCall as he}from"/v135/@langchain/core@0.2.18/denonext/output_parsers/openai_tools.js";import{zodToJsonSchema as Ae}from"/v135/zod-to-json-schema@3.23.1/denonext/zod-to-json-schema.mjs";function b(a){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:n,baseURL:i,azureADTokenProvider:o}=a;if((r||o)&&n&&e)return`${n}/${e}`;if(r||o){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return i}import{APIConnectionTimeoutError as G,APIUserAbortError as J}from"/v135/openai@4.53.0/denonext/openai.mjs";import{zodToJsonSchema as Q}from"/v135/zod-to-json-schema@3.23.1/denonext/zod-to-json-schema.mjs";import{convertToOpenAIFunction as Le,convertToOpenAITool as Me}from"/v135/@langchain/core@0.2.18/denonext/utils/function_calling.js";function y(a){let e;return a.constructor.name===G.name?(e=new Error(a.message),e.name="TimeoutError"):a.constructor.name===J.name?(e=new Error(a.message),e.name="AbortError"):e=a,e}function qe(a){return{type:"function",function:{name:a.name,description:a.description,parameters:Q(a.schema)}}}function K(a){if(a)return a==="any"||a==="required"?"required":a==="auto"?"auto":a==="none"?"none":typeof a=="string"?{type:"function",function:{name:a}}:a}function X(a){return a.anyOf!==void 0&&Array.isArray(a.anyOf)}function j(a){let e=["namespace functions {",""];for(let t of a)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(R(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function R(a,e){let t=[];for(let[r,n]of Object.entries(a.properties??{}))n.description&&e<2&&t.push(`// ${n.description}`),a.required?.includes(r)?t.push(`${r}: ${z(n,e)},`):t.push(`${r}?: ${z(n,e)},`);return t.map(r=>" ".repeat(e)+r).join(`
`)}function z(a,e){if(X(a))return a.anyOf.map(t=>z(t,e)).join(" | ");switch(a.type){case"string":return a.enum?a.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return a.enum?a.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return a.enum?a.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",R(a,e+2),"}"].join(`
`);case"array":return a.items?`${z(a.items,e)}[]`:"any[]";default:return""}}function fe(a){return a.role!=="system"&&a.role!=="assistant"&&a.role!=="user"&&a.role!=="function"&&a.role!=="tool"&&console.warn(`Unknown message role: ${a.role}`),a.role}function S(a){let e=a._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!B.isInstance(a))throw new Error("Invalid generic chat message");return fe(a)}default:throw new Error(`Unknown message type: ${e}`)}}function be(a,e,t){let r=a.tool_calls;switch(a.role){case"assistant":{let n=[],i=[];for(let u of r??[])try{n.push(he(u,{returnId:!0}))}catch(p){i.push(me(u,p.message))}let o={function_call:a.function_call,tool_calls:r};t!==void 0&&(o.__raw_response=e);let s;return e.system_fingerprint&&(s={system_fingerprint:e.system_fingerprint}),new te({content:a.content||"",tool_calls:n,invalid_tool_calls:i,additional_kwargs:o,response_metadata:s,id:e.id})}default:return new B(a.content||"",a.role??"unknown")}}function de(a,e,t,r){let n=a.role??t,i=a.content??"",o;if(a.function_call?o={function_call:a.function_call}:a.tool_calls?o={tool_calls:a.tool_calls}:o={},r&&(o.__raw_response=e),n==="user")return new ie({content:i});if(n==="assistant"){let s=[];if(Array.isArray(a.tool_calls))for(let u of a.tool_calls)s.push({name:u.function?.name,args:u.function?.arguments,id:u.id,index:u.index,type:"tool_call_chunk"});return new q({content:i,tool_call_chunks:s,additional_kwargs:o,id:e.id})}else return n==="system"?new ae({content:i}):n==="function"?new ne({content:i,additional_kwargs:o,name:a.name}):n==="tool"?new oe({content:i,additional_kwargs:o,tool_call_id:a.tool_call_id}):new re({content:i,role:n})}function L(a){return a.map(e=>{let t={role:S(e),content:e.content};return e.name!=null&&(t.name=e.name),e.additional_kwargs.function_call!=null&&(t.function_call=e.additional_kwargs.function_call,t.content=null),V(e)&&e.tool_calls?.length?(t.tool_calls=e.tool_calls.map(ce),t.content=null):(e.additional_kwargs.tool_calls!=null&&(t.tool_calls=e.additional_kwargs.tool_calls),e.tool_call_id!=null&&(t.tool_call_id=e.tool_call_id)),t})}var w=class extends se{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??_("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??_("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??_("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??_("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??_("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??_("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??_("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){return this.bind({tools:e.map(x),...t})}invocationParams(e,t){function r(o){return o!==void 0&&o.every(s=>Array.isArray(s.lc_namespace))}let n={};return e?.stream_options!==void 0?n={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(n={stream_options:{include_usage:!0}}),{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:r(e?.tools)?e?.tools.map(x):e?.tools,tool_choice:K(e?.tool_choice),response_format:e?.response_format,seed:e?.seed,...n,parallel_tool_calls:e?.parallel_tool_calls,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){let n=L(e),i={...this.invocationParams(t,{streaming:!0}),messages:n,stream:!0},o,s=await this.completionWithRetry(i,t),u;for await(let p of s){let l=p?.choices[0];if(p.usage&&(u=p.usage),!l)continue;let{delta:h}=l;if(!h)continue;let c=de(h,p,o,this.__includeRawResponse);o=h.role??o;let A={prompt:t.promptIndex??0,completion:l.index??0};if(typeof c.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let m={...A};l.finish_reason!==void 0&&(m.finish_reason=l.finish_reason,m.system_fingerprint=p.system_fingerprint),this.logprobs&&(m.logprobs=l.logprobs);let f=new C({message:c,text:c.content,generationInfo:m});yield f,await r?.handleLLMNewToken(f.text??"",A,void 0,void 0,void 0,{chunk:f})}if(u&&(yield new C({message:new q({content:"",usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens}}),text:""})),t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let n={},i=this.invocationParams(t),o=L(e);if(i.stream){let s=this._streamResponseChunks(e,t,r),u={};for await(let m of s){m.message.response_metadata={...m.generationInfo,...m.message.response_metadata};let f=m.generationInfo?.completion??0;u[f]===void 0?u[f]=m:u[f]=u[f].concat(m)}let p=Object.entries(u).sort(([m],[f])=>parseInt(m,10)-parseInt(f,10)).map(([m,f])=>f),{functions:l,function_call:h}=this.invocationParams(t),c=await this.getEstimatedTokenCountFromPrompt(e,l,h),A=await this.getNumTokensFromGenerations(p);return n.promptTokens=c,n.completionTokens=A,n.totalTokens=c+A,{generations:p,llmOutput:{estimatedTokenUsage:n}}}else{let s=await this.completionWithRetry({...i,stream:!1,messages:o},{signal:t?.signal,...t?.options}),{completion_tokens:u,prompt_tokens:p,total_tokens:l}=s?.usage??{};u&&(n.completionTokens=(n.completionTokens??0)+u),p&&(n.promptTokens=(n.promptTokens??0)+p),l&&(n.totalTokens=(n.totalTokens??0)+l);let h=[];for(let c of s?.choices??[]){let m={text:c.message?.content??"",message:be(c.message??{role:"assistant"},s,this.__includeRawResponse)};m.generationInfo={...c.finish_reason?{finish_reason:c.finish_reason}:{},...c.logprobs?{logprobs:c.logprobs}:{}},V(m.message)&&(m.message.usage_metadata={input_tokens:n.promptTokens??0,output_tokens:n.completionTokens??0,total_tokens:n.totalTokens??0}),h.push(m)}return{generations:h,llmOutput:{tokenUsage:n}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let n=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){let i=j(t);n+=await this.getNumTokens(i),n+=9}return t&&e.find(i=>i._getType()==="system")&&(n-=4),r==="none"?n+=1:typeof r=="object"&&(n+=await this.getNumTokens(r.name)+4),n}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>r.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)))).reduce((r,n)=>r+n,0)}async getNumTokensFromMessages(e){let t=0,r=0,n=0;this.model==="gpt-3.5-turbo-0301"?(r=4,n=-1):(r=3,n=1);let i=await Promise.all(e.map(async o=>{let s=await this.getNumTokens(o.content),u=await this.getNumTokens(S(o)),p=o.name!==void 0?n+await this.getNumTokens(o.name):0,l=s+r+u+p,h=o;if(h._getType()==="function"&&(l-=2),h.additional_kwargs?.function_call&&(l+=3),h?.additional_kwargs.function_call?.name&&(l+=await this.getNumTokens(h.additional_kwargs.function_call?.name)),h.additional_kwargs.function_call?.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse(h.additional_kwargs.function_call?.arguments)))}catch(c){console.error("Error parsing function arguments",c,JSON.stringify(h.additional_kwargs.function_call)),l+=await this.getNumTokens(h.additional_kwargs.function_call?.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(n){throw y(n)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},n=b(r),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new ee(i)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let r,n,i,o;ye(e)?(r=e.schema,n=e.name,i=e.method,o=e.includeRaw):(r=e,n=t?.name,i=t?.method,o=t?.includeRaw);let s,u;if(i==="jsonMode")s=this.bind({response_format:{type:"json_object"}}),M(r)?u=le.fromZodSchema(r):u=new pe;else{let c=n??"extract";if(M(r)){let A=Ae(r);s=this.bind({tools:[{type:"function",function:{name:c,description:A.description,parameters:A}}],tool_choice:{type:"function",function:{name:c}}}),u=new D({returnSingle:!0,keyName:c,zodSchema:r})}else{let A;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(A=r,c=r.name):(c=r.title??c,A={name:c,description:r.description??"",parameters:r}),s=this.bind({tools:[{type:"function",function:A}],tool_choice:{type:"function",function:{name:c}}}),u=new D({returnSingle:!0,keyName:c})}}if(!o)return s.pipe(u);let p=U.assign({parsed:(c,A)=>u.invoke(c.raw,A)}),l=U.assign({parsed:()=>null}),h=p.withFallbacks({fallbacks:[l]});return ue.from([{raw:s},h])}};function M(a){return typeof a?.parse=="function"}function ye(a){return a!==void 0&&typeof a.schema=="object"}import{AzureOpenAI as ge}from"/v135/openai@4.53.0/denonext/openai.mjs";var Z=class extends w{_llmType(){return"azure_openai"}get lc_aliases(){return{openAIApiKey:"openai_api_key",openAIApiVersion:"openai_api_version",openAIBasePath:"openai_api_base"}}constructor(e){let t=e&&{...e};t&&(t.azureOpenAIApiDeploymentName=t.azureOpenAIApiDeploymentName??t.deploymentName,t.azureOpenAIApiKey=t.azureOpenAIApiKey??t.openAIApiKey,t.azureOpenAIApiVersion=t.azureOpenAIApiVersion??t.openAIApiVersion),super(t)}getLsParams(e){let t=super.getLsParams(e);return t.ls_provider="azure",t}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL},n=b(r),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=r.azureOpenAIApiKey),i.baseURL||delete i.baseURL,i.defaultHeaders={...i.defaultHeaders,"User-Agent":i.defaultHeaders?.["User-Agent"]?`${i.defaultHeaders["User-Agent"]}: langchainjs-azure-openai-v2`:"langchainjs-azure-openai-v2"},this.client=new ge({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,deployment:this.azureOpenAIApiDeploymentName,...i})}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}toJSON(){let e=super.toJSON();function t(r){return typeof r=="object"&&r!=null}return t(e)&&t(e.kwargs)&&(delete e.kwargs.azure_openai_base_path,delete e.kwargs.azure_openai_api_deployment_name,delete e.kwargs.azure_openai_api_key,delete e.kwargs.azure_openai_api_version,delete e.kwargs.azure_open_ai_base_path),e}};import{OpenAI as Pe}from"/v135/openai@4.53.0/denonext/openai.mjs";import{calculateMaxTokens as ze}from"/v135/@langchain/core@0.2.18/denonext/language_models/base.js";import{GenerationChunk as we}from"/v135/@langchain/core@0.2.18/denonext/outputs.js";import{getEnvironmentVariable as O}from"/v135/@langchain/core@0.2.18/denonext/utils/env.js";import{BaseLLM as ve}from"/v135/@langchain/core@0.2.18/denonext/language_models/llms.js";import{chunkArray as F}from"/v135/@langchain/core@0.2.18/denonext/utils/chunk_array.js";import{OpenAI as Oe}from"/v135/openai@4.53.0/denonext/openai.mjs";import{GenerationChunk as Ie}from"/v135/@langchain/core@0.2.18/denonext/outputs.js";import{getEnvironmentVariable as g}from"/v135/@langchain/core@0.2.18/denonext/utils/env.js";import{LLM as _e}from"/v135/@langchain/core@0.2.18/denonext/language_models/llms.js";var v=class extends _e{static lc_name(){return"OpenAIChat"}get callKeys(){return[...super.callKeys,"options","promptIndex"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"prefixMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??g("OPENAI_API_KEY"),this.azureOpenAIApiKey=e?.azureOpenAIApiKey??g("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??g("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??(g("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||g("AZURE_OPENAI_API_DEPLOYMENT_NAME")),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??g("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??g("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??g("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.modelName,this.prefixMessages=e?.prefixMessages??this.prefixMessages,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.maxTokens=e?.maxTokens,this.stop=e?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.n>1)throw new Error("Cannot use n > 1 in OpenAIChat LLM. Use ChatOpenAI Chat Model instead.");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}invocationParams(e){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,logit_bias:this.logitBias,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,stop:e?.stop??this.stop,user:this.user,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}formatMessages(e){let t={role:"user",content:e};return this.prefixMessages?[...this.prefixMessages,t]:[t]}async*_streamResponseChunks(e,t,r){let n={...this.invocationParams(t),messages:this.formatMessages(e),stream:!0},i=await this.completionWithRetry(n,t);for await(let o of i){let s=o?.choices[0];if(!s)continue;let{delta:u}=s,p=new Ie({text:u.content??""});yield p;let l={prompt:t.promptIndex??0,completion:s.index??0};r?.handleLLMNewToken(p.text??"",l)}if(t.signal?.aborted)throw new Error("AbortError")}async _call(e,t,r){let n=this.invocationParams(t);if(n.stream){let i=await this._streamResponseChunks(e,t,r),o;for await(let s of i)o===void 0?o=s:o=o.concat(s);return o?.text??""}else return(await this.completionWithRetry({...n,stream:!1,messages:this.formatMessages(e)},{signal:t.signal,...t.options}))?.choices[0]?.message?.content??""}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(n){throw y(n)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},n=b(r),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new Oe(i)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}};var N=class extends ve{static lc_name(){return"OpenAI"}get callKeys(){return[...super.callKeys,"options"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){let r=e?.model??e?.modelName;if((r?.startsWith("gpt-3.5-turbo")||r?.startsWith("gpt-4"))&&!r?.includes("-instruct"))return console.warn([`Your chosen OpenAI model, "${r}", is a chat model and not a text-in/text-out LLM.`,'Passing it into the "OpenAI" class is deprecated and only permitted for backwards-compatibility. You may experience odd behavior.','Please use the "ChatOpenAI" class instead.',"","See this page for more information:","|","\u2514> https://js.langchain.com/v0.2/docs/integrations/chat/openai"].join(`
`)),new v(e,t);if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"bestOf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo-instruct"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo-instruct"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),r=r??this.model,this.openAIApiKey=e?.apiKey??e?.openAIApiKey??O("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??O("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??O("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??(O("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||O("AZURE_OPENAI_API_DEPLOYMENT_NAME")),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??O("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??O("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??O("OPENAI_ORGANIZATION"),this.modelName=r,this.model=r,this.modelKwargs=e?.modelKwargs??{},this.batchSize=e?.batchSize??this.batchSize,this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.maxTokens=e?.maxTokens??this.maxTokens,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.bestOf=e?.bestOf??this.bestOf,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=e?.stopSequences,this.user=e?.user,this.streaming=e?.streaming??!1,this.streaming&&this.bestOf&&this.bestOf>1)throw new Error("Cannot stream results when bestOf > 1");if(this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??""}this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}invocationParams(e){return{model:this.model,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,best_of:this.bestOf,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let n=F(e,this.batchSize),i=[],o={},s=this.invocationParams(t);if(s.max_tokens===-1){if(e.length!==1)throw new Error("max_tokens set to -1 not supported for multiple inputs");s.max_tokens=await ze({prompt:e[0],modelName:this.model})}for(let p=0;p<n.length;p+=1){let l=s.stream?await(async()=>{let m=[],f,W=await this.completionWithRetry({...s,stream:!0,prompt:n[p]},t);for await(let P of W){f||(f={id:P.id,object:P.object,created:P.created,model:P.model});for(let d of P.choices){if(!m[d.index])m[d.index]=d;else{let E=m[d.index];E.text+=d.text,E.finish_reason=d.finish_reason,E.logprobs=d.logprobs}r?.handleLLMNewToken(d.text,{prompt:Math.floor(d.index/this.n),completion:d.index%this.n})}}if(t.signal?.aborted)throw new Error("AbortError");return{...f,choices:m}})():await this.completionWithRetry({...s,stream:!1,prompt:n[p]},{signal:t.signal,...t.options});i.push(...l.choices);let{completion_tokens:h,prompt_tokens:c,total_tokens:A}=l.usage?l.usage:{completion_tokens:void 0,prompt_tokens:void 0,total_tokens:void 0};h&&(o.completionTokens=(o.completionTokens??0)+h),c&&(o.promptTokens=(o.promptTokens??0)+c),A&&(o.totalTokens=(o.totalTokens??0)+A)}return{generations:F(i,this.n).map(p=>p.map(l=>({text:l.text??"",generationInfo:{finishReason:l.finish_reason,logprobs:l.logprobs}}))),llmOutput:{tokenUsage:o}}}async*_streamResponseChunks(e,t,r){let n={...this.invocationParams(t),prompt:e,stream:!0},i=await this.completionWithRetry(n,t);for await(let o of i){let s=o?.choices[0];if(!s)continue;let u=new we({text:s.text,generationInfo:{finishReason:s.finish_reason}});yield u,r?.handleLLMNewToken(u.text??"")}if(t.signal?.aborted)throw new Error("AbortError")}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.completions.create(e,r)}catch(n){throw y(n)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},n=b(r),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new Pe(i)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}};import{AzureOpenAI as Ne}from"/v135/openai@4.53.0/denonext/openai.mjs";var Y=class extends N{get lc_aliases(){return{openAIApiKey:"openai_api_key",openAIApiVersion:"openai_api_version",openAIBasePath:"openai_api_base"}}constructor(e){let t=e&&{...e};t&&(t.azureOpenAIApiDeploymentName=t.azureOpenAIApiDeploymentName??t.deploymentName,t.azureOpenAIApiKey=t.azureOpenAIApiKey??t.openAIApiKey,t.azureOpenAIApiVersion=t.azureOpenAIApiVersion??t.openAIApiVersion),super(t)}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL},n=b(r),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=r.azureOpenAIApiKey),i.baseURL||delete i.baseURL,i.defaultHeaders={...i.defaultHeaders,"User-Agent":i.defaultHeaders?.["User-Agent"]?`${i.defaultHeaders["User-Agent"]}: langchainjs-azure-openai-v2`:"langchainjs-azure-openai-v2"},this.client=new Ne({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,...i})}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}toJSON(){let e=super.toJSON();function t(r){return typeof r=="object"&&r!=null}return t(e)&&t(e.kwargs)&&(delete e.kwargs.azure_openai_base_path,delete e.kwargs.azure_openai_api_deployment_name,delete e.kwargs.azure_openai_api_key,delete e.kwargs.azure_openai_api_version,delete e.kwargs.azure_open_ai_base_path),e}};import{AzureOpenAI as Ke}from"/v135/openai@4.53.0/denonext/openai.mjs";import{OpenAI as ke}from"/v135/openai@4.53.0/denonext/openai.mjs";import{getEnvironmentVariable as I}from"/v135/@langchain/core@0.2.18/denonext/utils/env.js";import{Embeddings as Ee}from"/v135/@langchain/core@0.2.18/denonext/embeddings.js";import{chunkArray as Te}from"/v135/@langchain/core@0.2.18/denonext/utils/chunk_array.js";var k=class extends Ee{constructor(e,t){let r={maxConcurrency:2,...e};super(r),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"dimensions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let n=r?.apiKey??r?.openAIApiKey??I("OPENAI_API_KEY"),i=r?.azureOpenAIApiKey??I("AZURE_OPENAI_API_KEY");if(this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!i&&!n&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");let o=r?.azureOpenAIApiInstanceName??I("AZURE_OPENAI_API_INSTANCE_NAME"),s=(r?.azureOpenAIApiEmbeddingsDeploymentName||r?.azureOpenAIApiDeploymentName)??(I("AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME")||I("AZURE_OPENAI_API_DEPLOYMENT_NAME")),u=r?.azureOpenAIApiVersion??I("AZURE_OPENAI_API_VERSION");if(this.azureOpenAIBasePath=r?.azureOpenAIBasePath??I("AZURE_OPENAI_BASE_PATH"),this.organization=r?.configuration?.organization??I("OPENAI_ORGANIZATION"),this.modelName=r?.model??r?.modelName??this.model,this.model=this.modelName,this.batchSize=r?.batchSize??(i?1:this.batchSize),this.stripNewLines=r?.stripNewLines??this.stripNewLines,this.timeout=r?.timeout,this.dimensions=r?.dimensions,this.azureOpenAIApiVersion=u,this.azureOpenAIApiKey=i,this.azureOpenAIApiInstanceName=o,this.azureOpenAIApiDeploymentName=s,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");n=n??""}this.clientConfig={apiKey:n,organization:this.organization,baseURL:t?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params,...t,...e?.configuration}}async embedDocuments(e){let t=Te(this.stripNewLines?e.map(o=>o.replace(/\n/g," ")):e,this.batchSize),r=t.map(o=>{let s={model:this.model,input:o};return this.dimensions&&(s.dimensions=this.dimensions),this.embeddingWithRetry(s)}),n=await Promise.all(r),i=[];for(let o=0;o<n.length;o+=1){let s=t[o],{data:u}=n[o];for(let p=0;p<s.length;p+=1)i.push(u[p].embedding)}return i}async embedQuery(e){let t={model:this.model,input:this.stripNewLines?e.replace(/\n/g," "):e};this.dimensions&&(t.dimensions=this.dimensions);let{data:r}=await this.embeddingWithRetry(t);return r[0].embedding}async embeddingWithRetry(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},n=b(r),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new ke(i)}let t={};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),this.caller.call(async()=>{try{return await this.client.embeddings.create(e,t)}catch(r){throw y(r)}})}};var $=class extends k{constructor(e,t){let r={...e};Object.entries(r).length&&(r.azureOpenAIApiDeploymentName=r.azureOpenAIApiDeploymentName??r.deploymentName,r.azureOpenAIApiKey=r.azureOpenAIApiKey??r.apiKey,r.azureOpenAIApiVersion=r.azureOpenAIApiVersion??r.openAIApiVersion),super(r,t)}async embeddingWithRetry(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,azureADTokenProvider:this.azureADTokenProvider,baseURL:this.clientConfig.baseURL},n=b(r),i={...this.clientConfig,baseURL:n,timeout:this.timeout,maxRetries:0};this.azureADTokenProvider||(i.apiKey=r.azureOpenAIApiKey),i.baseURL||delete i.baseURL,i.defaultHeaders={...i.defaultHeaders,"User-Agent":i.defaultHeaders?.["User-Agent"]?`${i.defaultHeaders["User-Agent"]}: langchainjs-azure-openai-v2`:"langchainjs-azure-openai-v2"},this.client=new Ke({apiVersion:this.azureOpenAIApiVersion,azureADTokenProvider:this.azureADTokenProvider,deployment:this.azureOpenAIApiDeploymentName,...i})}let t={};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),this.caller.call(async()=>{try{return await this.client.embeddings.create(e,t)}catch(r){throw y(r)}})}};import{getEnvironmentVariable as H}from"/v135/@langchain/core@0.2.18/denonext/utils/env.js";import{OpenAI as je}from"/v135/openai@4.53.0/denonext/openai.mjs";import{Tool as Re}from"/v135/@langchain/core@0.2.18/denonext/tools.js";var T=class extends Re{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=e?.apiKey??e?.openAIApiKey??H("OPENAI_API_KEY"),r=e?.organization??H("OPENAI_ORGANIZATION"),n={apiKey:t,organization:r,dangerouslyAllowBrowser:!0};this.client=new je(n),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return this.dallEResponseFormat==="url"?e.flatMap(t=>t.data.flatMap(n=>n.url?{type:"image_url",image_url:n.url}:[]).filter(n=>n!==void 0&&n.type==="image_url"&&typeof n.image_url=="string"&&n.image_url!==void 0)):e.flatMap(t=>t.data.flatMap(n=>n.b64_json?{type:"image_url",image_url:{url:n.b64_json}}:[]).filter(n=>n!==void 0&&n.type==="image_url"&&typeof n.image_url=="object"&&"url"in n.image_url&&typeof n.image_url.url=="string"&&n.image_url.url!==void 0))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let i=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(i)}let r=await this.client.images.generate(t),n="";return this.dallEResponseFormat==="url"?[n]=r.data.map(i=>i.url).filter(i=>i!=="undefined"):[n]=r.data.map(i=>i.b64_json).filter(i=>i!=="undefined"),n}};Object.defineProperty(T,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});export{Z as AzureChatOpenAI,Y as AzureOpenAI,$ as AzureOpenAIEmbeddings,w as ChatOpenAI,T as DallEAPIWrapper,N as OpenAI,v as OpenAIChat,Ht as OpenAIClient,k as OpenAIEmbeddings,qe as formatToOpenAIAssistantTool,Le as formatToOpenAIFunction,Me as formatToOpenAITool,K as formatToOpenAIToolChoice,b as getEndpoint,S as messageToOpenAIRole,Wt as toFile,y as wrapOpenAIClientError};
//# sourceMappingURL=openai.mjs.map