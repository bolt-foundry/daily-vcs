/* esm.sh - esbuild bundle(@langchain/core@0.2.18/output_parsers) denonext production */
import __Process$ from "node:process";
var un=Object.defineProperty;var ln=(n,e)=>{for(var t in e)un(n,t,{get:e[t],enumerable:!0})};import{z as Xe}from"/v135/zod@3.23.8/denonext/zod.mjs";import Br from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import{v4 as Un}from"/v135/uuid@10.0.0/denonext/uuid.mjs";import{isTraceableFunction as tr}from"/v135/langsmith@0.1.39/denonext/singletons/traceable.js";var kt={};ln(kt,{JsonPatchError:()=>x,_areEquals:()=>Me,applyOperation:()=>we,applyPatch:()=>me,applyReducer:()=>hn,deepClone:()=>dn,getValueByPointer:()=>ot,validate:()=>mr,validator:()=>ut});var cn=Object.prototype.hasOwnProperty;function at(n,e){return cn.call(n,e)}function it(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)at(n,t)&&e.push(t);return e}function L(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function st(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function ae(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function Re(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function nt(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(nt(n[t]))return!0}else if(typeof n=="object"){let t=it(n),r=t.length;for(var e=0;e<r;e++)if(nt(n[t[e]]))return!0}}return!1}function hr(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var ye=class extends Error{constructor(e,t,r,a,i){super(hr(e,{name:t,index:r,operation:a,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=hr(e,{name:t,index:r,operation:a,tree:i})}};var x=ye,dn=L,Oe={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=ot(t,this.path);r&&(r=L(r));let a=we(t,{op:"remove",path:this.from}).removed;return we(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=ot(t,this.from);return we(t,{op:"add",path:this.path,value:L(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Me(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},fn={add:function(n,e,t){return st(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Oe.move,copy:Oe.copy,test:Oe.test,_get:Oe._get};function ot(n,e){if(e=="")return n;var t={op:"_get",path:e};return we(n,t),t.value}function we(n,e,t=!1,r=!0,a=!0,i=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):ut(e,0)),e.path===""){let o={newDocument:n};if(e.op==="add")return o.newDocument=e.value,o;if(e.op==="replace")return o.newDocument=e.value,o.removed=n,o;if(e.op==="move"||e.op==="copy")return o.newDocument=ot(n,e.from),e.op==="move"&&(o.removed=n),o;if(e.op==="test"){if(o.test=Me(n,e.value),o.test===!1)throw new x("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return o.newDocument=n,o}else{if(e.op==="remove")return o.removed=n,o.newDocument=null,o;if(e.op==="_get")return e.value=n,o;if(t)throw new x("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,n);return o}}else{r||(n=L(n));let l=(e.path||"").split("/"),c=n,d=1,p=l.length,b,m,y;for(typeof t=="function"?y=t:y=ut;;){if(m=l[d],m&&m.indexOf("~")!=-1&&(m=Re(m)),a&&(m=="__proto__"||m=="prototype"&&d>0&&l[d-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&b===void 0&&(c[m]===void 0?b=l.slice(0,d).join("/"):d==p-1&&(b=e.path),b!==void 0&&y(e,0,n,b)),d++,Array.isArray(c)){if(m==="-")m=c.length;else{if(t&&!st(m))throw new x("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,n);st(m)&&(m=~~m)}if(d>=p){if(t&&e.op==="add"&&m>c.length)throw new x("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,n);let T=fn[e.op].call(e,c,m,n);if(T.test===!1)throw new x("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return T}}else if(d>=p){let T=Oe[e.op].call(e,c,m,n);if(T.test===!1)throw new x("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return T}if(c=c[m],t&&d<p&&(!c||typeof c!="object"))throw new x("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,n)}}}function me(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new x("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=L(n));let i=new Array(e.length);for(let o=0,l=e.length;o<l;o++)i[o]=we(n,e[o],t,!0,a,o),n=i[o].newDocument;return i.newDocument=n,i}function hn(n,e,t){let r=we(n,e);if(r.test===!1)throw new x("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function ut(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new x("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Oe[n.op]){if(typeof n.path!="string")throw new x("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new x('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new x("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new x("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&nt(n.value))throw new x("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,i=r.split("/").length;if(a!==i+1&&a!==i)throw new x("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new x("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var o={op:"_get",path:n.from,value:void 0},l=mr([o],t);if(l&&l.name==="OPERATION_PATH_UNRESOLVABLE")throw new x("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new x("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function mr(n,e,t){try{if(!Array.isArray(n))throw new x("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)me(L(e),L(n),t||!0);else{t=t||ut;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof x)return a;throw a}}function Me(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,i,o;if(t&&r){if(i=n.length,i!=e.length)return!1;for(a=i;a--!==0;)if(!Me(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var l=Object.keys(n);if(i=l.length,i!==Object.keys(e).length)return!1;for(a=i;a--!==0;)if(!e.hasOwnProperty(l[a]))return!1;for(a=i;a--!==0;)if(o=l[a],!Me(n[o],e[o]))return!1;return!0}return n!==n&&e!==e}function pr(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=it(e),o=it(n),l=!1,c=!1,d=o.length-1;d>=0;d--){var p=o[d],b=n[p];if(at(e,p)&&!(e[p]===void 0&&b!==void 0&&Array.isArray(e)===!1)){var m=e[p];typeof b=="object"&&b!=null&&typeof m=="object"&&m!=null&&Array.isArray(b)===Array.isArray(m)?pr(b,m,t,r+"/"+ae(p),a):b!==m&&(l=!0,a&&t.push({op:"test",path:r+"/"+ae(p),value:L(b)}),t.push({op:"replace",path:r+"/"+ae(p),value:L(m)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+ae(p),value:L(b)}),t.push({op:"remove",path:r+"/"+ae(p)}),c=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),l=!0)}if(!(!c&&i.length==o.length))for(var d=0;d<i.length;d++){var p=i[d];!at(n,p)&&e[p]!==void 0&&t.push({op:"add",path:r+"/"+ae(p),value:L(e[p])})}}}function je(n,e,t=!1){var r=[];return pr(n,e,r,"",t),r}var $a={...kt,JsonPatchError:ye,deepClone:L,escapePathComponent:ae,unescapePathComponent:Re};import*as vr from"/v135/uuid@10.0.0/denonext/uuid.mjs";import mn from"/v135/decamelize@1.2.0/denonext/decamelize.mjs";import Ba from"/v135/camelcase@6.3.0/denonext/camelcase.mjs";function gr(n,e){return e?.[n]||mn(n)}function br(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function yr(n){return Array.isArray(n)?[...n]:{...n}}function pn(n,e){let t=yr(n);for(let[r,a]of Object.entries(e)){let[i,...o]=r.split(".").reverse(),l=t;for(let c of o.reverse()){if(l[c]===void 0)break;l[c]=yr(l[c]),l=l[c]}l[i]!==void 0&&(l[i]={lc:1,type:"secret",id:[a]})}return t}function St(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var ue=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,St(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,i)=>(a[i]=i in this?this[i]:this.lc_kwargs[i],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let i=this,o=r,[l,...c]=a.split(".").reverse();for(let d of c.reverse()){if(!(d in i)||i[d]===void 0)return;(!(d in o)||o[d]===void 0)&&(typeof i[d]=="object"&&i[d]!=null?o[d]={}:Array.isArray(i[d])&&(o[d]=[])),i=i[d],o=o[d]}l in i&&i[l]!==void 0&&(o[l]=o[l]||i[l])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:br(Object.keys(t).length?pn(r,t):r,gr,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};var gn=()=>typeof window<"u"&&typeof window.document<"u",bn=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",yn=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),wr=()=>typeof Deno<"u",wn=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!wr(),_n=()=>{let n;return gn()?n="browser":wn()?n="node":bn()?n="webworker":yn()?n="jsdom":wr()?n="deno":n="other",n},Pt;async function _r(){return Pt===void 0&&(Pt={library:"langchain-js",runtime:_n()}),Pt}function X(n){try{return typeof __Process$<"u"?__Process$.env?.[n]:void 0}catch{return}}var Ct=class{},_e=class n extends Ct{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,St(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:X("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return ue.prototype.toJSON.call(this)}toJSONNotImplemented(){return ue.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:vr.v4()}),Object.assign(this,e)}}return new t}};function $t(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function vn(n){return n.replace(/[-:.]/g,"")}function Tn(n,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return vn(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}function Ie(n){return typeof n._addRunToRunMap=="function"}var Y=class extends _e{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let t=Tn(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,i,o,l,c){let d=this._getExecutionOrder(a),p=Date.now(),b=l?{...i,metadata:l}:i,m={id:r,name:c??e.id[e.id.length-1],parent_run_id:a,start_time:p,serialized:e,events:[{name:"start",time:new Date(p).toISOString()}],inputs:{prompts:t},execution_order:d,child_runs:[],child_execution_order:d,run_type:"llm",extra:b??{},tags:o||[]};return this._addRunToRunMap(m)}async handleLLMStart(e,t,r,a,i,o,l,c){let d=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,a,i,o,l,c);return await this.onRunCreate?.(d),await this.onLLMStart?.(d),d}_createRunForChatModelStart(e,t,r,a,i,o,l,c){let d=this._getExecutionOrder(a),p=Date.now(),b=l?{...i,metadata:l}:i,m={id:r,name:c??e.id[e.id.length-1],parent_run_id:a,start_time:p,serialized:e,events:[{name:"start",time:new Date(p).toISOString()}],inputs:{messages:t},execution_order:d,child_runs:[],child_execution_order:d,run_type:"llm",extra:b??{},tags:o||[]};return this._addRunToRunMap(m)}async handleChatModelStart(e,t,r,a,i,o,l,c){let d=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,a,i,o,l,c);return await this.onRunCreate?.(d),await this.onLLMStart?.(d),d}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onLLMEnd?.(r),await this._endTrace(r),r}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onLLMError?.(r),await this._endTrace(r),r}_createRunForChainStart(e,t,r,a,i,o,l,c){let d=this._getExecutionOrder(a),p=Date.now(),b={id:r,name:c??e.id[e.id.length-1],parent_run_id:a,start_time:p,serialized:e,events:[{name:"start",time:new Date(p).toISOString()}],inputs:t,execution_order:d,child_execution_order:d,run_type:l??"chain",child_runs:[],extra:o?{metadata:o}:{},tags:i||[]};return this._addRunToRunMap(b)}async handleChainStart(e,t,r,a,i,o,l,c){let d=this.runMap.get(r)??this._createRunForChainStart(e,t,r,a,i,o,l,c);return await this.onRunCreate?.(d),await this.onChainStart?.(d),d}async handleChainEnd(e,t,r,a,i){let o=this.runMap.get(t);if(!o)throw new Error("No chain run to end.");return o.end_time=Date.now(),o.outputs=$t(e,"output"),o.events.push({name:"end",time:new Date(o.end_time).toISOString()}),i?.inputs!==void 0&&(o.inputs=$t(i.inputs,"input")),await this.onChainEnd?.(o),await this._endTrace(o),o}async handleChainError(e,t,r,a,i){let o=this.runMap.get(t);if(!o)throw new Error("No chain run to end.");return o.end_time=Date.now(),o.error=this.stringifyError(e),o.events.push({name:"error",time:new Date(o.end_time).toISOString()}),i?.inputs!==void 0&&(o.inputs=$t(i.inputs,"input")),await this.onChainError?.(o),await this._endTrace(o),o}_createRunForToolStart(e,t,r,a,i,o,l){let c=this._getExecutionOrder(a),d=Date.now(),p={id:r,name:l??e.id[e.id.length-1],parent_run_id:a,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:{input:t},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:o?{metadata:o}:{},tags:i||[]};return this._addRunToRunMap(p)}async handleToolStart(e,t,r,a,i,o,l){let c=this.runMap.get(r)??this._createRunForToolStart(e,t,r,a,i,o,l);return await this.onRunCreate?.(c),await this.onToolStart?.(c),c}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(e,t,r,a,i,o,l){let c=this._getExecutionOrder(a),d=Date.now(),p={id:r,name:l??e.id[e.id.length-1],parent_run_id:a,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:{query:t},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:o?{metadata:o}:{},tags:i||[]};return this._addRunToRunMap(p)}async handleRetrieverStart(e,t,r,a,i,o,l){let c=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,a,i,o,l);return await this.onRunCreate?.(c),await this.onRetrieverStart?.(c),c}async handleRetrieverEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,i,o){let l=this.runMap.get(r);if(!l||l?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return l.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:o?.chunk}}),await this.onLLMNewToken?.(l,e,{chunk:o?.chunk}),l}};import{RunTree as Sn}from"/v135/langsmith@0.1.39/denonext/langsmith.mjs";import{v4 as Ne}from"/v135/uuid@10.0.0/denonext/uuid.mjs";import Tr from"/v135/ansi-styles@5.2.0/denonext/ansi-styles.mjs";function U(n,e){return`${n.open}${e}${n.close}`}function Q(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function pe(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:z}=Tr,De=class extends Y{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,i,o)=>{let l=`${a.execution_order}:${a.run_type}:${a.name}`;return i===o.length-1?U(Tr.bold,l):l}).join(" > ");return U(z.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Q(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.cyan,"[chain/end]")} [${t}] [${pe(e)}] Exiting Chain run with output: ${Q(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.red,"[chain/error]")} [${t}] [${pe(e)}] Chain run errored with error: ${Q(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${U(z.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Q(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.cyan,"[llm/end]")} [${t}] [${pe(e)}] Exiting LLM run with output: ${Q(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.red,"[llm/error]")} [${t}] [${pe(e)}] LLM run errored with error: ${Q(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.cyan,"[tool/end]")} [${t}] [${pe(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.red,"[tool/error]")} [${t}] [${pe(e)}] Tool run errored with error: ${Q(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Q(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.cyan,"[retriever/end]")} [${t}] [${pe(e)}] Exiting Retriever run with output: ${Q(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${U(z.red,"[retriever/error]")} [${t}] [${pe(e)}] Retriever run errored with error: ${Q(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${U(z.blue,"[agent/action]")} [${r}] Agent selected action: ${Q(t.actions[t.actions.length-1],"[action]")}`)}};function Rt(n,e=lt){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function lt(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="",t=[],r=!1,a=!1;for(let i of n){if(r)i==='"'&&!a?r=!1:i===`
`&&!a?i="\\n":i==="\\"?a=!a:a=!1;else if(i==='"')r=!0,a=!1;else if(i==="{")t.push("}");else if(i==="[")t.push("]");else if(i==="}"||i==="]")if(t&&t[t.length-1]===i)t.pop();else return null;e+=i}r&&(e+='"');for(let i=t.length-1;i>=0;i-=1)e+=t[i];try{return JSON.parse(e)}catch{return null}}function ee(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?ct(n,e)??[...n,...e]:[...n,{type:"text",text:e}]}function En(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(o=>t(o,a+1));let i={};for(let o of Object.keys(r))i[o]=t(r[o],a+1);return i}return JSON.stringify(t(n,0),null,2)}var Z=class extends ue{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=En(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};function C(n,e){let t={...n};for(let[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=C(t[r],a);else if(Array.isArray(t[r]))t[r]=ct(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function ct(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{let t=[...n];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let a=t.findIndex(i=>i.index===r.index);a!==-1?t[a]=C(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}var W=class extends Z{};function Le(n){return typeof n?._getType=="function"}function Er(n){return Le(n)&&typeof n.concat=="function"}var le=class n extends W{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{let r=[],a=[];for(let i of e.tool_call_chunks){let o={};try{if(o=lt(i.args??"{}")??{},typeof o!="object"||Array.isArray(o))throw new Error("Malformed tool call chunk args.");r.push({name:i.name??"",args:o,id:i.id,type:"tool_call"})}catch{a.push({name:i.name,args:i.args,id:i.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){let t={content:ee(this.content,e.content),additional_kwargs:C(this.additional_kwargs,e.additional_kwargs),response_metadata:C(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let r=ct(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i={input_tokens:r.input_tokens+a.input_tokens,output_tokens:r.output_tokens+a.output_tokens,total_tokens:r.total_tokens+a.total_tokens};t.usage_metadata=i}return new n(t)}};var Fe=class n extends Z{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},Be=class n extends W{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new n({content:ee(this.content,e.content),additional_kwargs:C(this.additional_kwargs,e.additional_kwargs),response_metadata:C(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}};var He=class n extends W{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new n({content:ee(this.content,e.content),additional_kwargs:C(this.additional_kwargs,e.additional_kwargs),response_metadata:C(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};var Ue=class n extends W{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new n({content:ee(this.content,e.content),additional_kwargs:C(this.additional_kwargs,e.additional_kwargs),response_metadata:C(this.response_metadata,e.response_metadata),id:this.id??e.id})}};var Ge=class n extends W{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new n({content:ee(this.content,e.content),additional_kwargs:C(this.additional_kwargs,e.additional_kwargs),response_metadata:C(this.response_metadata,e.response_metadata),id:this.id??e.id})}};function Ar(n,e="Human",t="AI"){let r=[];for(let a of n){let i;if(a._getType()==="human")i=e;else if(a._getType()==="ai")i=t;else if(a._getType()==="system")i="System";else if(a._getType()==="function")i="Function";else if(a._getType()==="tool")i="Tool";else if(a._getType()==="generic")i=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let o=a.name?`${a.name}, `:"",l=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${i}: ${o}${l}`)}return r.join(`
`)}function Mt(n){let e=n._getType();if(e==="human")return new Ue({...n});if(e==="ai"){let t={...n};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(r=>({...r,type:"tool_call_chunk",index:void 0,args:JSON.stringify(r.args)}))}),new le({...t})}else{if(e==="system")return new Ge({...n});if(e==="function")return new He({...n});if(Fe.isInstance(n))return new Be({...n});throw new Error("Unknown message type.")}}import{Client as In}from"/v135/langsmith@0.1.39/denonext/langsmith.mjs";import{RunTree as An}from"/v135/langsmith@0.1.39/denonext/run_trees.js";import{getCurrentRunTree as Nn}from"/v135/langsmith@0.1.39/denonext/singletons/traceable.js";var Ae=class n extends Y{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=r??X("LANGCHAIN_PROJECT")??X("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new In({});let i=n.getTraceableRunTree();i&&this.updateFromRunTree(i)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await _r()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e,r=new Set;for(;t.parent_run&&!(r.has(t.id)||(r.add(t.id),!t.parent_run));)t=t.parent_run;r.clear();let a=[t];for(;a.length>0;){let i=a.shift();!i||r.has(i.id)||(r.add(i.id),this.runMap.set(i.id,i),i.child_runs&&a.push(...i.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){let t={},r=[];for(let[a,i]of this.runMap){let o=new An({...i,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[a]=o,r.push([a,i.dotted_order])}r.sort((a,i)=>!a[1]||!i[1]?0:a[1].localeCompare(i[1]));for(let[a]of r){let i=this.runMap.get(a),o=t[a];if(!(!i||!o)&&i.parent_run_id){let l=t[i.parent_run_id];l&&(l.child_runs.push(o),o.parent_run=l)}}return t[e]}static getTraceableRunTree(){try{return Nn()}catch{return}}};import jt from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var Dt;function kn(){let n="default"in jt?jt.default:jt;return new n({autoStart:!0,concurrency:1})}async function S(n,e){e===!0?await n():(typeof Dt>"u"&&(Dt=kn()),Dt.add(n))}var Lt=n=>n!==void 0?n:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>X(t)==="true");Lt()&&X("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);var Ft=class{setHandler(e){return this.setHandlers([e])}},ke=class{constructor(e,t,r,a,i,o,l,c){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:c})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>S(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Bt=class extends ke{getChild(e){let t=new ie(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>S(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>S(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},dt=class extends ke{async handleLLMNewToken(e,t,r,a,i,o){await Promise.all(this.handlers.map(l=>S(async()=>{if(!l.ignoreLLM)try{await l.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,o)}catch(c){if(console.error(`Error in handler ${l.constructor.name}, handleLLMNewToken: ${c}`),l.raiseError)throw c}},l.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>S(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>S(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Ht=class extends ke{getChild(e){let t=new ie(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,i){await Promise.all(this.handlers.map(o=>S(async()=>{if(!o.ignoreChain)try{await o.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(l){if(console.error(`Error in handler ${o.constructor.name}, handleChainError: ${l}`),o.raiseError)throw l}},o.awaitHandlers)))}async handleChainEnd(e,t,r,a,i){await Promise.all(this.handlers.map(o=>S(async()=>{if(!o.ignoreChain)try{await o.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(l){if(console.error(`Error in handler ${o.constructor.name}, handleChainEnd: ${l}`),o.raiseError)throw l}},o.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>S(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>S(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},Ut=class extends ke{getChild(e){let t=new ie(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>S(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>S(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},ie=class n extends Ft{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,i=void 0,o=void 0,l=void 0,c=void 0){return Promise.all(t.map(async(d,p)=>{let b=p===0&&r?r:Ne();return await Promise.all(this.handlers.map(m=>{if(!m.ignoreLLM)return Ie(m)&&m._createRunForLLMStart(e,[d],b,this._parentRunId,i,this.tags,this.metadata,c),S(async()=>{try{await m.handleLLMStart?.(e,[d],b,this._parentRunId,i,this.tags,this.metadata,c)}catch(y){if(console.error(`Error in handler ${m.constructor.name}, handleLLMStart: ${y}`),m.raiseError)throw y}},m.awaitHandlers)})),new dt(b,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,i=void 0,o=void 0,l=void 0,c=void 0){return Promise.all(t.map(async(d,p)=>{let b=p===0&&r?r:Ne();return await Promise.all(this.handlers.map(m=>{if(!m.ignoreLLM)return Ie(m)&&m._createRunForChatModelStart(e,[d],b,this._parentRunId,i,this.tags,this.metadata,c),S(async()=>{try{if(m.handleChatModelStart)await m.handleChatModelStart?.(e,[d],b,this._parentRunId,i,this.tags,this.metadata,c);else if(m.handleLLMStart){let y=Ar(d);await m.handleLLMStart?.(e,[y],b,this._parentRunId,i,this.tags,this.metadata,c)}}catch(y){if(console.error(`Error in handler ${m.constructor.name}, handleLLMStart: ${y}`),m.raiseError)throw y}},m.awaitHandlers)})),new dt(b,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=Ne(),a=void 0,i=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreChain)return Ie(c)&&c._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,l),S(async()=>{try{await c.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,l)}catch(d){if(console.error(`Error in handler ${c.constructor.name}, handleChainStart: ${d}`),c.raiseError)throw d}},c.awaitHandlers)})),new Ht(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=Ne(),a=void 0,i=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreAgent)return Ie(c)&&c._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,l),S(async()=>{try{await c.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,l)}catch(d){if(console.error(`Error in handler ${c.constructor.name}, handleToolStart: ${d}`),c.raiseError)throw d}},c.awaitHandlers)})),new Ut(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=Ne(),a=void 0,i=void 0,o=void 0,l=void 0){return await Promise.all(this.handlers.map(c=>{if(!c.ignoreRetriever)return Ie(c)&&c._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,l),S(async()=>{try{await c.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,l)}catch(d){if(console.error(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${d}`),c.raiseError)throw d}},c.awaitHandlers)})),new Bt(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,i){await Promise.all(this.handlers.map(o=>S(async()=>{if(!o.ignoreCustomEvent)try{await o.handleCustomEvent?.(e,t,r,this.tags,this.metadata)}catch(l){if(console.error(`Error in handler ${o.constructor.name}, handleCustomEvent: ${l}`),o.raiseError)throw l}},o.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let i=this.inheritableHandlers.includes(a);r.addHandler(a,i)}for(let a of this.tags){let i=this.inheritableTags.includes(a);r.addTags([a],i)}for(let a of Object.keys(this.metadata)){let i=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},i)}for(let a of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends _e{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ne()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,i,o,l){return this._configureSync(e,t,r,a,i,o,l)}static _configureSync(e,t,r,a,i,o,l){let c;(e||t)&&(Array.isArray(e)||!e?(c=new n,c.setHandlers(e?.map(ze)??[],!0)):c=e,c=c.copy(Array.isArray(t)?t.map(ze):t?.handlers,!1));let d=X("LANGCHAIN_VERBOSE")==="true"||l?.verbose,p=Ae.getTraceableRunTree()?.tracingEnabled||Lt(),b=p||(X("LANGCHAIN_TRACING")??!1);if(d||b){if(c||(c=new n),d&&!c.handlers.some(m=>m.name===De.prototype.name)){let m=new De;c.addHandler(m,!0)}if(b&&!c.handlers.some(m=>m.name==="langchain_tracer")&&p){let m=new Ae;c.addHandler(m,!0),c._parentRunId=Ae.getTraceableRunTree()?.id??c._parentRunId}}return(r||a)&&c&&(c.addTags(r??[]),c.addTags(a??[],!1)),(i||o)&&c&&(c.addMetadata(i??{}),c.addMetadata(o??{},!1)),c}};function ze(n){return"name"in n?n:_e.fromMethods(n)}var zt=class{getStore(){}run(e,t){return t()}},Pn=new zt,Gt=Symbol.for("ls:tracing_async_local_storage"),Nr=Symbol.for("lc:child_config"),Jt=class{getInstance(){return globalThis[Gt]??Pn}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[Nr]}runWithConfig(e,t,r){let a=ie._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),i=this.getInstance(),o=a?.getParentRunId(),l=a?.handlers?.find(d=>d?.name==="langchain_tracer"),c;return l&&o?c=l.convertToRunTree(o):r||(c=new Sn({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[Nr]:e}),i.run(c,t)}initializeGlobalInstance(e){globalThis[Gt]===void 0&&(globalThis[Gt]=e)}},te=new Jt;var F=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:i,value:o})=>{if(i){r.close();return}return r.enqueue(o),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function Wt(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let i=await n.next();for(let o of t)o.push(i)}else{if(a[0].done)return;yield a.shift().value}})}function re(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=re(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var ce=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise((t,r)=>{te.runWithConfig(e.config,async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(a=>t(void 0),r)},!0)})}async next(...e){return this.firstResultUsed?te.runWithConfig(this.config,async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}};async function kr(n,e,t,...r){let a=new ce({generator:e,startSetup:t}),i=await a.setup;return{output:n(a,i,...r),setup:i}}var ne=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=me({},t);return new Je({ops:t,state:r[r.length-1].newDocument})}},Je=class n extends ne{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=me(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=me({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}},Cr=n=>n.name==="log_stream_tracer";async function Sr(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function Pr(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function Cn(n){return n!==void 0&&n.message!==void 0}var We=class extends Y{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=F.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new ne({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new ne({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Sr(e,this._schemaFormat)),await this.writer.write(new ne({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Sr(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await Pr(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new ne({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new ne({ops:[{op:"replace",path:"/final_output",value:await Pr(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let i=e.inputs.messages!==void 0,o;i?Cn(r?.chunk)?o=r?.chunk:o=new le(t):o=t;let l=new ne({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:o}]});await this.writer.write(l)}};var ge=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},qe=class n extends ge{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}};function ft({name:n,serialized:e}){return n!==void 0?n:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var $r=n=>n.name==="event_stream_tracer",ht=class extends Y{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=F.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}function i(l,c){return l==="llm"&&typeof c=="string"?new ge({text:c}):c}let o=this.tappedPromises.get(e);if(o===void 0){let l;o=new Promise(c=>{l=c}),this.tappedPromises.set(e,o);try{let c={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...c,data:{chunk:i(a.runType,r.value)}},a),yield r.value;for await(let d of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...c,data:{chunk:i(a.runType,d)}},a),yield d}finally{l()}}else{yield r.value;for await(let l of t)yield l}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=ft(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let i=`on_${r}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){let a=this.runInfoMap.get(e.id),i,o;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(e.parent_run_id!==void 0){if(a.runType==="chat_model")o="on_chat_model_stream",r?.chunk===void 0?i=new le({content:t}):i=r.chunk.message;else if(a.runType==="llm")o="on_llm_stream",r?.chunk===void 0?i=new ge({text:t}):i=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:o,data:{chunk:i},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let a=e.outputs?.generations,i;if(t.runType==="chat_model"){for(let o of a??[]){if(i!==void 0)break;i=o[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")i={generations:a?.map(o=>o.map(l=>({text:l.text,generationInfo:l.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:i,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=ft(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},a.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,a.inputs=e.inputs.input):(i.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},o={output:e.outputs?.output??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(o.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:o,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=ft(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=ft(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){let a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};var mt=25;async function q(n){return ie._configureSync(n?.callbacks,void 0,n?.tags,void 0,n?.metadata)}function pt(...n){let e={};for(let t of n.filter(r=>!!r))for(let r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){let a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="callbacks"){let a=e.callbacks,i=t.callbacks;if(Array.isArray(i))if(!a)e.callbacks=i;else if(Array.isArray(a))e.callbacks=a.concat(i);else{let o=a.copy();for(let l of i)o.addHandler(ze(l),!0);e.callbacks=o}else if(i)if(!a)e.callbacks=i;else if(Array.isArray(a)){let o=i.copy();for(let l of a)o.addHandler(ze(l),!0);e.callbacks=o}else e.callbacks=new ie(i._parentRunId,{handlers:a.handlers.concat(i.handlers),inheritableHandlers:a.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(i.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(i.inheritableTags))),metadata:{...a.metadata,...i.metadata}})}else{let a=r;e[a]=t[a]??e[a]}return e}var $n=new Set(["string","number","boolean"]);function _(n){let e=te.getRunnableConfig(),t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){let{runId:r,runName:a,...i}=e;t=Object.entries(i).reduce((o,[l,c])=>(c!==void 0&&(o[l]=c),o),t)}if(n&&(t=Object.entries(n).reduce((r,[a,i])=>(i!==void 0&&(r[a]=i),r),t)),t?.configurable)for(let r of Object.keys(t.configurable))$n.has(typeof t.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=t.configurable[r]);return t}function $(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:i,runId:o}={}){let l=_(n);return e!==void 0&&(delete l.runName,l.callbacks=e),r!==void 0&&(l.recursionLimit=r),t!==void 0&&(l.maxConcurrency=t),a!==void 0&&(l.runName=a),i!==void 0&&(l.configurable={...l.configurable,...i}),o!==void 0&&delete l.runId,l}import Rn from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import qt from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var Mn=[400,401,402,403,404,405,406,407,409],jn=n=>{if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||n?.code==="ECONNABORTED")throw n;let e=n?.response?.status??n?.status;if(e&&Mn.includes(+e))throw n;if(n?.error?.code==="insufficient_quota"){let t=new Error(n?.message);throw t.name="InsufficientQuotaError",t}},gt=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??jn;let t="default"in qt?qt.default:qt;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Rn(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var Ve=class extends Y{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}};function Ke(n){return n?n.lc_runnable:!1}var bt=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(i=>this.includeTags?.includes(i))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(i=>!this.excludeTags?.includes(i))),r}};import{zodToJsonSchema as Fn}from"/v135/zod-to-json-schema@3.23.1/denonext/zod-to-json-schema.mjs";import{v4 as Bn,validate as Yt}from"/v135/uuid@10.0.0/denonext/uuid.mjs";function Vt(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}function Dn(n,e){let t=e[n.source]??n.source,r=e[n.target]??n.target;return[t,r]}function Ln(n){let e="";for(let[t,r]of Object.entries(n))e+=`	classDef ${t}class fill:${r};
`;return e}function Rr(n,e,t){let{firstNodeLabel:r,lastNodeLabel:a,nodeColors:i,withStyles:o=!0,curveStyle:l="linear",wrapLabelNWords:c=9}=t??{},d=o?`%%{init: {'flowchart': {'curve': '${l}'}}}%%
graph TD;
`:`graph TD;
`;if(o){let b="default",m={[b]:"{0}([{1}]):::otherclass"};r!==void 0&&(m[r]="{0}[{0}]:::startclass"),a!==void 0&&(m[a]="{0}[{0}]:::endclass");for(let y of Object.values(n)){let T=m[y]??m[b],B=Vt(y),P=y.split(":"),R=P[P.length-1];d+=`	${T.replace(/\{0\}/g,B).replace(/\{1\}/g,R)};
`}}let p="";for(let b of e){let m=b.source.includes(":")?b.source.split(":")[0]:void 0,y=b.target.includes(":")?b.target.split(":")[0]:void 0;p!==""&&(p!==m||p!==y)&&(d+=`	end
`,p=""),p===""&&m!==void 0&&m===y&&(d=`	subgraph ${m}
`,p=m);let[T,B]=Dn(b,n),P="";if(b.data!==void 0){let R=b.data,M=R.split(" ");M.length>c&&(R=M.reduce((w,H,I)=>(I%c===0&&w.push(""),w[w.length-1]+=` ${H}`,w),[]).join("<br>")),b.conditional?P=` -. ${R} .-> `:P=` -- ${R} --> `}else b.conditional?P=" -.-> ":P=" --> ";d+=`	${Vt(T)}${P}${Vt(B)};
`}return p!==""&&(d+=`end
`),o&&i!==void 0&&(d+=Ln(i)),d}async function Mr(n,e){let{backgroundColor:t="white"}=e??{},r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));let a=`https://mermaid.ink/img/${r}?bgColor=${t}`,i=await fetch(a);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join(`
`));return await i.blob()}var jr=42;function Kt(n){if(Yt(n.id))if(Ke(n.data))try{let e=n.data.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e.length>jr&&(e=`${e.substring(0,jr)}...`),e}catch{return n.data.getName()}else return n.data.name??"UnknownSchema";else return n.id}function Hn(n){return Ke(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...Fn(n.data.schema),title:n.data.name}}}var Ye=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Yt(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...Hn(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||Bn(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let i={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(i),i}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e,t=""){let r=t;Object.values(e.nodes).map(d=>d.id).every(Yt)&&(r="");let i=d=>r?`${r}:${d}`:d;Object.entries(e.nodes).forEach(([d,p])=>{this.nodes[i(d)]={...p,id:i(d)}});let o=e.edges.map(d=>({...d,source:i(d.source),target:i(d.target)}));this.edges=[...this.edges,...o];let l=e.firstNode(),c=e.lastNode();return[l?{id:i(l.id),data:l.data}:void 0,c?{id:i(c.id),data:c.data}:void 0]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}drawMermaid(e){let{withStyles:t,curveStyle:r,nodeColors:a={start:"#ffdfba",end:"#baffc9",other:"#fad7de"},wrapLabelNWords:i}=e??{},o={};for(let b of Object.values(this.nodes))o[b.id]=Kt(b);let l=this.firstNode(),c=l?Kt(l):void 0,d=this.lastNode(),p=d?Kt(d):void 0;return Rr(o,this.edges,{firstNodeLabel:c,lastNodeLabel:p,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:i})}async drawMermaidPng(e){let t=this.drawMermaid(e);return Mr(t,{backgroundColor:e?.backgroundColor})}};function Dr(n){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return F.fromReadableStream(t)}function Xt(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}var Lr=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function yt(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*Qt(n,e){for(;;){let{value:t,done:r}=te.runWithConfig(n,e.next.bind(e),!0);if(r)break;yield t}}async function*Zt(n,e){let t=e[Symbol.asyncIterator]();for(;;){let{value:r,done:a}=await te.runWithConfig(n,t.next.bind(e),!0);if(a)break;yield r}}function Fr(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}var wt=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}};function D(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var O=class extends ue{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new fe({bound:this,kwargs:e,config:{}})}map(){return new _t({bound:this})}withRetry(e){return new vt({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new fe({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Tt({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(_);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,i)=>_(i===0?e:r))}return Array.from({length:t},()=>_(e))}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),i=a[0]?.maxConcurrency??r?.maxConcurrency,o=new gt({maxConcurrency:i,onFailedAttempt:c=>{throw c}}),l=e.map((c,d)=>o.call(async()=>{try{return await this.invoke(c,a[d])}catch(p){if(r?.returnExceptions)return p;throw p}}));return Promise.all(l)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=_(t),a=new ce({generator:this._streamIterator(e,r),config:r});return await a.setup,F.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=_(e):t=_({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){let a=_(r),o=await(await q(a))?.handleChainStart(this.toJSON(),D(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName());delete a.runId;let l;try{l=await e.call(this,t,a,o)}catch(c){throw await o?.handleChainError(c),c}return await o?.handleChainEnd(D(l,"output")),l}async _batchWithConfig(e,t,r,a){let i=this._getOptionsList(r??{},t.length),o=await Promise.all(i.map(q)),l=await Promise.all(o.map(async(d,p)=>{let b=await d?.handleChainStart(this.toJSON(),D(t[p],"input"),i[p].runId,i[p].runType,void 0,void 0,i[p].runName??this.getName());return delete i[p].runId,b})),c;try{c=await e.call(this,t,i,l,a)}catch(d){throw await Promise.all(l.map(p=>p?.handleChainError(d))),d}return await Promise.all(l.map(d=>d?.handleChainEnd(D(c,"output")))),c}async*_transformStreamWithConfig(e,t,r){let a,i=!0,o,l=!0,c=_(r),d=await q(c);async function*p(){for await(let m of e){if(i)if(a===void 0)a=m;else try{a=re(a,m)}catch{a=void 0,i=!1}yield m}}let b;try{let m=await kr(t.bind(this),p(),async()=>d?.handleChainStart(this.toJSON(),{input:""},c.runId,c.runType,void 0,void 0,c.runName??this.getName()),c);delete c.runId,b=m.setup;let y=b?.handlers.find($r),T=m.output;y!==void 0&&b!==void 0&&(T=y.tapOutputIterable(b.runId,T));let B=b?.handlers.find(Cr);B!==void 0&&b!==void 0&&(T=B.tapOutputIterable(b.runId,T));for await(let P of T)if(yield P,l)if(o===void 0)o=P;else try{o=re(o,P)}catch{o=void 0,l=!1}}catch(m){throw await b?.handleChainError(m,void 0,void 0,void 0,{inputs:D(a,"input")}),m}await b?.handleChainEnd(o??{},void 0,void 0,void 0,{inputs:D(a,"input")})}getGraph(e){let t=new Ye,r=t.addNode({name:`${this.getName()}Input`,schema:Xe.any()}),a=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:Xe.any()});return t.addEdge(r,a),t.addEdge(a,i),t}pipe(e){return new Qe({first:this,last:de(e)})}pick(e){return this.pipe(new Et(e))}assign(e){return this.pipe(new Ze(new ve({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=re(r,a);yield*this._streamIterator(r,_(t))}async*streamLog(e,t,r){let a=new We({...r,autoClose:!1,_schemaFormat:"original"}),i=_(t);yield*this._streamLog(e,a,i)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let c=a.copy();c.inheritableHandlers.push(t),r.callbacks=c}let i=this.stream(e,r);async function o(){try{let c=await i;for await(let d of c){let p=new ne({ops:[{op:"add",path:"/streamed_output/-",value:d}]});await t.writer.write(p)}}finally{await t.writer.close()}}let l=o();try{for await(let c of t)yield c}finally{await l}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?Dr(a):F.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){let a=new ht({...r,autoClose:!1}),i=_(t),o=i.runId??Un();i.runId=o;let l=i.callbacks;if(l===void 0)i.callbacks=[a];else if(Array.isArray(l))i.callbacks=l.concat(a);else{let y=l.copy();y.inheritableHandlers.push(a),i.callbacks=y}let c=this;async function d(){try{let y=await c.stream(e,i),T=a.tapOutputIterable(o,y);for await(let B of T);}finally{await a.finish()}}let p=d(),b=!1,m;try{for await(let y of a){if(!b){y.data.input=e,b=!0,m=y.run_id,yield y;continue}y.run_id===m&&y.event.endsWith("_end")&&y.data?.input&&delete y.data.input,yield y}}finally{await p}}async*_streamEventsV1(e,t,r){let a,i=!1,o=_(t),l=o.tags??[],c=o.metadata??{},d=o.runName??this.getName(),p=new We({...r,autoClose:!1,_schemaFormat:"streaming_events"}),b=new bt({...r}),m=this._streamLog(e,p,o);for await(let T of m){if(a?a=a.concat(T):a=Je.fromRunLogPatch(T),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;let M={...a.state},w={run_id:M.id,event:`on_${M.type}_start`,name:d,tags:l,metadata:c,data:{input:e}};b.includeEvent(w,M.type)&&(yield w)}let B=T.ops.filter(M=>M.path.startsWith("/logs/")).map(M=>M.path.split("/")[2]),P=[...new Set(B)];for(let M of P){let w,H={},I=a.state.logs[M];if(I.end_time===void 0?I.streamed_output.length>0?w="stream":w="start":w="end",w==="start")I.inputs!==void 0&&(H.input=I.inputs);else if(w==="end")I.inputs!==void 0&&(H.input=I.inputs),H.output=I.final_output;else if(w==="stream"){let V=I.streamed_output.length;if(V!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${V} instead. Encountered in: "${I.name}"`);H={chunk:I.streamed_output[0]},I.streamed_output=[]}yield{event:`on_${I.type}_${w}`,name:I.name,run_id:I.id,tags:I.tags,metadata:I.metadata,data:H}}let{state:R}=a;if(R.streamed_output.length>0){let M=R.streamed_output.length;if(M!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${M} instead. Encountered in: "${R.name}"`);let w={chunk:R.streamed_output[0]};R.streamed_output=[];let H={event:`on_${R.type}_stream`,run_id:R.id,tags:l,metadata:c,name:d,data:w};b.includeEvent(H,R.type)&&(yield H)}}let y=a?.state;if(y!==void 0){let T={event:`on_${y.type}_end`,name:d,run_id:y.id,tags:l,metadata:c,data:{output:y.final_output}};b.includeEvent(T,y.type)&&(yield T)}}static isRunnable(e){return Ke(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new fe({bound:this,config:{},configFactories:[a=>({callbacks:[new Ve({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return zn(this,e)}},fe=class n extends O{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=pt(this.config,...e);return pt(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(_(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async i=>this._mergeConfig(_(i),this.kwargs))):await this._mergeConfig(_(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(_(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(_(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(_(t),this.kwargs))}streamEvents(e,t,r){let a=this,i=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(_(t),a.kwargs),version:t.version},r)};return F.fromAsyncGenerator(i())}static isRunnableBinding(e){return e.bound&&O.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new Ve({config:a,onStart:e,onEnd:t,onError:r})]})]})}},_t=class n extends O{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,$(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},vt=class extends fe{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return $(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return Br(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){let i={};try{await Br(async o=>{let l=e.map((m,y)=>y).filter(m=>i[m.toString()]===void 0||i[m.toString()]instanceof Error),c=l.map(m=>e[m]),d=l.map(m=>this._patchConfigForRetry(o,t?.[m],r?.[m])),p=await super.batch(c,d,{...a,returnExceptions:!0}),b;for(let m=0;m<p.length;m+=1){let y=p[m],T=l[m];y instanceof Error&&b===void 0&&(b=y,b.input=c[m]),i[T.toString()]=y}if(b)throw b;return p},{onFailedAttempt:o=>this.onFailedAttempt(o,o.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(o){if(a?.returnExceptions!==!0)throw o}return Object.keys(i).sort((o,l)=>parseInt(o,10)-parseInt(l,10)).map(o=>i[parseInt(o,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Qe=class n extends O{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=_(t),i=await(await q(r))?.handleChainStart(this.toJSON(),D(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let o=e,l;try{let c=[this.first,...this.middle];for(let d=0;d<c.length;d+=1)o=await c[d].invoke(o,$(r,{callbacks:i?.getChild(`seq:step:${d+1}`)}));l=await this.last.invoke(o,$(r,{callbacks:i?.getChild(`seq:step:${this.steps.length}`)}))}catch(c){throw await i?.handleChainError(c),c}return await i?.handleChainEnd(D(l,"output")),l}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),i=await Promise.all(a.map(q)),o=await Promise.all(i.map(async(c,d)=>{let p=await c?.handleChainStart(this.toJSON(),D(e[d],"input"),a[d].runId,void 0,void 0,void 0,a[d].runName);return delete a[d].runId,p})),l=e;try{for(let c=0;c<this.steps.length;c+=1)l=await this.steps[c].batch(l,o.map((p,b)=>{let m=p?.getChild(`seq:step:${c+1}`);return $(a[b],{callbacks:m})}),r)}catch(c){throw await Promise.all(o.map(d=>d?.handleChainError(c))),c}return await Promise.all(o.map(c=>c?.handleChainEnd(D(l,"output")))),l}async*_streamIterator(e,t){let r=await q(t),{runId:a,...i}=t??{},o=await r?.handleChainStart(this.toJSON(),D(e,"input"),a,void 0,void 0,void 0,i?.runName),l=[this.first,...this.middle,this.last],c=!0,d;async function*p(){yield e}try{let b=l[0].transform(p(),$(i,{callbacks:o?.getChild("seq:step:1")}));for(let m=1;m<l.length;m+=1)b=await l[m].transform(b,$(i,{callbacks:o?.getChild(`seq:step:${m+1}`)}));for await(let m of b)if(yield m,c)if(d===void 0)d=m;else try{d=re(d,m)}catch{d=void 0,c=!1}}catch(b){throw await o?.handleChainError(b),b}await o?.handleChainEnd(D(d,"output"))}getGraph(e){let t=new Ye,r=null;return this.steps.forEach((a,i)=>{let o=a.getGraph(e);i!==0&&o.trimFirstNode(),i!==this.steps.length-1&&o.trimLastNode(),t.extend(o);let l=o.firstNode();if(!l)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,l),r=o.lastNode()}),t}pipe(e){return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:de(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&O.isRunnable(e)}static from([e,...t],r){return new n({first:de(e),middle:t.slice(0,-1).map(de),last:de(t[t.length-1]),name:r})}},ve=class n extends O{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=de(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=_(t),i=await(await q(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let o={};try{await Promise.all(Object.entries(this.steps).map(async([l,c])=>{o[l]=await c.invoke(e,$(r,{callbacks:i?.getChild(`map:key:${l}`)}))}))}catch(l){throw await i?.handleChainError(l),l}return await i?.handleChainEnd(o),o}async*_transform(e,t,r){let a={...this.steps},i=Wt(e,Object.keys(a).length),o=new Map(Object.entries(a).map(([l,c],d)=>{let p=c.transform(i[d],$(r,{callbacks:t?.getChild(`map:key:${l}`)}));return[l,p.next().then(b=>({key:l,gen:p,result:b}))]}));for(;o.size;){let{key:l,result:c,gen:d}=await Promise.race(o.values());o.delete(l),c.done||(yield{[l]:c.value},o.set(l,d.next().then(p=>({key:l,gen:d,result:p}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=_(t),i=new ce({generator:this.transform(r(),a),config:a});return await i.setup,F.fromAsyncGenerator(i)}},er=class n extends O{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!tr(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),a=await q(r);return await this.func($(r,{callbacks:a}),e)}async*_streamIterator(e,t){let r=await this.invoke(e,t);if(yt(r)){for await(let a of r)yield a;return}if(Lr(r)){for(;;){let a=r.next();if(a.done)break;yield a.value}return}yield r}static from(e){return new n({func:e})}};function Gn(n){if(tr(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Te=class n extends O{static lc_name(){return"RunnableLambda"}constructor(e){if(tr(e.func))return er.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Gn(e.func),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,i)=>{let o=$(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??mt)-1});te.runWithConfig(o,async()=>{try{let l=await this.func(e,{...o,config:o});if(l&&O.isRunnable(l)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");l=await l.invoke(e,{...o,recursionLimit:(o.recursionLimit??mt)-1})}else if(yt(l)){let c;for await(let d of Zt(o,l))if(c===void 0)c=d;else try{c=re(c,d)}catch{c=d}l=c}else if(Xt(l)){let c;for(let d of Qt(o,l))if(c===void 0)c=d;else try{c=re(c,d)}catch{c=d}l=c}a(l)}catch(l){i(l)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(let l of e)if(a===void 0)a=l;else try{a=re(a,l)}catch{a=l}let i=$(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??mt)-1}),o=await new Promise((l,c)=>{te.runWithConfig(i,async()=>{try{let d=await this.func(a,{...i,config:i});l(d)}catch(d){c(d)}})});if(o&&O.isRunnable(o)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let l=await o.stream(a,i);for await(let c of l)yield c}else if(yt(o))for await(let l of Zt(i,o))yield l;else if(Xt(o))for(let l of Qt(i,o))yield l;else yield o}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=_(t),i=new ce({generator:this.transform(r(),a),config:a});return await i.setup,F.fromAsyncGenerator(i)}};var Tt=class extends O{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=_(t),a=await q(t),{runId:i,...o}=r,l=await a?.handleChainStart(this.toJSON(),D(e,"input"),i,void 0,void 0,void 0,o?.runName),c;for(let d of this.runnables())try{let p=await d.invoke(e,$(o,{callbacks:l?.getChild()}));return await l?.handleChainEnd(D(p,"output")),p}catch(p){c===void 0&&(c=p)}throw c===void 0?new Error("No error stored at end of fallback."):(await l?.handleChainError(c),c)}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t??{},e.length),i=await Promise.all(a.map(c=>q(c))),o=await Promise.all(i.map(async(c,d)=>{let p=await c?.handleChainStart(this.toJSON(),D(e[d],"input"),a[d].runId,void 0,void 0,void 0,a[d].runName);return delete a[d].runId,p})),l;for(let c of this.runnables())try{let d=await c.batch(e,o.map((p,b)=>$(a[b],{callbacks:p?.getChild()})),r);return await Promise.all(o.map((p,b)=>p?.handleChainEnd(D(d[b],"output")))),d}catch(d){l===void 0&&(l=d)}throw l?(await Promise.all(o.map(c=>c?.handleChainError(l))),l):new Error("No error stored at end of fallbacks.")}};function de(n){if(typeof n=="function")return new Te({func:n});if(O.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=de(r);return new ve({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var Ze=class extends O{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof ve&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[i,o]=Wt(e),l=this.mapper.transform(o,$(r,{callbacks:t?.getChild()})),c=l.next();for await(let d of i){if(typeof d!="object"||Array.isArray(d))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof d}`);let p=Object.fromEntries(Object.entries(d).filter(([b])=>!a.includes(b)));Object.keys(p).length>0&&(yield p)}yield(await c).value;for await(let d of l)yield d}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=_(t),i=new ce({generator:this.transform(r(),a),config:a});return await i.setup,F.fromAsyncGenerator(i)}},Et=class extends O{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=_(t),i=new ce({generator:this.transform(r(),a),config:a});return await i.setup,F.fromAsyncGenerator(i)}},et=class extends fe{constructor(e){let t=Qe.from([Te.from(async r=>{let a;if(Fr(r))try{a=await this.schema.parseAsync(r.args)}catch{throw new wt("Received tool input did not match expected schema",JSON.stringify(r.args))}else a=r;return a}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function zn(n,e){let t=e.name??n.getName(),r=e.description??e.schema?.description;return e.schema.constructor===Xe.ZodString?new et({name:t,description:r,schema:Xe.object({input:Xe.string()}).transform(a=>a.input),bound:n}):new et({name:t,description:r,schema:e.schema,bound:n})}var rr=class extends O{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a?.callbacks),e,{...t,runType:"parser"})}},Ee=class extends rr{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},se=class extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}};function tt(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!tt(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(let o of r)if(!tt(n[o],e[o]))return!1;return!0}return n===e}var Vo=typeof self<"u"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var Vn=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,Kn=[0,31,28,31,30,31,30,31,31,30,31,30,31],Yn=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,Xn=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,Qn=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,Zn=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,ea=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,ta=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,ra=/^(?:\/(?:[^~/]|~0|~1)*)*$/,na=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,aa=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,ia=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,sa=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,oa=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,ua=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,la=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},ca=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,da=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,fa=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function J(n){return n.test.bind(n)}var ha={date:Hr,time:Ur.bind(void 0,!1),"date-time":ba,duration:fa,uri:_a,"uri-reference":J(Qn),"uri-template":J(Zn),url:J(ea),email:la,hostname:J(Xn),ipv4:J(ca),ipv6:J(da),regex:Ta,uuid:J(ta),"json-pointer":J(ra),"json-pointer-uri-fragment":J(na),"relative-json-pointer":J(aa)},ma={...ha,date:J(ia),time:J(sa),"date-time":J(oa),"uri-reference":J(ua)};function pa(n){return n%4===0&&(n%100!==0||n%400===0)}function Hr(n){let e=n.match(Vn);if(!e)return!1;let t=+e[1],r=+e[2],a=+e[3];return r>=1&&r<=12&&a>=1&&a<=(r==2&&pa(t)?29:Kn[r])}function Ur(n,e){let t=e.match(Yn);if(!t)return!1;let r=+t[1],a=+t[2],i=+t[3],o=!!t[5];return(r<=23&&a<=59&&i<=59||r==23&&a==59&&i==60)&&(!n||o)}var ga=/t|\s/i;function ba(n){let e=n.split(ga);return e.length==2&&Hr(e[0])&&Ur(!0,e[1])}var ya=/\/|:/,wa=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function _a(n){return ya.test(n)&&wa.test(n)}var va=/[^\\]\\Z/;function Ta(n){if(va.test(n))return!1;try{return new RegExp(n),!0}catch{return!1}}var he=class extends Ee{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},Se=class extends he{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,r;for await(let a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let i;if(Er(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");i=new qe({message:a,text:a.content})}else if(Le(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");i=new qe({message:Mt(a),text:a.content})}else i=new ge({text:a});r===void 0?r=i:r=r.concat(i);let o=await this.parsePartialResult([r]);o!=null&&!tt(o,t)&&(this.diff?yield this._diff(t,o):yield o,t=o)}}};var Gr=class extends he{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","bytes"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"textEncoder",{enumerable:!0,configurable:!0,writable:!0,value:new TextEncoder})}static lc_name(){return"BytesOutputParser"}parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}};var Pe=class extends he{constructor(){super(...arguments),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}async*_transform(e){let t="";for await(let r of e)if(typeof r=="string"?t+=r:t+=r.content,this.re){let a=[...t.matchAll(this.re)];if(a.length>1){let i=0;for(let o of a.slice(0,-1))yield[o[1]],i+=(o.index??0)+o[0].length;t=t.slice(i)}}else{let a=await this.parse(t);if(a.length>1){for(let i of a.slice(0,-1))yield[i];t=a[a.length-1]}}for(let r of await this.parse(t))yield[r]}},zr=class extends Pe{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"CommaSeparatedListOutputParser"}async parse(e){try{return e.trim().split(",").map(t=>t.trim())}catch{throw new se(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},Jr=class extends Pe{constructor({length:e,separator:t}){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"length",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"separator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.length=e,this.separator=t||","}async parse(e){try{let t=e.trim().split(this.separator).map(r=>r.trim());if(this.length!==void 0&&t.length!==this.length)throw new se(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){throw Object.getPrototypeOf(t)===se.prototype?t:new se(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${this.length===void 0?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}},Wr=class extends Pe{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:/\d+\.\s([^\n]+)/g})}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(t=>t[1])}},qr=class extends Pe{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","list"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"re",{enumerable:!0,configurable:!0,writable:!0,value:/^\s*[-*]\s([^\n]+)$/gm})}static lc_name(){return"NumberedListOutputParser"}getFormatInstructions(){return`Your response should be a numbered list with each item on a new line. For example: 

1. foo

2. bar

3. baz`}async parse(e){return[...e.matchAll(this.re)??[]].map(t=>t[1])}};var Vr=class extends he{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((t,r)=>t+this._messageContentComplexToString(r),"")}};import{z as xt}from"/v135/zod@3.23.8/denonext/zod.mjs";import{zodToJsonSchema as Yr}from"/v135/zod-to-json-schema@3.23.1/denonext/zod-to-json-schema.mjs";var nr=class extends Ee{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=xt.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,xt.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Yr(this.schema))}
\`\`\`
`}async parse(e){try{let r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,i)=>`"${i.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new se(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}},ar=class extends nr{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(e){let t=e?.interpolationDepth??1;if(t<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:
\`\`\`json
${this._schemaToInstruction(Yr(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}
\`\`\``}_schemaToInstruction(e,t=2){let r=e;if("type"in r){let a=!1,i;if(Array.isArray(r.type)){let c=r.type.findIndex(d=>d==="null");c!==-1&&(a=!0,r.type.splice(c,1)),i=r.type.join(" | ")}else i=r.type;if(r.type==="object"&&r.properties){let c=r.description?` // ${r.description}`:"";return`{
${Object.entries(r.properties).map(([p,b])=>{let m=r.required?.includes(p)?"":" (optional)";return`${" ".repeat(t)}"${p}": ${this._schemaToInstruction(b,t+2)}${m}`}).join(`
`)}
${" ".repeat(t-2)}}${c}`}if(r.type==="array"&&r.items){let c=r.description?` // ${r.description}`:"";return`array[
${" ".repeat(t)}${this._schemaToInstruction(r.items,t+2)}
${" ".repeat(t-2)}] ${c}`}let o=a?" (nullable)":"",l=r.description?` // ${r.description}`:"";return`${i}${l}${o}`}if("anyOf"in r)return r.anyOf.map(a=>this._schemaToInstruction(a,t)).join(`
${" ".repeat(t-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=xt.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,xt.string().describe(a)])));return new this(t)}},Kr=class extends Ee{constructor({inputSchema:e}){super(...arguments),Object.defineProperty(this,"structuredInputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.structuredInputParser=new ar(e)}async parse(e){let t;try{t=await this.structuredInputParser.parse(e)}catch(r){throw new se(`Failed to parse. Text: "${e}". Error: ${r}`,e)}return this.outputProcessor(t)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}};var Xr=class extends Se{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?je(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Rt(e[0].text)}async parse(e){return Rt(e,JSON.parse)}getFormatInstructions(){return""}};var xa=function(){let n={};n.parser=function(u,s){return new t(u,s)},n.SAXParser=t,n.SAXStream=d,n.createStream=c,n.MAX_BUFFER_LENGTH=65536;let e=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];n.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function t(u,s){if(!(this instanceof t))return new t(u,s);var g=this;a(g),g.q=g.c="",g.bufferCheckPosition=n.MAX_BUFFER_LENGTH,g.opt=s||{},g.opt.lowercase=g.opt.lowercase||g.opt.lowercasetags,g.looseCase=g.opt.lowercase?"toLowerCase":"toUpperCase",g.tags=[],g.closed=g.closedRoot=g.sawRoot=!1,g.tag=g.error=null,g.strict=!!u,g.noscript=!!(u||g.opt.noscript),g.state=h.BEGIN,g.strictEntities=g.opt.strictEntities,g.ENTITIES=g.strictEntities?Object.create(n.XML_ENTITIES):Object.create(n.ENTITIES),g.attribList=[],g.opt.xmlns&&(g.ns=Object.create(T)),g.trackPosition=g.opt.position!==!1,g.trackPosition&&(g.position=g.line=g.column=0),Ce(g,"onready")}Object.create||(Object.create=function(u){function s(){}s.prototype=u;var g=new s;return g}),Object.keys||(Object.keys=function(u){var s=[];for(var g in u)u.hasOwnProperty(g)&&s.push(g);return s});function r(u){for(var s=Math.max(n.MAX_BUFFER_LENGTH,10),g=0,f=0,v=e.length;f<v;f++){var N=u[e[f]].length;if(N>s)switch(e[f]){case"textNode":$e(u);break;case"cdata":A(u,"oncdata",u.cdata),u.cdata="";break;case"script":A(u,"onscript",u.script),u.script="";break;default:rt(u,"Max buffer length exceeded: "+e[f])}g=Math.max(g,N)}var k=n.MAX_BUFFER_LENGTH-g;u.bufferCheckPosition=k+u.position}function a(u){for(var s=0,g=e.length;s<g;s++)u[e[s]]=""}function i(u){$e(u),u.cdata!==""&&(A(u,"oncdata",u.cdata),u.cdata=""),u.script!==""&&(A(u,"onscript",u.script),u.script="")}t.prototype={end:function(){or(this)},write:sn,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){i(this)}};var o=ReadableStream;o||(o=function(){});var l=n.EVENTS.filter(function(u){return u!=="error"&&u!=="end"});function c(u,s){return new d(u,s)}function d(u,s){if(!(this instanceof d))return new d(u,s);o.apply(this),this._parser=new t(u,s),this.writable=!0,this.readable=!0;var g=this;this._parser.onend=function(){g.emit("end")},this._parser.onerror=function(f){g.emit("error",f),g._parser.error=null},this._decoder=null,l.forEach(function(f){Object.defineProperty(g,"on"+f,{get:function(){return g._parser["on"+f]},set:function(v){if(!v)return g.removeAllListeners(f),g._parser["on"+f]=v,v;g.on(f,v)},enumerable:!0,configurable:!1})})}d.prototype=Object.create(o.prototype,{constructor:{value:d}}),d.prototype.write=function(u){return this._parser.write(u.toString()),this.emit("data",u),!0},d.prototype.end=function(u){return u&&u.length&&this.write(u),this._parser.end(),!0},d.prototype.on=function(u,s){var g=this;return!g._parser["on"+u]&&l.indexOf(u)!==-1&&(g._parser["on"+u]=function(){var f=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);f.splice(0,0,u),g.emit.apply(g,f)}),o.prototype.on.call(g,u,s)};var p="[CDATA[",b="DOCTYPE",m="http://www.w3.org/XML/1998/namespace",y="http://www.w3.org/2000/xmlns/",T={xml:m,xmlns:y},B=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,P=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,R=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,M=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function w(u){return u===" "||u===`
`||u==="\r"||u==="	"}function H(u){return u==='"'||u==="'"}function I(u){return u===">"||w(u)}function V(u,s){return u.test(s)}function nn(u,s){return!V(u,s)}var h=0;n.STATE={BEGIN:h++,BEGIN_WHITESPACE:h++,TEXT:h++,TEXT_ENTITY:h++,OPEN_WAKA:h++,SGML_DECL:h++,SGML_DECL_QUOTED:h++,DOCTYPE:h++,DOCTYPE_QUOTED:h++,DOCTYPE_DTD:h++,DOCTYPE_DTD_QUOTED:h++,COMMENT_STARTING:h++,COMMENT:h++,COMMENT_ENDING:h++,COMMENT_ENDED:h++,CDATA:h++,CDATA_ENDING:h++,CDATA_ENDING_2:h++,PROC_INST:h++,PROC_INST_BODY:h++,PROC_INST_ENDING:h++,OPEN_TAG:h++,OPEN_TAG_SLASH:h++,ATTRIB:h++,ATTRIB_NAME:h++,ATTRIB_NAME_SAW_WHITE:h++,ATTRIB_VALUE:h++,ATTRIB_VALUE_QUOTED:h++,ATTRIB_VALUE_CLOSED:h++,ATTRIB_VALUE_UNQUOTED:h++,ATTRIB_VALUE_ENTITY_Q:h++,ATTRIB_VALUE_ENTITY_U:h++,CLOSE_TAG:h++,CLOSE_TAG_SAW_WHITE:h++,SCRIPT:h++,SCRIPT_ENDING:h++},n.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},n.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(n.ENTITIES).forEach(function(u){var s=n.ENTITIES[u],g=typeof s=="number"?String.fromCharCode(s):s;n.ENTITIES[u]=g});for(var ir in n.STATE)n.STATE[n.STATE[ir]]=ir;h=n.STATE;function Ce(u,s,g){u[s]&&u[s](g)}function A(u,s,g){u.textNode&&$e(u),Ce(u,s,g)}function $e(u){u.textNode=sr(u.opt,u.textNode),u.textNode&&Ce(u,"ontext",u.textNode),u.textNode=""}function sr(u,s){return u.trim&&(s=s.trim()),u.normalize&&(s=s.replace(/\s+/g," ")),s}function rt(u,s){return $e(u),u.trackPosition&&(s+=`
Line: `+u.line+`
Column: `+u.column+`
Char: `+u.c),s=new Error(s),u.error=s,Ce(u,"onerror",s),u}function or(u){return u.sawRoot&&!u.closedRoot&&E(u,"Unclosed root tag"),u.state!==h.BEGIN&&u.state!==h.BEGIN_WHITESPACE&&u.state!==h.TEXT&&rt(u,"Unexpected end"),$e(u),u.c="",u.closed=!0,Ce(u,"onend"),t.call(u,u.strict,u.opt),u}function E(u,s){if(typeof u!="object"||!(u instanceof t))throw new Error("bad call to strictFail");u.strict&&rt(u,s)}function an(u){u.strict||(u.tagName=u.tagName[u.looseCase]());var s=u.tags[u.tags.length-1]||u,g=u.tag={name:u.tagName,attributes:{}};u.opt.xmlns&&(g.ns=s.ns),u.attribList.length=0,A(u,"onopentagstart",g)}function Ot(u,s){var g=u.indexOf(":"),f=g<0?["",u]:u.split(":"),v=f[0],N=f[1];return s&&u==="xmlns"&&(v="xmlns",N=""),{prefix:v,local:N}}function It(u){if(u.strict||(u.attribName=u.attribName[u.looseCase]()),u.attribList.indexOf(u.attribName)!==-1||u.tag.attributes.hasOwnProperty(u.attribName)){u.attribName=u.attribValue="";return}if(u.opt.xmlns){var s=Ot(u.attribName,!0),g=s.prefix,f=s.local;if(g==="xmlns")if(f==="xml"&&u.attribValue!==m)E(u,"xml: prefix must be bound to "+m+`
Actual: `+u.attribValue);else if(f==="xmlns"&&u.attribValue!==y)E(u,"xmlns: prefix must be bound to "+y+`
Actual: `+u.attribValue);else{var v=u.tag,N=u.tags[u.tags.length-1]||u;v.ns===N.ns&&(v.ns=Object.create(N.ns)),v.ns[f]=u.attribValue}u.attribList.push([u.attribName,u.attribValue])}else u.tag.attributes[u.attribName]=u.attribValue,A(u,"onattribute",{name:u.attribName,value:u.attribValue});u.attribName=u.attribValue=""}function be(u,s){if(u.opt.xmlns){var g=u.tag,f=Ot(u.tagName);g.prefix=f.prefix,g.local=f.local,g.uri=g.ns[f.prefix]||"",g.prefix&&!g.uri&&(E(u,"Unbound namespace prefix: "+JSON.stringify(u.tagName)),g.uri=f.prefix);var v=u.tags[u.tags.length-1]||u;g.ns&&v.ns!==g.ns&&Object.keys(g.ns).forEach(function(fr){A(u,"onopennamespace",{prefix:fr,uri:g.ns[fr]})});for(var N=0,k=u.attribList.length;N<k;N++){var G=u.attribList[N],K=G[0],xe=G[1],j=Ot(K,!0),oe=j.prefix,on=j.local,dr=oe===""?"":g.ns[oe]||"",Nt={name:K,value:xe,prefix:oe,local:on,uri:dr};oe&&oe!=="xmlns"&&!dr&&(E(u,"Unbound namespace prefix: "+JSON.stringify(oe)),Nt.uri=oe),u.tag.attributes[K]=Nt,A(u,"onattribute",Nt)}u.attribList.length=0}u.tag.isSelfClosing=!!s,u.sawRoot=!0,u.tags.push(u.tag),A(u,"onopentag",u.tag),s||(!u.noscript&&u.tagName.toLowerCase()==="script"?u.state=h.SCRIPT:u.state=h.TEXT,u.tag=null,u.tagName=""),u.attribName=u.attribValue="",u.attribList.length=0}function At(u){if(!u.tagName){E(u,"Weird empty close tag."),u.textNode+="</>",u.state=h.TEXT;return}if(u.script){if(u.tagName!=="script"){u.script+="</"+u.tagName+">",u.tagName="",u.state=h.SCRIPT;return}A(u,"onscript",u.script),u.script=""}var s=u.tags.length,g=u.tagName;u.strict||(g=g[u.looseCase]());for(var f=g;s--;){var v=u.tags[s];if(v.name!==f)E(u,"Unexpected close tag");else break}if(s<0){E(u,"Unmatched closing tag: "+u.tagName),u.textNode+="</"+u.tagName+">",u.state=h.TEXT;return}u.tagName=g;for(var N=u.tags.length;N-- >s;){var k=u.tag=u.tags.pop();u.tagName=u.tag.name,A(u,"onclosetag",u.tagName);var G={};for(var K in k.ns)G[K]=k.ns[K];var xe=u.tags[u.tags.length-1]||u;u.opt.xmlns&&k.ns!==xe.ns&&Object.keys(k.ns).forEach(function(j){var oe=k.ns[j];A(u,"onclosenamespace",{prefix:j,uri:oe})})}s===0&&(u.closedRoot=!0),u.tagName=u.attribValue=u.attribName="",u.attribList.length=0,u.state=h.TEXT}function ur(u){var s=u.entity,g=s.toLowerCase(),f,v="";return u.ENTITIES[s]?u.ENTITIES[s]:u.ENTITIES[g]?u.ENTITIES[g]:(s=g,s.charAt(0)==="#"&&(s.charAt(1)==="x"?(s=s.slice(2),f=parseInt(s,16),v=f.toString(16)):(s=s.slice(1),f=parseInt(s,10),v=f.toString(10))),s=s.replace(/^0+/,""),isNaN(f)||v.toLowerCase()!==s?(E(u,"Invalid character entity"),"&"+u.entity+";"):String.fromCodePoint(f))}function lr(u,s){s==="<"?(u.state=h.OPEN_WAKA,u.startTagPosition=u.position):w(s)||(E(u,"Non-whitespace before first tag."),u.textNode=s,u.state=h.TEXT)}function cr(u,s){var g="";return s<u.length&&(g=u.charAt(s)),g}function sn(u){var s=this;if(this.error)throw this.error;if(s.closed)return rt(s,"Cannot write after close. Assign an onready handler.");if(u===null)return or(s);typeof u=="object"&&(u=u.toString());for(var g=0,f="";f=cr(u,g++),s.c=f,!!f;)switch(s.trackPosition&&(s.position++,f===`
`?(s.line++,s.column=0):s.column++),s.state){case h.BEGIN:if(s.state=h.BEGIN_WHITESPACE,f==="\uFEFF")continue;lr(s,f);continue;case h.BEGIN_WHITESPACE:lr(s,f);continue;case h.TEXT:if(s.sawRoot&&!s.closedRoot){for(var v=g-1;f&&f!=="<"&&f!=="&";)f=cr(u,g++),f&&s.trackPosition&&(s.position++,f===`
`?(s.line++,s.column=0):s.column++);s.textNode+=u.substring(v,g-1)}f==="<"&&!(s.sawRoot&&s.closedRoot&&!s.strict)?(s.state=h.OPEN_WAKA,s.startTagPosition=s.position):(!w(f)&&(!s.sawRoot||s.closedRoot)&&E(s,"Text data outside of root node."),f==="&"?s.state=h.TEXT_ENTITY:s.textNode+=f);continue;case h.SCRIPT:f==="<"?s.state=h.SCRIPT_ENDING:s.script+=f;continue;case h.SCRIPT_ENDING:f==="/"?s.state=h.CLOSE_TAG:(s.script+="<"+f,s.state=h.SCRIPT);continue;case h.OPEN_WAKA:if(f==="!")s.state=h.SGML_DECL,s.sgmlDecl="";else if(!w(f))if(V(B,f))s.state=h.OPEN_TAG,s.tagName=f;else if(f==="/")s.state=h.CLOSE_TAG,s.tagName="";else if(f==="?")s.state=h.PROC_INST,s.procInstName=s.procInstBody="";else{if(E(s,"Unencoded <"),s.startTagPosition+1<s.position){var N=s.position-s.startTagPosition;f=new Array(N).join(" ")+f}s.textNode+="<"+f,s.state=h.TEXT}continue;case h.SGML_DECL:(s.sgmlDecl+f).toUpperCase()===p?(A(s,"onopencdata"),s.state=h.CDATA,s.sgmlDecl="",s.cdata=""):s.sgmlDecl+f==="--"?(s.state=h.COMMENT,s.comment="",s.sgmlDecl=""):(s.sgmlDecl+f).toUpperCase()===b?(s.state=h.DOCTYPE,(s.doctype||s.sawRoot)&&E(s,"Inappropriately located doctype declaration"),s.doctype="",s.sgmlDecl=""):f===">"?(A(s,"onsgmldeclaration",s.sgmlDecl),s.sgmlDecl="",s.state=h.TEXT):(H(f)&&(s.state=h.SGML_DECL_QUOTED),s.sgmlDecl+=f);continue;case h.SGML_DECL_QUOTED:f===s.q&&(s.state=h.SGML_DECL,s.q=""),s.sgmlDecl+=f;continue;case h.DOCTYPE:f===">"?(s.state=h.TEXT,A(s,"ondoctype",s.doctype),s.doctype=!0):(s.doctype+=f,f==="["?s.state=h.DOCTYPE_DTD:H(f)&&(s.state=h.DOCTYPE_QUOTED,s.q=f));continue;case h.DOCTYPE_QUOTED:s.doctype+=f,f===s.q&&(s.q="",s.state=h.DOCTYPE);continue;case h.DOCTYPE_DTD:s.doctype+=f,f==="]"?s.state=h.DOCTYPE:H(f)&&(s.state=h.DOCTYPE_DTD_QUOTED,s.q=f);continue;case h.DOCTYPE_DTD_QUOTED:s.doctype+=f,f===s.q&&(s.state=h.DOCTYPE_DTD,s.q="");continue;case h.COMMENT:f==="-"?s.state=h.COMMENT_ENDING:s.comment+=f;continue;case h.COMMENT_ENDING:f==="-"?(s.state=h.COMMENT_ENDED,s.comment=sr(s.opt,s.comment),s.comment&&A(s,"oncomment",s.comment),s.comment=""):(s.comment+="-"+f,s.state=h.COMMENT);continue;case h.COMMENT_ENDED:f!==">"?(E(s,"Malformed comment"),s.comment+="--"+f,s.state=h.COMMENT):s.state=h.TEXT;continue;case h.CDATA:f==="]"?s.state=h.CDATA_ENDING:s.cdata+=f;continue;case h.CDATA_ENDING:f==="]"?s.state=h.CDATA_ENDING_2:(s.cdata+="]"+f,s.state=h.CDATA);continue;case h.CDATA_ENDING_2:f===">"?(s.cdata&&A(s,"oncdata",s.cdata),A(s,"onclosecdata"),s.cdata="",s.state=h.TEXT):f==="]"?s.cdata+="]":(s.cdata+="]]"+f,s.state=h.CDATA);continue;case h.PROC_INST:f==="?"?s.state=h.PROC_INST_ENDING:w(f)?s.state=h.PROC_INST_BODY:s.procInstName+=f;continue;case h.PROC_INST_BODY:if(!s.procInstBody&&w(f))continue;f==="?"?s.state=h.PROC_INST_ENDING:s.procInstBody+=f;continue;case h.PROC_INST_ENDING:f===">"?(A(s,"onprocessinginstruction",{name:s.procInstName,body:s.procInstBody}),s.procInstName=s.procInstBody="",s.state=h.TEXT):(s.procInstBody+="?"+f,s.state=h.PROC_INST_BODY);continue;case h.OPEN_TAG:V(P,f)?s.tagName+=f:(an(s),f===">"?be(s):f==="/"?s.state=h.OPEN_TAG_SLASH:(w(f)||E(s,"Invalid character in tag name"),s.state=h.ATTRIB));continue;case h.OPEN_TAG_SLASH:f===">"?(be(s,!0),At(s)):(E(s,"Forward-slash in opening tag not followed by >"),s.state=h.ATTRIB);continue;case h.ATTRIB:if(w(f))continue;f===">"?be(s):f==="/"?s.state=h.OPEN_TAG_SLASH:V(B,f)?(s.attribName=f,s.attribValue="",s.state=h.ATTRIB_NAME):E(s,"Invalid attribute name");continue;case h.ATTRIB_NAME:f==="="?s.state=h.ATTRIB_VALUE:f===">"?(E(s,"Attribute without value"),s.attribValue=s.attribName,It(s),be(s)):w(f)?s.state=h.ATTRIB_NAME_SAW_WHITE:V(P,f)?s.attribName+=f:E(s,"Invalid attribute name");continue;case h.ATTRIB_NAME_SAW_WHITE:if(f==="=")s.state=h.ATTRIB_VALUE;else{if(w(f))continue;E(s,"Attribute without value"),s.tag.attributes[s.attribName]="",s.attribValue="",A(s,"onattribute",{name:s.attribName,value:""}),s.attribName="",f===">"?be(s):V(B,f)?(s.attribName=f,s.state=h.ATTRIB_NAME):(E(s,"Invalid attribute name"),s.state=h.ATTRIB)}continue;case h.ATTRIB_VALUE:if(w(f))continue;H(f)?(s.q=f,s.state=h.ATTRIB_VALUE_QUOTED):(E(s,"Unquoted attribute value"),s.state=h.ATTRIB_VALUE_UNQUOTED,s.attribValue=f);continue;case h.ATTRIB_VALUE_QUOTED:if(f!==s.q){f==="&"?s.state=h.ATTRIB_VALUE_ENTITY_Q:s.attribValue+=f;continue}It(s),s.q="",s.state=h.ATTRIB_VALUE_CLOSED;continue;case h.ATTRIB_VALUE_CLOSED:w(f)?s.state=h.ATTRIB:f===">"?be(s):f==="/"?s.state=h.OPEN_TAG_SLASH:V(B,f)?(E(s,"No whitespace between attributes"),s.attribName=f,s.attribValue="",s.state=h.ATTRIB_NAME):E(s,"Invalid attribute name");continue;case h.ATTRIB_VALUE_UNQUOTED:if(!I(f)){f==="&"?s.state=h.ATTRIB_VALUE_ENTITY_U:s.attribValue+=f;continue}It(s),f===">"?be(s):s.state=h.ATTRIB;continue;case h.CLOSE_TAG:if(s.tagName)f===">"?At(s):V(P,f)?s.tagName+=f:s.script?(s.script+="</"+s.tagName,s.tagName="",s.state=h.SCRIPT):(w(f)||E(s,"Invalid tagname in closing tag"),s.state=h.CLOSE_TAG_SAW_WHITE);else{if(w(f))continue;nn(B,f)?s.script?(s.script+="</"+f,s.state=h.SCRIPT):E(s,"Invalid tagname in closing tag."):s.tagName=f}continue;case h.CLOSE_TAG_SAW_WHITE:if(w(f))continue;f===">"?At(s):E(s,"Invalid characters in closing tag");continue;case h.TEXT_ENTITY:case h.ATTRIB_VALUE_ENTITY_Q:case h.ATTRIB_VALUE_ENTITY_U:var k,G;switch(s.state){case h.TEXT_ENTITY:k=h.TEXT,G="textNode";break;case h.ATTRIB_VALUE_ENTITY_Q:k=h.ATTRIB_VALUE_QUOTED,G="attribValue";break;case h.ATTRIB_VALUE_ENTITY_U:k=h.ATTRIB_VALUE_UNQUOTED,G="attribValue";break}if(f===";")if(s.opt.unparsedEntities){var K=ur(s);s.entity="",s.state=k,s.write(K)}else s[G]+=ur(s),s.entity="",s.state=k;else V(s.entity.length?M:R,f)?s.entity+=f:(E(s,"Invalid character in entity name"),s[G]+="&"+s.entity+f,s.entity="",s.state=k);continue;default:throw new Error(s,"Unknown state: "+s.state)}return s.position>=s.bufferCheckPosition&&r(s),s}return String.fromCodePoint||function(){var u=String.fromCharCode,s=Math.floor,g=function(){var f=16384,v=[],N,k,G=-1,K=arguments.length;if(!K)return"";for(var xe="";++G<K;){var j=Number(arguments[G]);if(!isFinite(j)||j<0||j>1114111||s(j)!==j)throw RangeError("Invalid code point: "+j);j<=65535?v.push(j):(j-=65536,N=(j>>10)+55296,k=j%1024+56320,v.push(N,k)),(G+1===K||v.length>f)&&(xe+=u.apply(null,v),v.length=0)}return xe};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:g,configurable:!0,writable:!0}):String.fromCodePoint=g}(),n},Qr=xa();var Zr=`The output should be formatted as a XML file.
1. Output should conform to the tags below. 
2. If tags are not given, make them on your own.
3. Remember to always open and close all the tags.

As an example, for the tags ["foo", "bar", "baz"]:
1. String "<foo>
   <bar>
      <baz></baz>
   </bar>
</foo>" is a well-formatted instance of the schema. 
2. String "<foo>
   <bar>
   </foo>" is a badly-formatted instance.
3. String "<foo>
   <tag>
   </tag>
</foo>" is a badly-formatted instance.

Here are the output tags:
\`\`\`
{tags}
\`\`\``,en=class extends Se{constructor(e){super(e),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.tags=e?.tags}static lc_name(){return"XMLOutputParser"}_diff(e,t){if(t)return e?je(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return tn(e[0].text)}async parse(e){return tn(e)}getFormatInstructions(){return!!(this.tags&&this.tags.length>0)?Zr.replace("{tags}",this.tags?.join(", ")??""):Zr}},Oa=n=>n.split(`
`).map(e=>e.replace(/^\s+/,"")).join(`
`).trim(),rn=n=>{if(Object.keys(n).length===0)return{};let e={};return n.children.length>0?(e[n.name]=n.children.map(rn),e):(e[n.name]=n.text??void 0,e)};function tn(n){let e=Oa(n),t=Qr.parser(!0),r={},a=[];t.onopentag=l=>{let c={name:l.name,attributes:l.attributes,children:[],text:"",isSelfClosing:l.isSelfClosing};a.length>0?a[a.length-1].children.push(c):r=c,l.isSelfClosing||a.push(c)},t.onclosetag=()=>{if(a.length>0){let l=a.pop();a.length===0&&l&&(r=l)}},t.ontext=l=>{if(a.length>0){let c=a[a.length-1];c.text+=l}},t.onattribute=l=>{if(a.length>0){let c=a[a.length-1];c.attributes[l.name]=l.value}};let i=/```(xml)?(.*)```/s.exec(e),o=i?i[2]:e;return t.write(o).close(),r&&r.name==="?xml"&&(r=r.children[0]),rn(r)}export{Kr as AsymmetricStructuredOutputParser,Se as BaseCumulativeTransformOutputParser,rr as BaseLLMOutputParser,Ee as BaseOutputParser,he as BaseTransformOutputParser,Gr as BytesOutputParser,zr as CommaSeparatedListOutputParser,Jr as CustomListOutputParser,ar as JsonMarkdownStructuredOutputParser,Xr as JsonOutputParser,Pe as ListOutputParser,qr as MarkdownListOutputParser,Wr as NumberedListOutputParser,se as OutputParserException,Vr as StringOutputParser,nr as StructuredOutputParser,en as XMLOutputParser,Zr as XML_FORMAT_INSTRUCTIONS,Rt as parseJsonMarkdown,lt as parsePartialJson,tn as parseXMLMarkdown};
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

@langchain/core/dist/utils/sax-js/sax.js:
  (*! http://mths.be/fromcodepoint v0.1.0 by @mathias *)
*/
//# sourceMappingURL=output_parsers.js.map