/* esm.sh - esbuild bundle(@langchain/core@0.2.21/prompts) denonext production */
import __Process$ from "node:process";
var Pr=Object.defineProperty;var Tr=(a,e)=>{for(var t in e)Pr(a,t,{get:e[t],enumerable:!0})};import{z as Se}from"/v135/zod@3.23.8/denonext/zod.mjs";import br from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import{v4 as ln}from"/v135/uuid@10.0.0/denonext/uuid.mjs";import{isTraceableFunction as Nt}from"/v135/langsmith@0.1.40/denonext/singletons/traceable.js";var it={};Tr(it,{JsonPatchError:()=>g,_areEquals:()=>we,applyOperation:()=>ee,applyPatch:()=>te,applyReducer:()=>Ar,deepClone:()=>Mr,getValueByPointer:()=>Fe,validate:()=>Wt,validator:()=>Ve});var Sr=Object.prototype.hasOwnProperty;function Jt(a,e){return Sr.call(a,e)}function zt(a){if(Array.isArray(a)){let t=new Array(a.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(a);let e=[];for(let t in a)Jt(a,t)&&e.push(t);return e}function A(a){switch(typeof a){case"object":return JSON.parse(JSON.stringify(a));case"undefined":return null;default:return a}}function Le(a){let e=0,t=a.length,r;for(;e<t;){if(r=a.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function $e(a){return a.indexOf("/")===-1&&a.indexOf("~")===-1?a:a.replace(/~/g,"~0").replace(/\//g,"~1")}function be(a){return a.replace(/~1/g,"/").replace(/~0/g,"~")}function Ne(a){if(a===void 0)return!0;if(a){if(Array.isArray(a)){for(let t=0,r=a.length;t<r;t++)if(Ne(a[t]))return!0}else if(typeof a=="object"){let t=zt(a),r=t.length;for(var e=0;e<r;e++)if(Ne(a[t[e]]))return!0}}return!1}function Gt(a,e){let t=[a];for(let r in e){let n=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof n<"u"&&t.push(`${r}: ${n}`)}return t.join(`
`)}var X=class extends Error{constructor(e,t,r,n,i){super(Gt(e,{name:t,index:r,operation:n,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=Gt(e,{name:t,index:r,operation:n,tree:i})}};var g=X,Mr=A,ce={add:function(a,e,t){return a[e]=this.value,{newDocument:t}},remove:function(a,e,t){var r=a[e];return delete a[e],{newDocument:t,removed:r}},replace:function(a,e,t){var r=a[e];return a[e]=this.value,{newDocument:t,removed:r}},move:function(a,e,t){let r=Fe(t,this.path);r&&(r=A(r));let n=ee(t,{op:"remove",path:this.from}).removed;return ee(t,{op:"add",path:this.path,value:n}),{newDocument:t,removed:r}},copy:function(a,e,t){let r=Fe(t,this.from);return ee(t,{op:"add",path:this.path,value:A(r)}),{newDocument:t}},test:function(a,e,t){return{newDocument:t,test:we(a[e],this.value)}},_get:function(a,e,t){return this.value=a[e],{newDocument:t}}},Ir={add:function(a,e,t){return Le(e)?a.splice(e,0,this.value):a[e]=this.value,{newDocument:t,index:e}},remove:function(a,e,t){var r=a.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(a,e,t){var r=a[e];return a[e]=this.value,{newDocument:t,removed:r}},move:ce.move,copy:ce.copy,test:ce.test,_get:ce._get};function Fe(a,e){if(e=="")return a;var t={op:"_get",path:e};return ee(a,t),t.value}function ee(a,e,t=!1,r=!0,n=!0,i=0){if(t&&(typeof t=="function"?t(e,0,a,e.path):Ve(e,0)),e.path===""){let s={newDocument:a};if(e.op==="add")return s.newDocument=e.value,s;if(e.op==="replace")return s.newDocument=e.value,s.removed=a,s;if(e.op==="move"||e.op==="copy")return s.newDocument=Fe(a,e.from),e.op==="move"&&(s.removed=a),s;if(e.op==="test"){if(s.test=we(a,e.value),s.test===!1)throw new g("Test operation failed","TEST_OPERATION_FAILED",i,e,a);return s.newDocument=a,s}else{if(e.op==="remove")return s.removed=a,s.newDocument=null,s;if(e.op==="_get")return e.value=a,s;if(t)throw new g("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,a);return s}}else{r||(a=A(a));let o=(e.path||"").split("/"),u=a,l=1,d=o.length,f,c,p;for(typeof t=="function"?p=t:p=Ve;;){if(c=o[l],c&&c.indexOf("~")!=-1&&(c=be(c)),n&&(c=="__proto__"||c=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&f===void 0&&(u[c]===void 0?f=o.slice(0,l).join("/"):l==d-1&&(f=e.path),f!==void 0&&p(e,0,a,f)),l++,Array.isArray(u)){if(c==="-")c=u.length;else{if(t&&!Le(c))throw new g("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,a);Le(c)&&(c=~~c)}if(l>=d){if(t&&e.op==="add"&&c>u.length)throw new g("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,a);let h=Ir[e.op].call(e,u,c,a);if(h.test===!1)throw new g("Test operation failed","TEST_OPERATION_FAILED",i,e,a);return h}}else if(l>=d){let h=ce[e.op].call(e,u,c,a);if(h.test===!1)throw new g("Test operation failed","TEST_OPERATION_FAILED",i,e,a);return h}if(u=u[c],t&&l<d&&(!u||typeof u!="object"))throw new g("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,a)}}}function te(a,e,t,r=!0,n=!0){if(t&&!Array.isArray(e))throw new g("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(a=A(a));let i=new Array(e.length);for(let s=0,o=e.length;s<o;s++)i[s]=ee(a,e[s],t,!0,n,s),a=i[s].newDocument;return i.newDocument=a,i}function Ar(a,e,t){let r=ee(a,e);if(r.test===!1)throw new g("Test operation failed","TEST_OPERATION_FAILED",t,e,a);return r.newDocument}function Ve(a,e,t,r){if(typeof a!="object"||a===null||Array.isArray(a))throw new g("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,a,t);if(ce[a.op]){if(typeof a.path!="string")throw new g("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,a,t);if(a.path.indexOf("/")!==0&&a.path.length>0)throw new g('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,a,t);if((a.op==="move"||a.op==="copy")&&typeof a.from!="string")throw new g("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,a,t);if((a.op==="add"||a.op==="replace"||a.op==="test")&&a.value===void 0)throw new g("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,a,t);if((a.op==="add"||a.op==="replace"||a.op==="test")&&Ne(a.value))throw new g("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,a,t);if(t){if(a.op=="add"){var n=a.path.split("/").length,i=r.split("/").length;if(n!==i+1&&n!==i)throw new g("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,a,t)}else if(a.op==="replace"||a.op==="remove"||a.op==="_get"){if(a.path!==r)throw new g("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,a,t)}else if(a.op==="move"||a.op==="copy"){var s={op:"_get",path:a.from,value:void 0},o=Wt([s],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new g("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,a,t)}}}else throw new g("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,a,t)}function Wt(a,e,t){try{if(!Array.isArray(a))throw new g("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)te(A(e),A(a),t||!0);else{t=t||Ve;for(var r=0;r<a.length;r++)t(a[r],r,e,void 0)}}catch(n){if(n instanceof g)return n;throw n}}function we(a,e){if(a===e)return!0;if(a&&e&&typeof a=="object"&&typeof e=="object"){var t=Array.isArray(a),r=Array.isArray(e),n,i,s;if(t&&r){if(i=a.length,i!=e.length)return!1;for(n=i;n--!==0;)if(!we(a[n],e[n]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(a);if(i=o.length,i!==Object.keys(e).length)return!1;for(n=i;n--!==0;)if(!e.hasOwnProperty(o[n]))return!1;for(n=i;n--!==0;)if(s=o[n],!we(a[s],e[s]))return!1;return!0}return a!==a&&e!==e}var Mn={...it,JsonPatchError:X,deepClone:A,escapePathComponent:$e,unescapePathComponent:be};import*as Xt from"/v135/uuid@10.0.0/denonext/uuid.mjs";import kr from"/v135/decamelize@1.2.0/denonext/decamelize.mjs";import Nn from"/v135/camelcase@6.3.0/denonext/camelcase.mjs";function qt(a,e){return e?.[a]||kr(a)}function Kt(a,e,t){let r={};for(let n in a)Object.hasOwn(a,n)&&(r[e(n,t)]=a[n]);return r}function Qt(a){return Array.isArray(a)?[...a]:{...a}}function Cr(a,e){let t=Qt(a);for(let[r,n]of Object.entries(e)){let[i,...s]=r.split(".").reverse(),o=t;for(let u of s.reverse()){if(o[u]===void 0)break;o[u]=Qt(o[u]),o=o[u]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[n]})}return t}function st(a){let e=Object.getPrototypeOf(a);return typeof a.lc_name=="function"&&(typeof e.lc_name!="function"||a.lc_name()!==e.lc_name())?a.lc_name():a.name}var C=class a{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,st(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof a||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((n,i)=>(n[i]=i in this?this[i]:this.lc_kwargs[i],n),{});for(let n=Object.getPrototypeOf(this);n;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n,"lc_aliases",this)),Object.assign(t,Reflect.get(n,"lc_secrets",this)),Object.assign(r,Reflect.get(n,"lc_attributes",this));return Object.keys(t).forEach(n=>{let i=this,s=r,[o,...u]=n.split(".").reverse();for(let l of u.reverse()){if(!(l in i)||i[l]===void 0)return;(!(l in s)||s[l]===void 0)&&(typeof i[l]=="object"&&i[l]!=null?s[l]={}:Array.isArray(i[l])&&(s[l]=[])),i=i[l],s=s[l]}o in i&&i[o]!==void 0&&(s[o]=s[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Kt(Object.keys(t).length?Cr(r,t):r,qt,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};var jr=()=>typeof window<"u"&&typeof window.document<"u",Rr=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Nr=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Yt=()=>typeof Deno<"u",Lr=()=>typeof __Process$<"u"&&typeof __Process$.versions<"u"&&typeof __Process$.versions.node<"u"&&!Yt(),$r=()=>{let a;return jr()?a="browser":Lr()?a="node":Rr()?a="webworker":Nr()?a="jsdom":Yt()?a="deno":a="other",a},ot;async function Zt(){return ot===void 0&&(ot={library:"langchain-js",runtime:$r()}),ot}function j(a){try{return typeof __Process$<"u"?__Process$.env?.[a]:void 0}catch{return}}var ut=class{},re=class a extends ut{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,st(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:j("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return C.prototype.toJSON.call(this)}toJSONNotImplemented(){return C.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends a{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Xt.v4()}),Object.assign(this,e)}}return new t}};function lt(a,e){return a&&!Array.isArray(a)&&typeof a=="object"?a:{[e]:a}}function Fr(a){return a.replace(/[-:.]/g,"")}function Vr(a,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return Fr(`${new Date(a).toISOString().slice(0,-1)}${r}Z`)+e}function de(a){return typeof a._addRunToRunMap=="function"}var k=class extends re{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let t=Vr(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let n=this.runMap.get(r.parent_run_id);n&&(this._addChildRun(n,r),n.child_execution_order=Math.max(n.child_execution_order,r.child_execution_order),r.trace_id=n.trace_id,n.dotted_order!==void 0&&(r.dotted_order=[n.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,n,i,s,o,u){let l=this._getExecutionOrder(n),d=Date.now(),f=o?{...i,metadata:o}:i,c={id:r,name:u??e.id[e.id.length-1],parent_run_id:n,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:s||[]};return this._addRunToRunMap(c)}async handleLLMStart(e,t,r,n,i,s,o,u){let l=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,n,i,s,o,u);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}_createRunForChatModelStart(e,t,r,n,i,s,o,u){let l=this._getExecutionOrder(n),d=Date.now(),f=o?{...i,metadata:o}:i,c={id:r,name:u??e.id[e.id.length-1],parent_run_id:n,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:s||[]};return this._addRunToRunMap(c)}async handleChatModelStart(e,t,r,n,i,s,o,u){let l=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,n,i,s,o,u);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}async handleLLMEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onLLMEnd?.(r),await this._endTrace(r),r}async handleLLMError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onLLMError?.(r),await this._endTrace(r),r}_createRunForChainStart(e,t,r,n,i,s,o,u){let l=this._getExecutionOrder(n),d=Date.now(),f={id:r,name:u??e.id[e.id.length-1],parent_run_id:n,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return this._addRunToRunMap(f)}async handleChainStart(e,t,r,n,i,s,o,u){let l=this.runMap.get(r)??this._createRunForChainStart(e,t,r,n,i,s,o,u);return await this.onRunCreate?.(l),await this.onChainStart?.(l),l}async handleChainEnd(e,t,r,n,i){let s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=lt(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),i?.inputs!==void 0&&(s.inputs=lt(i.inputs,"input")),await this.onChainEnd?.(s),await this._endTrace(s),s}async handleChainError(e,t,r,n,i){let s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),i?.inputs!==void 0&&(s.inputs=lt(i.inputs,"input")),await this.onChainError?.(s),await this._endTrace(s),s}_createRunForToolStart(e,t,r,n,i,s,o){let u=this._getExecutionOrder(n),l=Date.now(),d={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return this._addRunToRunMap(d)}async handleToolStart(e,t,r,n,i,s,o){let u=this.runMap.get(r)??this._createRunForToolStart(e,t,r,n,i,s,o);return await this.onRunCreate?.(u),await this.onToolStart?.(u),u}async handleToolEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;let n=r;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(e,t,r,n,i,s,o){let u=this._getExecutionOrder(n),l=Date.now(),d={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return this._addRunToRunMap(d)}async handleRetrieverStart(e,t,r,n,i,s,o){let u=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,n,i,s,o);return await this.onRunCreate?.(u),await this.onRetrieverStart?.(u),u}async handleRetrieverEnd(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,n,i,s){let o=this.runMap.get(r);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:s?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:s?.chunk}),o}};import{RunTree as Qr}from"/v135/langsmith@0.1.40/denonext/langsmith.mjs";import{v4 as pe}from"/v135/uuid@10.0.0/denonext/uuid.mjs";import er from"/v135/ansi-styles@5.2.0/denonext/ansi-styles.mjs";function S(a,e){return`${a.open}${e}${a.close}`}function R(a,e){try{return JSON.stringify(a,null,2)}catch{return e}}function Y(a){if(!a.end_time)return"";let e=a.end_time-a.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:I}=er,ye=class extends k{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let n=this.runMap.get(r.parent_run_id);if(n)t.push(n),r=n;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((n,i,s)=>{let o=`${n.execution_order}:${n.run_type}:${n.name}`;return i===s.length-1?S(er.bold,o):o}).join(" > ");return S(I.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.green,"[chain/start]")} [${t}] Entering Chain run with input: ${R(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.cyan,"[chain/end]")} [${t}] [${Y(e)}] Exiting Chain run with output: ${R(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.red,"[chain/error]")} [${t}] [${Y(e)}] Chain run errored with error: ${R(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(n=>n.trim())}:e.inputs;console.log(`${S(I.green,"[llm/start]")} [${t}] Entering LLM run with input: ${R(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.cyan,"[llm/end]")} [${t}] [${Y(e)}] Exiting LLM run with output: ${R(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.red,"[llm/error]")} [${t}] [${Y(e)}] LLM run errored with error: ${R(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.cyan,"[tool/end]")} [${t}] [${Y(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.red,"[tool/error]")} [${t}] [${Y(e)}] Tool run errored with error: ${R(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${R(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.cyan,"[retriever/end]")} [${t}] [${Y(e)}] Exiting Retriever run with output: ${R(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${S(I.red,"[retriever/error]")} [${t}] [${Y(e)}] Retriever run errored with error: ${R(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${S(I.blue,"[agent/action]")} [${r}] Agent selected action: ${R(t.actions[t.actions.length-1],"[action]")}`)}};function tr(a){if(typeof a>"u")return null;try{return JSON.parse(a)}catch{}let e="",t=[],r=!1,n=!1;for(let i of a){if(r)i==='"'&&!n?r=!1:i===`
`&&!n?i="\\n":i==="\\"?n=!n:n=!1;else if(i==='"')r=!0,n=!1;else if(i==="{")t.push("}");else if(i==="[")t.push("]");else if(i==="}"||i==="]")if(t&&t[t.length-1]===i)t.pop();else return null;e+=i}r&&(e+='"');for(let i=t.length-1;i>=0;i-=1)e+=t[i];try{return JSON.parse(e)}catch{return null}}function ne(a,e){return typeof a=="string"?typeof e=="string"?a+e:[{type:"text",text:a},...e]:Array.isArray(e)?De(a,e)??[...a,...e]:[...a,{type:"text",text:e}]}function Dr(a,e){function t(r,n){if(typeof r!="object"||r===null||r===void 0)return r;if(n>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(s=>t(s,n+1));let i={};for(let s of Object.keys(r))i[s]=t(r[s],n+1);return i}return JSON.stringify(t(a,0),null,2)}var _=class extends C{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=Dr(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};function H(a,e){let t={...a};for(let[r,n]of Object.entries(e))if(t[r]==null)t[r]=n;else{if(n==null)continue;if(typeof t[r]!=typeof n||Array.isArray(t[r])!==Array.isArray(n))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=n}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=H(t[r],n);else if(Array.isArray(t[r]))t[r]=De(t[r],n);else{if(t[r]===n)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function De(a,e){if(!(a===void 0&&e===void 0)){if(a===void 0||e===void 0)return a||e;{let t=[...a];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let n=t.findIndex(i=>i.index===r.index);n!==-1?t[n]=H(t[n],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}var W=class extends _{};function He(a){return typeof a?._getType=="function"}function rr(a){let e=[],t=[];for(let r of a)if(r.function){let n=r.function.name;try{let i=JSON.parse(r.function.arguments),s={name:n||"",args:i||{},id:r.id};e.push(s)}catch{t.push({name:n,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}var ae=class extends _{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;let n=r.additional_kwargs?.tool_calls,i=r.tool_calls;n!=null&&n.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(n!=null&&i===void 0){let[s,o]=rr(n);r.tool_calls=s??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}};var Z=class a extends W{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{let r=[],n=[];for(let i of e.tool_call_chunks){let s={};try{if(s=tr(i.args??"{}")??{},typeof s!="object"||Array.isArray(s))throw new Error("Malformed tool call chunk args.");r.push({name:i.name??"",args:s,id:i.id,type:"tool_call"})}catch{n.push({name:i.name,args:i.args,id:i.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:n}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){let t={content:ne(this.content,e.content),additional_kwargs:H(this.additional_kwargs,e.additional_kwargs),response_metadata:H(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let r=De(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},n=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i={input_tokens:r.input_tokens+n.input_tokens,output_tokens:r.output_tokens+n.output_tokens,total_tokens:r.total_tokens+n.total_tokens};t.usage_metadata=i}return new a(t)}};var ie=class a extends _{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return a}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}};var N=class extends _{static lc_name(){return"HumanMessage"}_getType(){return"human"}};var se=class extends _{static lc_name(){return"SystemMessage"}_getType(){return"system"}};function nr(a){let{type:e,...t}=a;if(e==="human"||e==="user")return new N(t);if(e==="ai"||e==="assistant")return new ae(t);if(e==="system")return new se(t);throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function Be(a){if(typeof a=="string")return new N(a);if(He(a))return a;if(Array.isArray(a)){let[e,t]=a;return nr({type:e,content:t})}else return nr(a)}function Ue(a,e="Human",t="AI"){let r=[];for(let n of a){let i;if(n._getType()==="human")i=e;else if(n._getType()==="ai")i=t;else if(n._getType()==="system")i="System";else if(n._getType()==="function")i="Function";else if(n._getType()==="tool")i="Tool";else if(n._getType()==="generic")i=n.role;else throw new Error(`Got unsupported message type: ${n._getType()}`);let s=n.name?`${n.name}, `:"",o=typeof n.content=="string"?n.content:JSON.stringify(n.content,null,2);r.push(`${i}: ${s}${o}`)}return r.join(`
`)}import{Client as zr}from"/v135/langsmith@0.1.40/denonext/langsmith.mjs";import{RunTree as Wr}from"/v135/langsmith@0.1.40/denonext/run_trees.js";import{getCurrentRunTree as qr}from"/v135/langsmith@0.1.40/denonext/singletons/traceable.js";var fe=class a extends k{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:n}=e;this.projectName=r??j("LANGCHAIN_PROJECT")??j("LANGCHAIN_SESSION"),this.exampleId=t,this.client=n??new zr({});let i=a.getTraceableRunTree();i&&this.updateFromRunTree(i)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Zt()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e,r=new Set;for(;t.parent_run&&!(r.has(t.id)||(r.add(t.id),!t.parent_run));)t=t.parent_run;r.clear();let n=[t];for(;n.length>0;){let i=n.shift();!i||r.has(i.id)||(r.add(i.id),this.runMap.set(i.id,i),i.child_runs&&n.push(...i.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){let t={},r=[];for(let[n,i]of this.runMap){let s=new Wr({...i,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[n]=s,r.push([n,i.dotted_order])}r.sort((n,i)=>!n[1]||!i[1]?0:n[1].localeCompare(i[1]));for(let[n]of r){let i=this.runMap.get(n),s=t[n];if(!(!i||!s)&&i.parent_run_id){let o=t[i.parent_run_id];o&&(o.child_runs.push(s),s.parent_run=o)}}return t[e]}static getTraceableRunTree(){try{return qr()}catch{return}}};import ct from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var dt;function Kr(){let a="default"in ct?ct.default:ct;return new a({autoStart:!0,concurrency:1})}async function b(a,e){e===!0?await a():(typeof dt>"u"&&(dt=Kr()),dt.add(a))}var ft=a=>a!==void 0?a:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>j(t)==="true");ft()&&j("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);var pt=class{setHandler(e){return this.setHandlers([e])}},he=class{constructor(e,t,r,n,i,s,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>b(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,n,i){await Promise.all(this.handlers.map(s=>b(async()=>{try{await s.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}},ht=class extends he{getChild(e){let t=new B(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}},Ge=class extends he{async handleLLMNewToken(e,t,r,n,i,s){await Promise.all(this.handlers.map(o=>b(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s)}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},mt=class extends he{getChild(e){let t=new B(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,n,i){await Promise.all(this.handlers.map(s=>b(async()=>{if(!s.ignoreChain)try{await s.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleChainError: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleChainEnd(e,t,r,n,i){await Promise.all(this.handlers.map(s=>b(async()=>{if(!s.ignoreChain)try{await s.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleChainEnd: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},gt=class extends he{getChild(e){let t=new B(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}},B=class a extends pt{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,d)=>{let f=d===0&&r?r:pe();return await Promise.all(this.handlers.map(c=>{if(!c.ignoreLLM)return de(c)&&c._createRunForLLMStart(e,[l],f,this._parentRunId,i,this.tags,this.metadata,u),b(async()=>{try{await c.handleLLMStart?.(e,[l],f,this._parentRunId,i,this.tags,this.metadata,u)}catch(p){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleLLMStart: ${p}`),c.raiseError)throw p}},c.awaitHandlers)})),new Ge(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,n=void 0,i=void 0,s=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,d)=>{let f=d===0&&r?r:pe();return await Promise.all(this.handlers.map(c=>{if(!c.ignoreLLM)return de(c)&&c._createRunForChatModelStart(e,[l],f,this._parentRunId,i,this.tags,this.metadata,u),b(async()=>{try{if(c.handleChatModelStart)await c.handleChatModelStart?.(e,[l],f,this._parentRunId,i,this.tags,this.metadata,u);else if(c.handleLLMStart){let p=Ue(l);await c.handleLLMStart?.(e,[p],f,this._parentRunId,i,this.tags,this.metadata,u)}}catch(p){if((c.raiseError?console.error:console.warn)(`Error in handler ${c.constructor.name}, handleLLMStart: ${p}`),c.raiseError)throw p}},c.awaitHandlers)})),new Ge(f,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=pe(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return de(u)&&u._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,n,o),b(async()=>{try{await u.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,n,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new mt(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=pe(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return de(u)&&u._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),b(async()=>{try{await u.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new gt(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=pe(),n=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return de(u)&&u._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),b(async()=>{try{await u.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new ht(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,n,i){await Promise.all(this.handlers.map(s=>b(async()=>{if(!s.ignoreCustomEvent)try{await s.handleCustomEvent?.(e,t,r,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new a(this._parentRunId);for(let n of this.handlers){let i=this.inheritableHandlers.includes(n);r.addHandler(n,i)}for(let n of this.tags){let i=this.inheritableTags.includes(n);r.addTags([n],i)}for(let n of Object.keys(this.metadata)){let i=Object.keys(this.inheritableMetadata).includes(n);r.addMetadata({[n]:this.metadata[n]},i)}for(let n of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){class t extends re{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:pe()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,n,i,s,o){return this._configureSync(e,t,r,n,i,s,o)}static _configureSync(e,t,r,n,i,s,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new a,u.setHandlers(e?.map(_e)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(_e):t?.handlers,!1));let l=j("LANGCHAIN_VERBOSE")==="true"||o?.verbose,d=fe.getTraceableRunTree()?.tracingEnabled||ft(),f=d||(j("LANGCHAIN_TRACING")??!1);if(l||f){if(u||(u=new a),l&&!u.handlers.some(c=>c.name===ye.prototype.name)){let c=new ye;u.addHandler(c,!0)}if(f&&!u.handlers.some(c=>c.name==="langchain_tracer")&&d){let c=new fe;u.addHandler(c,!0),u._parentRunId=fe.getTraceableRunTree()?.id??u._parentRunId}}return(r||n)&&u&&(u.addTags(r??[]),u.addTags(n??[],!1)),(i||s)&&u&&(u.addMetadata(i??{}),u.addMetadata(s??{},!1)),u}};function _e(a){return"name"in a?a:re.fromMethods(a)}var wt=class{getStore(){}run(e,t){return t()}},Yr=new wt,bt=Symbol.for("ls:tracing_async_local_storage"),ir=Symbol.for("lc:child_config"),yt=class{getInstance(){return globalThis[bt]??Yr}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[ir]}runWithConfig(e,t,r){let n=B._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),i=this.getInstance(),s=n?.getParentRunId(),o=n?.handlers?.find(l=>l?.name==="langchain_tracer"),u;return o&&s?u=o.convertToRunTree(s):r||(u=new Qr({name:"<runnable_lambda>",tracingEnabled:!1})),u&&(u.extra={...u.extra,[ir]:e}),i.run(u,t)}initializeGlobalInstance(e){globalThis[bt]===void 0&&(globalThis[bt]=e)}},L=new yt;async function U(a,e){return e===void 0?a:Promise.race([a.catch(t=>{if(!e?.aborted)throw t}),new Promise((t,r)=>{e.addEventListener("abort",()=>{r(new Error("Aborted"))}),e.aborted&&r(new Error("Aborted"))})])}var x=class a extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new a({start(r){return n();function n(){return t.read().then(({done:i,value:s})=>{if(i){r.close();return}return r.enqueue(s),n()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new a({async pull(t){let{value:r,done:n}=await e.next();n&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function _t(a,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(n){for(;;)if(n.length===0){let i=await a.next();for(let s of t)s.push(i)}else{if(n[0].done)return;yield n.shift().value}})}function K(a,e){if(Array.isArray(a)&&Array.isArray(e))return a.concat(e);if(typeof a=="string"&&typeof e=="string")return a+e;if(typeof a=="number"&&typeof e=="number")return a+e;if("concat"in a&&typeof a.concat=="function")return a.concat(e);if(typeof a=="object"&&typeof e=="object"){let t={...a};for(let[r,n]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=K(t[r],n):t[r]=n;return t}else throw new Error(`Cannot concat ${typeof a} and ${typeof e}`)}var q=class{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,r)=>{L.runWithConfig(e.config,async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(n=>t(void 0),r)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?L.runWithConfig(this.config,this.signal?async()=>U(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}};async function sr(a,e,t,r,...n){let i=new q({generator:e,startSetup:t,signal:r}),s=await i.setup;return{output:a(i,s,...n),setup:s}}var $=class{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=te({},t);return new ve({ops:t,state:r[r.length-1].newDocument})}},ve=class a extends ${constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=te(this.state,e.ops);return new a({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=te({},e.ops);return new a({ops:e.ops,state:t[t.length-1].newDocument})}},lr=a=>a.name==="log_stream_tracer";async function or(a,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=a;if(["retriever","llm","prompt"].includes(a.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function ur(a,e){let{outputs:t}=a;return e==="original"||["retriever","llm","prompt"].includes(a.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function Zr(a){return a!==void 0&&a.message!==void 0}var xe=class extends k{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=x.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(n=>this.includeTags?.includes(n))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(n=>!this.excludeTags?.includes(n))),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let n=this.keyMapByRunId[e];n&&await this.writer.write(new $({ops:[{op:"add",path:`/logs/${n}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new $({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await or(e,this._schemaFormat)),await this.writer.write(new $({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await or(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await ur(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let n=new $({ops:r});await this.writer.write(n)}finally{if(e.id===this.rootId){let t=new $({ops:[{op:"replace",path:"/final_output",value:await ur(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let n=this.keyMapByRunId[e.id];if(n===void 0)return;let i=e.inputs.messages!==void 0,s;i?Zr(r?.chunk)?s=r?.chunk:s=new Z(t):s=t;let o=new $({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${n}/streamed_output/-`,value:s}]});await this.writer.write(o)}};var Oe=class a{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new a({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}};function Je({name:a,serialized:e}){return a!==void 0?a:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}var cr=a=>a.name==="event_stream_tracer",ze=class extends k{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=x.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(n=>this.includeTags?.includes(n))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(n=>!this.excludeTags?.includes(n))),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let n=this.runInfoMap.get(e);if(n===void 0){yield r.value;return}function i(o,u){return o==="llm"&&typeof u=="string"?new Oe({text:u}):u}let s=this.tappedPromises.get(e);if(s===void 0){let o;s=new Promise(u=>{o=u}),this.tappedPromises.set(e,s);try{let u={event:`on_${n.runType}_stream`,run_id:e,name:n.name,tags:n.tags,metadata:n.metadata,data:{}};await this.send({...u,data:{chunk:i(n.runType,r.value)}},n),yield r.value;for await(let l of t)n.runType!=="tool"&&n.runType!=="retriever"&&await this.send({...u,data:{chunk:i(n.runType,l)}},n),yield l}finally{o()}}else{yield r.value;for await(let o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=Je(e),r=e.inputs.messages!==void 0?"chat_model":"llm",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,n);let i=`on_${r}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onLLMNewToken(e,t,r){let n=this.runInfoMap.get(e.id),i,s;if(n===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(e.parent_run_id!==void 0){if(n.runType==="chat_model")s="on_chat_model_stream",r?.chunk===void 0?i=new Z({content:t}):i=r.chunk.message;else if(n.runType==="llm")s="on_llm_stream",r?.chunk===void 0?i=new Oe({text:t}):i=r.chunk;else throw new Error(`Unexpected run type ${n.runType}`);await this.send({event:s,data:{chunk:i},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(e){let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let n=e.outputs?.generations,i;if(t.runType==="chat_model"){for(let s of n??[]){if(i!==void 0)break;i=s[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")i={generations:n?.map(s=>s.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:i,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){let t=Je(e),r=e.run_type??"chain",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},n.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,n.inputs=e.inputs.input):(i.input=e.inputs,n.inputs=e.inputs),this.runInfoMap.set(e.id,n),await this.send({event:`on_${r}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,n=e.inputs??t.inputs??{},s={output:e.outputs?.output??e.outputs,input:n};n.input&&Object.keys(n).length===1&&(s.input=n.input,t.inputs=n.input),await this.sendEndEvent({event:r,data:s,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=Je(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=Je(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){let n=this.runInfoMap.get(r);if(n===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:n.tags,metadata:n.metadata,data:t},n)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};var We=25;async function F(a){return B._configureSync(a?.callbacks,void 0,a?.tags,void 0,a?.metadata)}function vt(...a){let e={};for(let t of a.filter(r=>!!r))for(let r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){let n=e[r]??[];e[r]=[...new Set(n.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(r==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(r==="callbacks"){let n=e.callbacks,i=t.callbacks;if(Array.isArray(i))if(!n)e.callbacks=i;else if(Array.isArray(n))e.callbacks=n.concat(i);else{let s=n.copy();for(let o of i)s.addHandler(_e(o),!0);e.callbacks=s}else if(i)if(!n)e.callbacks=i;else if(Array.isArray(n)){let s=i.copy();for(let o of n)s.addHandler(_e(o),!0);e.callbacks=s}else e.callbacks=new B(i._parentRunId,{handlers:n.handlers.concat(i.handlers),inheritableHandlers:n.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(n.tags.concat(i.tags))),inheritableTags:Array.from(new Set(n.inheritableTags.concat(i.inheritableTags))),metadata:{...n.metadata,...i.metadata}})}else{let n=r;e[n]=t[n]??e[n]}return e}var Xr=new Set(["string","number","boolean"]);function m(a){let e=L.getRunnableConfig(),t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){let{runId:r,runName:n,...i}=e;t=Object.entries(i).reduce((s,[o,u])=>(u!==void 0&&(s[o]=u),s),t)}if(a&&(t=Object.entries(a).reduce((r,[n,i])=>(i!==void 0&&(r[n]=i),r),t)),t?.configurable)for(let r of Object.keys(t.configurable))Xr.has(typeof t.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=t.configurable[r]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");let r=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,r])):t.signal=r,delete t.timeout}return t}function O(a={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:n,configurable:i,runId:s}={}){let o=m(a);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),n!==void 0&&(o.runName=n),i!==void 0&&(o.configurable={...o.configurable,...i}),s!==void 0&&delete o.runId,o}import en from"/v135/p-retry@4.6.2/denonext/p-retry.mjs";import xt from"/v135/p-queue@6.6.2/denonext/p-queue.mjs";var tn=[400,401,402,403,404,405,406,407,409],rn=a=>{if(a.message.startsWith("Cancel")||a.message.startsWith("AbortError")||a.name==="AbortError"||a?.code==="ECONNABORTED")throw a;let e=a?.response?.status??a?.status;if(e&&tn.includes(+e))throw a;if(a?.error?.code==="insufficient_quota"){let t=new Error(a?.message);throw t.name="InsufficientQuotaError",t}},qe=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??rn;let t="default"in xt?xt.default:xt;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>en(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((n,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var Ee=class extends k{constructor({config:e,onStart:t,onEnd:r,onError:n}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=n}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}};function Pe(a){return a?a.lc_runnable:!1}var Ke=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,n=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||n.some(i=>this.includeTags?.includes(i))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&n.every(i=>!this.excludeTags?.includes(i))),r}};import{zodToJsonSchema as sn}from"/v135/zod-to-json-schema@3.23.2/denonext/zod-to-json-schema.mjs";import{v4 as on,validate as Pt}from"/v135/uuid@10.0.0/denonext/uuid.mjs";function Ot(a){return a.replace(/[^a-zA-Z-_0-9]/g,"_")}function nn(a,e){let t=e[a.source]??a.source,r=e[a.target]??a.target;return[t,r]}function an(a){let e="";for(let[t,r]of Object.entries(a))e+=`	classDef ${t}class fill:${r};
`;return e}function dr(a,e,t){let{firstNodeLabel:r,lastNodeLabel:n,nodeColors:i,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{},l=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(s){let f="default",c={[f]:"{0}([{1}]):::otherclass"};r!==void 0&&(c[r]="{0}[{0}]:::startclass"),n!==void 0&&(c[n]="{0}[{0}]:::endclass");for(let p of Object.values(a)){let h=c[p]??c[f],z=Ot(p),M=p.split(":"),P=M[M.length-1];l+=`	${h.replace(/\{0\}/g,z).replace(/\{1\}/g,P)};
`}}let d="";for(let f of e){let c=f.source.includes(":")?f.source.split(":")[0]:void 0,p=f.target.includes(":")?f.target.split(":")[0]:void 0;d!==""&&(d!==c||d!==p)&&(l+=`	end
`,d=""),d===""&&c!==void 0&&c===p&&(l=`	subgraph ${c}
`,d=c);let[h,z]=nn(f,a),M="";if(f.data!==void 0){let P=f.data,T=P.split(" ");T.length>u&&(P=T.reduce((v,D,y)=>(y%u===0&&v.push(""),v[v.length-1]+=` ${D}`,v),[]).join("<br>")),f.conditional?M=` -. ${P} .-> `:M=` -- ${P} --> `}else f.conditional?M=" -.-> ":M=" --> ";l+=`	${Ot(h)}${M}${Ot(z)};
`}return d!==""&&(l+=`end
`),s&&i!==void 0&&(l+=an(i)),l}async function fr(a,e){let{backgroundColor:t="white"}=e??{},r=btoa(a);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));let n=`https://mermaid.ink/img/${r}?bgColor=${t}`,i=await fetch(n);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join(`
`));return await i.blob()}var pr=42;function Et(a){if(Pt(a.id))if(Pe(a.data))try{let e=a.data.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e.length>pr&&(e=`${e.substring(0,pr)}...`),e}catch{return a.data.getName()}else return a.data.name??"UnknownSchema";else return a.id}function un(a){return Pe(a.data)?{type:"runnable",data:{id:a.data.lc_id,name:a.data.getName()}}:{type:"schema",data:{...sn(a.data.schema),title:a.data.name}}}var Te=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Pt(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...un(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||on(),n={id:r,data:e};return this.nodes[r]=n,n}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,n){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let i={source:e.id,target:t.id,data:r,conditional:n};return this.edges.push(i),i}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e,t=""){let r=t;Object.values(e.nodes).map(l=>l.id).every(Pt)&&(r="");let i=l=>r?`${r}:${l}`:l;Object.entries(e.nodes).forEach(([l,d])=>{this.nodes[i(l)]={...d,id:i(l)}});let s=e.edges.map(l=>({...l,source:i(l.source),target:i(l.target)}));this.edges=[...this.edges,...s];let o=e.firstNode(),u=e.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,u?{id:i(u.id),data:u.data}:void 0]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}drawMermaid(e){let{withStyles:t,curveStyle:r,nodeColors:n={start:"#ffdfba",end:"#baffc9",other:"#fad7de"},wrapLabelNWords:i}=e??{},s={};for(let f of Object.values(this.nodes))s[f.id]=Et(f);let o=this.firstNode(),u=o?Et(o):void 0,l=this.lastNode(),d=l?Et(l):void 0;return dr(s,this.edges,{firstNodeLabel:u,lastNodeLabel:d,withStyles:t,curveStyle:r,nodeColors:n,wrapLabelNWords:i})}async drawMermaidPng(e){let t=this.drawMermaid(e);return fr(t,{backgroundColor:e?.backgroundColor})}};function hr(a){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let n of a)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(n)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return x.fromReadableStream(t)}function Tt(a){return typeof a=="object"&&a!==null&&typeof a[Symbol.iterator]=="function"&&typeof a.next=="function"}var mr=a=>a!=null&&typeof a=="object"&&"next"in a&&typeof a.next=="function";function Qe(a){return typeof a=="object"&&a!==null&&typeof a[Symbol.asyncIterator]=="function"}function*St(a,e){for(;;){let{value:t,done:r}=L.runWithConfig(a,e.next.bind(e),!0);if(r)break;yield t}}async function*Mt(a,e){let t=e[Symbol.asyncIterator]();for(;;){let{value:r,done:n}=await L.runWithConfig(a,t.next.bind(e),!0);if(n)break;yield r}}function gr(a){return!!(a&&typeof a=="object"&&"type"in a&&a.type==="tool_call")}var Ye=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}};function E(a,e){return a&&!Array.isArray(a)&&!(a instanceof Date)&&typeof a=="object"?a:{[e]:a}}var w=class extends C{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new ue({bound:this,kwargs:e,config:{}})}map(){return new It({bound:this})}withRetry(e){return new At({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new ue({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Ct({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(m);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([n])=>n!=="runId"));return Array.from({length:t},(n,i)=>m(i===0?e:r))}return Array.from({length:t},()=>m(e))}async batch(e,t,r){let n=this._getOptionsList(t??{},e.length),i=n[0]?.maxConcurrency??r?.maxConcurrency,s=new qe({maxConcurrency:i,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>s.call(async()=>{try{return await this.invoke(u,n[l])}catch(d){if(r?.returnExceptions)return d;throw d}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=m(t),n=new q({generator:this._streamIterator(e,r),config:r});return await n.setup,x.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=m(e):t=m({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){let n=m(r),s=await(await F(n))?.handleChainStart(this.toJSON(),E(t,"input"),n.runId,n?.runType,void 0,void 0,n?.runName??this.getName());delete n.runId;let o;try{let u=e.call(this,t,n,s);o=await U(u,r?.signal)}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd(E(o,"output")),o}async _batchWithConfig(e,t,r,n){let i=this._getOptionsList(r??{},t.length),s=await Promise.all(i.map(F)),o=await Promise.all(s.map(async(l,d)=>{let f=await l?.handleChainStart(this.toJSON(),E(t[d],"input"),i[d].runId,i[d].runType,void 0,void 0,i[d].runName??this.getName());return delete i[d].runId,f})),u;try{let l=e.call(this,t,i,o,n);u=await U(l,i?.[0]?.signal)}catch(l){throw await Promise.all(o.map(d=>d?.handleChainError(l))),l}return await Promise.all(o.map(l=>l?.handleChainEnd(E(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let n,i=!0,s,o=!0,u=m(r),l=await F(u);async function*d(){for await(let c of e){if(i)if(n===void 0)n=c;else try{n=K(n,c)}catch{n=void 0,i=!1}yield c}}let f;try{let c=await sr(t.bind(this),d(),async()=>l?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),r?.signal,u);delete u.runId,f=c.setup;let p=f?.handlers.find(cr),h=c.output;p!==void 0&&f!==void 0&&(h=p.tapOutputIterable(f.runId,h));let z=f?.handlers.find(lr);z!==void 0&&f!==void 0&&(h=z.tapOutputIterable(f.runId,h));for await(let M of h)if(yield M,o)if(s===void 0)s=M;else try{s=K(s,M)}catch{s=void 0,o=!1}}catch(c){throw await f?.handleChainError(c,void 0,void 0,void 0,{inputs:E(n,"input")}),c}await f?.handleChainEnd(s??{},void 0,void 0,void 0,{inputs:E(n,"input")})}getGraph(e){let t=new Te,r=t.addNode({name:`${this.getName()}Input`,schema:Se.any()}),n=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:Se.any()});return t.addEdge(r,n),t.addEdge(n,i),t}pipe(e){return new Ze({first:this,last:oe(e)})}pick(e){return this.pipe(new Rt(e))}assign(e){return this.pipe(new jt(new Me({steps:e})))}async*transform(e,t){let r;for await(let n of e)r===void 0?r=n:r=K(r,n);yield*this._streamIterator(r,m(t))}async*streamLog(e,t,r){let n=new xe({...r,autoClose:!1,_schemaFormat:"original"}),i=m(t);yield*this._streamLog(e,n,i)}async*_streamLog(e,t,r){let{callbacks:n}=r;if(n===void 0)r.callbacks=[t];else if(Array.isArray(n))r.callbacks=n.concat([t]);else{let u=n.copy();u.inheritableHandlers.push(t),r.callbacks=u}let i=this.stream(e,r);async function s(){try{let u=await i;for await(let l of u){let d=new $({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(d)}}finally{await t.writer.close()}}let o=s();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,r){let n;if(t.version==="v1")n=this._streamEventsV1(e,t,r);else if(t.version==="v2")n=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?hr(n):x.fromAsyncGenerator(n)}async*_streamEventsV2(e,t,r){let n=new ze({...r,autoClose:!1}),i=m(t),s=i.runId??ln();i.runId=s;let o=i.callbacks;if(o===void 0)i.callbacks=[n];else if(Array.isArray(o))i.callbacks=o.concat(n);else{let p=o.copy();p.inheritableHandlers.push(n),i.callbacks=p}let u=this;async function l(){try{let p=await u.stream(e,i),h=n.tapOutputIterable(s,p);for await(let z of h);}finally{await n.finish()}}let d=l(),f=!1,c;try{for await(let p of n){if(!f){p.data.input=e,f=!0,c=p.run_id,yield p;continue}p.run_id===c&&p.event.endsWith("_end")&&p.data?.input&&delete p.data.input,yield p}}finally{await d}}async*_streamEventsV1(e,t,r){let n,i=!1,s=m(t),o=s.tags??[],u=s.metadata??{},l=s.runName??this.getName(),d=new xe({...r,autoClose:!1,_schemaFormat:"streaming_events"}),f=new Ke({...r}),c=this._streamLog(e,d,s);for await(let h of c){if(n?n=n.concat(h):n=ve.fromRunLogPatch(h),n.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;let T={...n.state},v={run_id:T.id,event:`on_${T.type}_start`,name:l,tags:o,metadata:u,data:{input:e}};f.includeEvent(v,T.type)&&(yield v)}let z=h.ops.filter(T=>T.path.startsWith("/logs/")).map(T=>T.path.split("/")[2]),M=[...new Set(z)];for(let T of M){let v,D={},y=n.state.logs[T];if(y.end_time===void 0?y.streamed_output.length>0?v="stream":v="start":v="end",v==="start")y.inputs!==void 0&&(D.input=y.inputs);else if(v==="end")y.inputs!==void 0&&(D.input=y.inputs),D.output=y.final_output;else if(v==="stream"){let Ut=y.streamed_output.length;if(Ut!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${Ut} instead. Encountered in: "${y.name}"`);D={chunk:y.streamed_output[0]},y.streamed_output=[]}yield{event:`on_${y.type}_${v}`,name:y.name,run_id:y.id,tags:y.tags,metadata:y.metadata,data:D}}let{state:P}=n;if(P.streamed_output.length>0){let T=P.streamed_output.length;if(T!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${T} instead. Encountered in: "${P.name}"`);let v={chunk:P.streamed_output[0]};P.streamed_output=[];let D={event:`on_${P.type}_stream`,run_id:P.id,tags:o,metadata:u,name:l,data:v};f.includeEvent(D,P.type)&&(yield D)}}let p=n?.state;if(p!==void 0){let h={event:`on_${p.type}_end`,name:l,run_id:p.id,tags:o,metadata:u,data:{output:p.final_output}};f.includeEvent(h,p.type)&&(yield h)}}static isRunnable(e){return Pe(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new ue({bound:this,config:{},configFactories:[n=>({callbacks:[new Ee({config:n,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return dn(this,e)}},ue=class a extends w{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=vt(this.config,...e);return vt(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(m(t),this.kwargs))}async batch(e,t,r){let n=Array.isArray(t)?await Promise.all(t.map(async i=>this._mergeConfig(m(i),this.kwargs))):await this._mergeConfig(m(t),this.kwargs);return this.bound.batch(e,n,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(m(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(m(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(m(t),this.kwargs))}streamEvents(e,t,r){let n=this,i=async function*(){yield*n.bound.streamEvents(e,{...await n._mergeConfig(m(t),n.kwargs),version:t.version},r)};return x.fromAsyncGenerator(i())}static isRunnableBinding(e){return e.bound&&w.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new a({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[n=>({callbacks:[new Ee({config:n,onStart:e,onEnd:t,onError:r})]})]})}},It=class a extends w{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new a({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,O(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new a({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},At=class extends ue{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let n=e>1?`retry:attempt:${e}`:void 0;return O(t,{callbacks:r?.getChild(n)})}async _invoke(e,t,r){return br(n=>super.invoke(e,this._patchConfigForRetry(n,t,r)),{onFailedAttempt:n=>this.onFailedAttempt(n,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,n){let i={};try{await br(async s=>{let o=e.map((c,p)=>p).filter(c=>i[c.toString()]===void 0||i[c.toString()]instanceof Error),u=o.map(c=>e[c]),l=o.map(c=>this._patchConfigForRetry(s,t?.[c],r?.[c])),d=await super.batch(u,l,{...n,returnExceptions:!0}),f;for(let c=0;c<d.length;c+=1){let p=d[c],h=o[c];p instanceof Error&&f===void 0&&(f=p,f.input=u[c]),i[h.toString()]=p}if(f)throw f;return d},{onFailedAttempt:s=>this.onFailedAttempt(s,s.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(s){if(n?.returnExceptions!==!0)throw s}return Object.keys(i).sort((s,o)=>parseInt(s,10)-parseInt(o,10)).map(s=>i[parseInt(s,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Ze=class a extends w{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=m(t),i=await(await F(r))?.handleChainStart(this.toJSON(),E(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let s=e,o;try{let u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1){let f=u[l].invoke(s,O(r,{callbacks:i?.getChild(`seq:step:${l+1}`)}));s=await U(f,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");o=await this.last.invoke(s,O(r,{callbacks:i?.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(E(o,"output")),o}async batch(e,t,r){let n=this._getOptionsList(t??{},e.length),i=await Promise.all(n.map(F)),s=await Promise.all(i.map(async(u,l)=>{let d=await u?.handleChainStart(this.toJSON(),E(e[l],"input"),n[l].runId,void 0,void 0,void 0,n[l].runName);return delete n[l].runId,d})),o=e;try{for(let u=0;u<this.steps.length;u+=1){let d=this.steps[u].batch(o,s.map((f,c)=>{let p=f?.getChild(`seq:step:${u+1}`);return O(n[c],{callbacks:p})}),r);o=await U(d,n[0]?.signal)}}catch(u){throw await Promise.all(s.map(l=>l?.handleChainError(u))),u}return await Promise.all(s.map(u=>u?.handleChainEnd(E(o,"output")))),o}async*_streamIterator(e,t){let r=await F(t),{runId:n,...i}=t??{},s=await r?.handleChainStart(this.toJSON(),E(e,"input"),n,void 0,void 0,void 0,i?.runName),o=[this.first,...this.middle,this.last],u=!0,l;async function*d(){yield e}try{let f=o[0].transform(d(),O(i,{callbacks:s?.getChild("seq:step:1")}));for(let c=1;c<o.length;c+=1)f=await o[c].transform(f,O(i,{callbacks:s?.getChild(`seq:step:${c+1}`)}));for await(let c of f)if(t?.signal?.throwIfAborted(),yield c,u)if(l===void 0)l=c;else try{l=K(l,c)}catch{l=void 0,u=!1}}catch(f){throw await s?.handleChainError(f),f}await s?.handleChainEnd(E(l,"output"))}getGraph(e){let t=new Te,r=null;return this.steps.forEach((n,i)=>{let s=n.getGraph(e);i!==0&&s.trimFirstNode(),i!==this.steps.length-1&&s.trimLastNode(),t.extend(s);let o=s.firstNode();if(!o)throw new Error(`Runnable ${n} has no first node`);r&&t.addEdge(r,o),r=s.lastNode()}),t}pipe(e){return a.isRunnableSequence(e)?new a({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new a({first:this.first,middle:[...this.middle,this.last],last:oe(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&w.isRunnable(e)}static from([e,...t],r){return new a({first:oe(e),middle:t.slice(0,-1).map(oe),last:oe(t[t.length-1]),name:r})}},Me=class a extends w{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=oe(r)}static from(e){return new a({steps:e})}async invoke(e,t){let r=m(t),i=await(await F(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let s={};try{let o=Object.entries(this.steps).map(async([u,l])=>{s[u]=await l.invoke(e,O(r,{callbacks:i?.getChild(`map:key:${u}`)}))});await U(Promise.all(o),t?.signal)}catch(o){throw await i?.handleChainError(o),o}return await i?.handleChainEnd(s),s}async*_transform(e,t,r){let n={...this.steps},i=_t(e,Object.keys(n).length),s=new Map(Object.entries(n).map(([o,u],l)=>{let d=u.transform(i[l],O(r,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,d.next().then(f=>({key:o,gen:d,result:f}))]}));for(;s.size;){let o=Promise.race(s.values()),{key:u,result:l,gen:d}=await U(o,r?.signal);s.delete(u),l.done||(yield{[u]:l.value},s.set(u,d.next().then(f=>({key:u,gen:d,result:f}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let n=m(t),i=new q({generator:this.transform(r(),n),config:n});return await i.setup,x.fromAsyncGenerator(i)}},kt=class a extends w{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Nt(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),n=await F(r),i=this.func(O(r,{callbacks:n}),e);return U(i,r?.signal)}async*_streamIterator(e,t){let[r]=this._getOptionsList(t??{},1),n=await this.invoke(e,t);if(Qe(n)){for await(let i of n)r?.signal?.throwIfAborted(),yield i;return}if(mr(n)){for(;;){r?.signal?.throwIfAborted();let i=n.next();if(i.done)break;yield i.value}return}yield n}static from(e){return new a({func:e})}};function cn(a){if(Nt(a))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var Ie=class a extends w{static lc_name(){return"RunnableLambda"}constructor(e){if(Nt(e.func))return kt.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),cn(e.func),this.func=e.func}static from(e){return new a({func:e})}async _invoke(e,t,r){return new Promise((n,i)=>{let s=O(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??We)-1});L.runWithConfig(s,async()=>{try{let o=await this.func(e,{...s,config:s});if(o&&w.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...s,recursionLimit:(s.recursionLimit??We)-1})}else if(Qe(o)){let u;for await(let l of Mt(s,o))if(t?.signal?.throwIfAborted(),u===void 0)u=l;else try{u=K(u,l)}catch{u=l}o=u}else if(Tt(o)){let u;for(let l of St(s,o))if(t?.signal?.throwIfAborted(),u===void 0)u=l;else try{u=K(u,l)}catch{u=l}o=u}n(o)}catch(o){i(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let n;for await(let o of e)if(n===void 0)n=o;else try{n=K(n,o)}catch{n=o}let i=O(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??We)-1}),s=await new Promise((o,u)=>{L.runWithConfig(i,async()=>{try{let l=await this.func(n,{...i,config:i});o(l)}catch(l){u(l)}})});if(s&&w.isRunnable(s)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");let o=await s.stream(n,i);for await(let u of o)yield u}else if(Qe(s))for await(let o of Mt(i,s))r?.signal?.throwIfAborted(),yield o;else if(Tt(s))for(let o of St(i,s))r?.signal?.throwIfAborted(),yield o;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let n=m(t),i=new q({generator:this.transform(r(),n),config:n});return await i.setup,x.fromAsyncGenerator(i)}};var Ct=class extends w{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=m(t),n=await F(t),{runId:i,...s}=r,o=await n?.handleChainStart(this.toJSON(),E(e,"input"),i,void 0,void 0,void 0,s?.runName),u;for(let l of this.runnables()){r?.signal?.throwIfAborted();try{let d=await l.invoke(e,O(s,{callbacks:o?.getChild()}));return await o?.handleChainEnd(E(d,"output")),d}catch(d){u===void 0&&(u=d)}}throw u===void 0?new Error("No error stored at end of fallback."):(await o?.handleChainError(u),u)}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");let n=this._getOptionsList(t??{},e.length),i=await Promise.all(n.map(u=>F(u))),s=await Promise.all(i.map(async(u,l)=>{let d=await u?.handleChainStart(this.toJSON(),E(e[l],"input"),n[l].runId,void 0,void 0,void 0,n[l].runName);return delete n[l].runId,d})),o;for(let u of this.runnables()){n[0].signal?.throwIfAborted();try{let l=await u.batch(e,s.map((d,f)=>O(n[f],{callbacks:d?.getChild()})),r);return await Promise.all(s.map((d,f)=>d?.handleChainEnd(E(l[f],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(s.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function oe(a){if(typeof a=="function")return new Ie({func:a});if(w.isRunnable(a))return a;if(!Array.isArray(a)&&typeof a=="object"){let e={};for(let[t,r]of Object.entries(a))e[t]=oe(r);return new Me({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var jt=class extends w{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Me&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let n=this.mapper.getStepsKeys(),[i,s]=_t(e),o=this.mapper.transform(s,O(r,{callbacks:t?.getChild()})),u=o.next();for await(let l of i){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);let d=Object.fromEntries(Object.entries(l).filter(([f])=>!n.includes(f)));Object.keys(d).length>0&&(yield d)}yield(await u).value;for await(let l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let n=m(t),i=new q({generator:this.transform(r(),n),config:n});return await i.setup,x.fromAsyncGenerator(i)}},Rt=class extends w{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let n=m(t),i=new q({generator:this.transform(r(),n),config:n});return await i.setup,x.fromAsyncGenerator(i)}},Xe=class extends ue{constructor(e){let t=Ze.from([Ie.from(async r=>{let n;if(gr(r))try{n=await this.schema.parseAsync(r.args)}catch{throw new Ye("Received tool input did not match expected schema",JSON.stringify(r.args))}else n=r;return n}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function dn(a,e){let t=e.name??a.getName(),r=e.description??e.schema?.description;return e.schema.constructor===Se.ZodString?new Xe({name:t,description:r,schema:Se.object({input:Se.string()}).transform(n=>n.input),bound:a}):new Xe({name:t,description:r,schema:e.schema,bound:a})}var G=class extends w{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){let t=this.partialVariables??{},r={};for(let[i,s]of Object.entries(t))typeof s=="string"?r[i]=s:r[i]=await s();return{...r,...e}}async invoke(e,t){return this._callWithConfig(r=>this.formatPromptValue(r),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{let{PromptTemplate:t}=await import("/v135/@langchain/core@0.2.21/denonext/dist/prompts/prompt.js");return t.deserialize(e)}case void 0:{let{PromptTemplate:t}=await import("/v135/@langchain/core@0.2.21/denonext/dist/prompts/prompt.js");return t.deserialize({...e,_type:"prompt"})}case"few_shot":{let{FewShotPromptTemplate:t}=await import("/v135/@langchain/core@0.2.21/denonext/dist/prompts/few_shot.js");return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}};var Ae=class extends C{},et=class extends Ae{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new N(this.value)]}},tt=class extends Ae{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Ue(this.messages)}toChatMessages(){return this.messages}},rt=class extends Ae{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new N({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}};var Q=class extends G{async formatPromptValue(e){let t=await this.format(e);return new et(t)}};import $t from"/v135/mustache@4.2.0/denonext/mustache.mjs";function wr(){$t.escape=a=>a}var ke=a=>{let e=a.split(""),t=[],r=(i,s)=>{for(let o=s;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1},n=0;for(;n<e.length;)if(e[n]==="{"&&n+1<e.length&&e[n+1]==="{")t.push({type:"literal",text:"{"}),n+=2;else if(e[n]==="}"&&n+1<e.length&&e[n+1]==="}")t.push({type:"literal",text:"}"}),n+=2;else if(e[n]==="{"){let i=r("}",n);if(i<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(n+1,i).join("")}),n=i+1}else{if(e[n]==="}")throw new Error("Single '}' in template.");{let i=r("{}",n),s=(i<0?e.slice(n):e.slice(n,i)).join("");t.push({type:"literal",text:s}),n=i<0?e.length:i}}return t},pn=a=>a.map(e=>e[0]==="name"?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:["#","&","^",">"].includes(e[0])?{type:"variable",name:e[1]}:{type:"literal",text:e[1]}),nt=a=>{wr();let e=$t.parse(a);return pn(e)},hn=(a,e)=>ke(a).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`(f-string) Missing value for input ${r.name}`)}return t+r.text},""),mn=(a,e)=>(wr(),$t.render(a,e)),Lt={"f-string":hn,mustache:mn},gn={"f-string":ke,mustache:nt},V=(a,e,t)=>Lt[e](a,t),yr=(a,e)=>gn[e](a),le=(a,e,t)=>{if(!(e in Lt)){let r=Object.keys(Lt);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{let r=t.reduce((n,i)=>(n[i]="foo",n),{});Array.isArray(a)?a.forEach(n=>{if(n.type==="text")V(n.text,e,r);else if(n.type==="image_url")if(typeof n.image_url=="string")V(n.image_url,e,r);else{let i=n.image_url.url;V(i,e,r)}else throw new Error(`Invalid message template received. ${JSON.stringify(n,null,2)}`)}):V(a,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};var J=class a extends Q{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),le(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){let t=await this.mergePartialAndUserVariables(e);return V(this.template,this.templateFormat,t)}static fromExamples(e,t,r,n=`

`,i=""){let s=[i,...e,t].join(n);return new a({inputVariables:r,template:s})}static fromTemplate(e,t){let{templateFormat:r="f-string",...n}=t??{},i=new Set;return yr(e,r).forEach(s=>{s.type==="variable"&&i.add(s.name)}),new a({inputVariables:[...i],templateFormat:r,template:e,...n})}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new a(n)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new a({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}};var me=class a extends G{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),le([{type:"image_url",image_url:this.template}],this.templateFormat,t)}}_getPromptType(){return"prompt"}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new a(n)}async format(e){let t={};for(let[s,o]of Object.entries(this.template))typeof o=="string"?t[s]=V(o,this.templateFormat,e):t[s]=o;let r=e.url||t.url,n=e.detail||t.detail;if(!r)throw new Error("Must provide either an image URL.");if(typeof r!="string")throw new Error("url must be a string.");let i={url:r};return n&&(i.detail=n),i}async formatPromptValue(e){let t=await this.format(e);return new rt(t)}};var Ce=class extends w{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(r=>this.formatMessages(r),e,{...t,runType:"prompt"})}},Ft=class extends Ce{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){let t=e[this.variableName];if(this.optional&&!t)return[];if(!t){let n=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw n.name="InputFormatError",n}let r;try{Array.isArray(t)?r=t.map(Be):r=[Be(t)]}catch(n){let i=typeof t=="string"?t:JSON.stringify(t,null,2),s=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${i}`,`Additional message: ${n.message}`].join(`

`));throw s.name="InputFormatError",s}return r}},Vt=class extends Ce{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},je=class extends G{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){let t=await this.formatMessages(e);return new tt(t)}},Dt=class extends Vt{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new ie(await this.prompt.format(e),this.role)}static fromTemplate(e,t,r){return new this(J.fromTemplate(e,{templateFormat:r?.templateFormat}),t)}},Re=class extends Ce{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let r=[];this.prompt.forEach(n=>{"inputVariables"in n&&(r=r.concat(n.inputVariables))}),this.inputVariables=r}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){let t=this.constructor;if(t._messageClass()){let r=t._messageClass();return new r({content:e})}else if(t.chatMessageClass){let r=t.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(J.fromTemplate(e,t));let r=[];for(let n of e)if(typeof n=="string"||typeof n=="object"&&"text"in n){let i="";typeof n=="string"?i=n:typeof n.text=="string"&&(i=n.text??""),r.push(J.fromTemplate(i,t))}else if(typeof n=="object"&&"image_url"in n){let i=n.image_url??"",s,o=[];if(typeof i=="string"){let u;t?.templateFormat==="mustache"?u=nt(i):u=ke(i);let l=u.flatMap(d=>d.type==="variable"?[d.name]:[]);if((l?.length??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${i}`);o=[l[0]]}else o=[];i={url:i},s=new me({template:i,inputVariables:o,templateFormat:t?.templateFormat})}else if(typeof i=="object"){if("url"in i){let u;t?.templateFormat==="mustache"?u=nt(i.url):u=ke(i.url),o=u.flatMap(l=>l.type==="variable"?[l.name]:[])}else o=[];s=new me({template:i,inputVariables:o,templateFormat:t?.templateFormat})}else throw new Error("Invalid image template");r.push(s)}return new this({prompt:r,additionalOptions:t})}async format(e){if(this.prompt instanceof Q){let t=await this.prompt.format(e);return this.createMessage(t)}else{let t=[];for(let r of this.prompt){let n={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(let i of r.inputVariables)n||(n={[i]:e[i]}),n={...n,[i]:e[i]};if(r instanceof Q){let i=await r.format(n);t.push({type:"text",text:i})}else if(r instanceof me){let i=await r.format(n);t.push({type:"image_url",image_url:i})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}},at=class extends Re{static _messageClass(){return N}static lc_name(){return"HumanMessagePromptTemplate"}},Ht=class extends Re{static _messageClass(){return ae}static lc_name(){return"AIMessagePromptTemplate"}},Bt=class extends Re{static _messageClass(){return se}static lc_name(){return"SystemMessagePromptTemplate"}};function bn(a){return typeof a.formatMessages=="function"}function wn(a,e){if(bn(a)||He(a))return a;if(Array.isArray(a)&&a[0]==="placeholder"){let n=a[1];if(typeof n!="string"||n[0]!=="{"||n[n.length-1]!=="}")throw new Error(`Invalid placeholder template: "${a[1]}". Expected a variable name surrounded by curly braces.`);let i=n.slice(1,-1);return new Ft({variableName:i,optional:!0})}let t=Be(a),r;if(typeof t.content=="string"?r=t.content:r=t.content.map(n=>"text"in n?{text:n.text}:"image_url"in n?{image_url:n.image_url}:n),t._getType()==="human")return at.fromTemplate(r,e);if(t._getType()==="ai")return Ht.fromTemplate(r,e);if(t._getType()==="system")return Bt.fromTemplate(r,e);if(ie.isInstance(t))return Dt.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function yn(a){return a.constructor.lc_name()==="MessagesPlaceholder"}var ge=class a extends je{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){let t=new Set;for(let o of this.promptMessages)if(!(o instanceof _))for(let u of o.inputVariables)t.add(u);let r=this.inputVariables,n=new Set(this.partialVariables?r.concat(Object.keys(this.partialVariables)):r),i=new Set([...n].filter(o=>!t.has(o)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are not used in any of the prompt messages.`);let s=new Set([...t].filter(o=>!n.has(o)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if(typeof e.content=="string")return e;let r=await Promise.all(e.content.map(async n=>{if(n.type!=="image_url")return n;let i="";typeof n.image_url=="string"?i=n.image_url:i=n.image_url.url;let o=await J.fromTemplate(i,{templateFormat:this.templateFormat}).format(t);return typeof n.image_url!="string"&&"url"in n.image_url?n.image_url.url=o:n.image_url=o,n}));return e.content=r,e}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),r=[];for(let n of this.promptMessages)if(n instanceof _)r.push(await this._parseImagePrompts(n,t));else{let i=n.inputVariables.reduce((o,u)=>{if(!(u in t)&&!(yn(n)&&n.optional))throw new Error(`Missing value for input variable \`${u.toString()}\``);return o[u]=t[u],o},{}),s=await n.formatMessages(i);r=r.concat(s)}return r}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new a(n)}static fromTemplate(e,t){let r=J.fromTemplate(e,t),n=new at({prompt:r});return this.fromMessages([n])}static fromMessages(e,t){let r=e.reduce((s,o)=>s.concat(o instanceof a?o.promptMessages:[wn(o,t)]),[]),n=e.reduce((s,o)=>o instanceof a?Object.assign(s,o.partialVariables):s,Object.create(null)),i=new Set;for(let s of r)if(!(s instanceof _))for(let o of s.inputVariables)o in n||i.add(o);return new this({...t,inputVariables:[...i],promptMessages:r,partialVariables:n,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}};var _r=class a extends Q{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),le(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new a(n)}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),n=await Promise.all(r.map(s=>this.examplePrompt.format(s))),i=[this.prefix,...n,this.suffix].join(this.exampleSeparator);return V(i,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){let{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");let r=await J.deserialize(t),n;if(Array.isArray(e.examples))n=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new a({inputVariables:e.input_variables,examplePrompt:r,examples:n,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}},vr=class a extends je{_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??`

`,this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),le(this.prefix+this.suffix,this.templateFormat,t)}}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t);r=r.map(i=>{let s={};return this.examplePrompt.inputVariables.forEach(o=>{s[o]=i[o]}),s});let n=[];for(let i of r){let s=await this.examplePrompt.formatMessages(i);n.push(...s)}return n}async format(e){let t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),i=(await Promise.all(r.map(o=>this.examplePrompt.formatMessages(o)))).flat().map(o=>o.content),s=[this.prefix,...i,this.suffix].join(this.exampleSeparator);return V(s,this.templateFormat,t)}async partial(e){let t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new a(n)}};var xr=class a extends G{static lc_name(){return"PipelinePromptTemplate"}constructor(e){super({...e,inputVariables:[]}),Object.defineProperty(this,"pipelinePrompts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"finalPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pipelinePrompts=e.pipelinePrompts,this.finalPrompt=e.finalPrompt,this.inputVariables=this.computeInputValues()}computeInputValues(){let e=this.pipelinePrompts.map(r=>r.name),t=this.pipelinePrompts.map(r=>r.prompt.inputVariables.filter(n=>!e.includes(n))).flat();return[...new Set(t)]}static extractRequiredInputValues(e,t){return t.reduce((r,n)=>(r[n]=e[n],r),{})}async formatPipelinePrompts(e){let t=await this.mergePartialAndUserVariables(e);for(let{name:r,prompt:n}of this.pipelinePrompts){let i=a.extractRequiredInputValues(t,n.inputVariables);n instanceof ge?t[r]=await n.formatMessages(i):t[r]=await n.format(i)}return a.extractRequiredInputValues(t,this.finalPrompt.inputVariables)}async formatPromptValue(e){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(e))}async format(e){return this.finalPrompt.format(await this.formatPipelinePrompts(e))}async partial(e){let t={...this};return t.inputVariables=this.inputVariables.filter(r=>!(r in e)),t.partialVariables={...this.partialVariables??{},...e},new a(t)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function Or(a){return typeof a=="object"&&a!=null&&"withStructuredOutput"in a&&typeof a.withStructuredOutput=="function"}function _n(a){return typeof a=="object"&&a!=null&&"lc_id"in a&&Array.isArray(a.lc_id)&&a.lc_id.join("/")==="langchain_core/runnables/RunnableBinding"}var Er=class a extends ge{get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","structured"]}),this.schema=e.schema}pipe(e){if(Or(e))return super.pipe(e.withStructuredOutput(this.schema));if(_n(e)&&Or(e.bound))return super.pipe(e.bound.withStructuredOutput(this.schema).bind(e.kwargs??{}).withConfig(e.config));throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(e,t){return a.fromMessages(e,{schema:t})}};export{Ht as AIMessagePromptTemplate,je as BaseChatPromptTemplate,Ce as BaseMessagePromptTemplate,Vt as BaseMessageStringPromptTemplate,G as BasePromptTemplate,Q as BaseStringPromptTemplate,Dt as ChatMessagePromptTemplate,ge as ChatPromptTemplate,Lt as DEFAULT_FORMATTER_MAPPING,gn as DEFAULT_PARSER_MAPPING,vr as FewShotChatMessagePromptTemplate,_r as FewShotPromptTemplate,at as HumanMessagePromptTemplate,me as ImagePromptTemplate,Ft as MessagesPlaceholder,xr as PipelinePromptTemplate,J as PromptTemplate,Er as StructuredPrompt,Bt as SystemMessagePromptTemplate,le as checkValidTemplate,hn as interpolateFString,mn as interpolateMustache,ke as parseFString,nt as parseMustache,yr as parseTemplate,V as renderTemplate};
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)
*/
//# sourceMappingURL=prompts.js.map