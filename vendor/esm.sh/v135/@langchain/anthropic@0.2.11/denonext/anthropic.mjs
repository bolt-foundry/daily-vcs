/* esm.sh - esbuild bundle(@langchain/anthropic@0.2.11) denonext production */
import{Anthropic as j}from"/v135/@anthropic-ai/sdk@0.22.0/denonext/sdk.mjs";import{AIMessageChunk as M}from"/v135/@langchain/core@0.2.18/denonext/messages.js";import{ChatGenerationChunk as N}from"/v135/@langchain/core@0.2.18/denonext/outputs.js";import{getEnvironmentVariable as L}from"/v135/@langchain/core@0.2.18/denonext/utils/env.js";import{BaseChatModel as F}from"/v135/@langchain/core@0.2.18/denonext/language_models/chat_models.js";import{isOpenAITool as W}from"/v135/@langchain/core@0.2.18/denonext/language_models/base.js";import{zodToJsonSchema as R}from"/v135/zod-to-json-schema@3.23.2/denonext/zod-to-json-schema.mjs";import{RunnablePassthrough as K,RunnableSequence as B}from"/v135/@langchain/core@0.2.18/denonext/runnables.js";import{isZodSchema as H}from"/v135/@langchain/core@0.2.18/denonext/utils/types.js";import{BaseLLMOutputParser as I,OutputParserException as D}from"/v135/@langchain/core@0.2.18/denonext/output_parsers.js";var g=class extends I{static lc_name(){return"AnthropicToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","anthropic","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new D(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let t=e.flatMap(o=>{let{message:a}=o;return Array.isArray(a.content)?y(a.content)[0]:[]});if(t[0]===void 0)throw new Error("No parseable tool calls provided to AnthropicToolsOutputParser.");let[r]=t;return await this._validateResult(r.args)}};function y(n){let e=[];for(let t of n)t.type==="tool_use"&&e.push({name:t.name,args:t.input,id:t.id,type:"tool_call"});return e}function k(n){if(n)return n==="any"?{type:"any"}:n==="auto"?{type:"auto"}:typeof n=="string"?{type:"tool",name:n}:n}function x(n){let e,t=Array.isArray(n.content)?n.content.find(i=>i.type==="tool_use"):void 0;t&&"index"in t&&"name"in t&&"id"in t&&(e={args:"",id:t.id,name:t.name,index:t.index,type:"tool_call_chunk"});let r=Array.isArray(n.content)?n.content.find(i=>i.type==="input_json_delta"):void 0;return r&&"index"in r&&"input"in r&&(typeof r.input=="string"?e={id:r.id,name:r.name,args:r.input,index:r.index,type:"tool_call_chunk"}:e={id:r.id,name:r.name,args:JSON.stringify(r.input,null,2),index:r.index,type:"tool_call_chunk"}),e}import{HumanMessage as v,isAIMessage as q}from"/v135/@langchain/core@0.2.18/denonext/messages.js";function A(n){let e=/^data:(image\/.+);base64,(.+)$/,t=n.match(e);if(t===null)throw new Error(["Anthropic only supports base64-encoded images currently.","Example: data:image/png;base64,/9j/4AAQSk..."].join(`

`));return{type:"base64",media_type:t[1]??"",data:t[2]??""}}function z(n){let e=[];for(let t of n)if(t._getType()==="tool")typeof t.content=="string"?e.push(new v({content:[{type:"tool_result",content:t.content,tool_use_id:t.tool_call_id}]})):e.push(new v({content:t.content}));else{let r=e[e.length-1];if(r?._getType()==="human"&&t._getType()==="human"){let i;typeof r.content=="string"?i=[{type:"text",text:r.content}]:i=r.content,typeof t.content=="string"?i.push({type:"text",text:t.content}):i=i.concat(t.content),r.content=i}else e.push(t)}return e}function T(n){if(n.id===void 0)throw new Error('Anthropic requires all tool calls to have an "id".');return{type:"tool_use",id:n.id,name:n.name,input:n.args}}function C(n){let e=["tool_use","tool_result","input_json_delta"],t=["text","text_delta"];return typeof n=="string"?n:n.map(i=>{if(i.type==="image_url"){let o;return typeof i.image_url=="string"?o=A(i.image_url):o=A(i.image_url.url),{type:"image",source:o}}else{if(t.find(o=>o===i.type)&&"text"in i)return{type:"text",text:i.text};if(e.find(o=>o===i.type)){let o={...i};if("index"in o&&delete o.index,o.type==="input_json_delta"&&(o.type="tool_use"),"input"in o)try{o.input=JSON.parse(o.input)}catch{}return{...o}}else throw new Error("Unsupported message content format")}})}function J(n){return n.reduce((e,t,r)=>{if(r===0)return[t];let i=e[e.length-1];return i.role===t.role&&Array.isArray(i.content)&&Array.isArray(t.content)&&i.content[0].type==="tool_result"&&t.content[0].type==="tool_result"?(i.content=i.content.concat(t.content),e):[...e,t]},[])}function b(n){let e=z(n),t;if(e.length>0&&e[0]._getType()==="system"){if(typeof n[0].content!="string")throw new Error("System message content must be a string.");t=n[0].content}let i=(t!==void 0?e.slice(1):e).map(o=>{let a;if(o._getType()==="human")a="user";else if(o._getType()==="ai")a="assistant";else if(o._getType()==="tool")a="user";else throw o._getType()==="system"?new Error("System messages are only permitted as the first passed message."):new Error(`Message type "${o._getType()}" is not supported.`);if(q(o)&&o.tool_calls?.length){if(typeof o.content=="string")return o.content===""?{role:a,content:o.tool_calls.map(T)}:{role:a,content:[{type:"text",text:o.content},...o.tool_calls.map(T)]};{let{content:s}=o;return!o.tool_calls.every(l=>s.find(p=>(p.type==="tool_use"||p.type==="input_json_delta")&&p.id===l.id))&&console.warn('The "tool_calls" field on a message is only respected if content is a string.'),{role:a,content:C(o.content)}}}else return{role:a,content:C(o.content)}});return{messages:J(i),system:t}}import{AIMessage as S,AIMessageChunk as h}from"/v135/@langchain/core@0.2.18/denonext/messages.js";function O(n,e){let t={...e.usageData};if(n.type==="message_start"){let{content:r,usage:i,...o}=n.message,a={};for(let[u,l]of Object.entries(o))l!=null&&(a[u]=l);t=i;let s;return e.streamUsage&&(s={input_tokens:i.input_tokens,output_tokens:i.output_tokens,total_tokens:i.input_tokens+i.output_tokens}),{chunk:new h({content:e.coerceContentToString?"":[],additional_kwargs:a,usage_metadata:s,id:n.message.id}),usageData:t}}else if(n.type==="message_delta"){let r;return e.streamUsage&&(r={input_tokens:n.usage.output_tokens,output_tokens:0,total_tokens:n.usage.output_tokens}),n?.usage!==void 0&&(t.output_tokens+=n.usage.output_tokens),{chunk:new h({content:e.coerceContentToString?"":[],additional_kwargs:{...n.delta},usage_metadata:r}),usageData:t}}else{if(n.type==="content_block_start"&&n.content_block.type==="tool_use")return{chunk:new h({content:e.coerceContentToString?"":[{index:n.index,...n.content_block,input:""}],additional_kwargs:{}}),usageData:t};if(n.type==="content_block_delta"&&n.delta.type==="text_delta"){let r=n.delta?.text;if(r!==void 0)return{chunk:new h({content:e.coerceContentToString?r:[{index:n.index,...n.delta}],additional_kwargs:{}}),usageData:t}}else{if(n.type==="content_block_delta"&&n.delta.type==="input_json_delta")return{chunk:new h({content:e.coerceContentToString?"":[{index:n.index,input:n.delta.partial_json,type:n.delta.type}],additional_kwargs:{}}),usageData:t};if(n.type==="content_block_start"&&n.content_block.type==="text"){let r=n.content_block?.text;if(r!==void 0)return{chunk:new h({content:e.coerceContentToString?r:[{index:n.index,...n.content_block}],additional_kwargs:{}}),usageData:t}}}}return null}function P(n,e){let t=e.usage,r=t!=null?{input_tokens:t.input_tokens??0,output_tokens:t.output_tokens??0,total_tokens:(t.input_tokens??0)+(t.output_tokens??0)}:void 0;if(n.length===1&&n[0].type==="text")return[{text:n[0].text,message:new S({content:n[0].text,additional_kwargs:e,usage_metadata:r,response_metadata:e,id:e.id})}];{let i=y(n);return[{text:"",message:new S({content:n,additional_kwargs:e,tool_calls:i,usage_metadata:r,response_metadata:e,id:e.id})}]}}function $(n){return!!(n.tools&&n.tools.length>0)}function E(n){return"input_schema"in n}function Y(n){if(typeof n.content=="string")return n.content;if(Array.isArray(n.content)&&n.content.length>=1&&"input"in n.content[0])return typeof n.content[0].input=="string"?n.content[0].input:JSON.stringify(n.content[0].input);if(Array.isArray(n.content)&&n.content.length>=1&&"text"in n.content[0])return n.content[0].text}var w=class extends F{static lc_name(){return"ChatAnthropic"}get lc_secrets(){return{anthropicApiKey:"ANTHROPIC_API_KEY",apiKey:"ANTHROPIC_API_KEY"}}get lc_aliases(){return{modelName:"model"}}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"anthropicApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"invocationKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clientOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamingClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.anthropicApiKey=e?.apiKey??e?.anthropicApiKey??L("ANTHROPIC_API_KEY"),!this.anthropicApiKey)throw new Error("Anthropic API key not found");this.clientOptions=e?.clientOptions??{},this.apiKey=this.anthropicApiKey,this.apiUrl=e?.anthropicApiUrl,this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.invocationKwargs=e?.invocationKwargs??{},this.temperature=e?.temperature??this.temperature,this.topK=e?.topK??this.topK,this.topP=e?.topP??this.topP,this.maxTokens=e?.maxTokensToSample??e?.maxTokens??this.maxTokens,this.stopSequences=e?.stopSequences??this.stopSequences,this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"anthropic",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}formatStructuredToolToAnthropic(e){if(!(!e||!e.length)){if(e.every(t=>E(t)))return e;if(e.every(t=>W(t)))return e.map(t=>({name:t.function.name,description:t.function.description,input_schema:t.function.parameters}));if(e.some(t=>E(t)))throw new Error("Can not pass in a mix of tool schemas to ChatAnthropic");return e.map(t=>({name:t.name,description:t.description,input_schema:R(t.schema)}))}}bindTools(e,t){return this.bind({tools:this.formatStructuredToolToAnthropic(e),...t})}invocationParams(e){let t=k(e?.tool_choice);return{model:this.model,temperature:this.temperature,top_k:this.topK,top_p:this.topP,stop_sequences:e?.stop??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e?.tools),tool_choice:t,...this.invocationKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams()}}identifyingParams(){return{model_name:this.model,...this.invocationParams()}}async*_streamResponseChunks(e,t,r){let i=this.invocationParams(t),o=b(e),a=!$({...i,...o,stream:!1}),s=await this.createStreamWithRetry({...i,...o,stream:!0}),u={input_tokens:0,output_tokens:0};for await(let p of s){if(t.signal?.aborted)throw s.controller.abort(),new Error("AbortError: User aborted the request.");let d=O(p,{streamUsage:!!(this.streamUsage||t.streamUsage),coerceContentToString:a,usageData:u});if(!d)continue;let{chunk:m,usageData:_}=d;u=_;let c=x(m),f=Y(m);yield new N({message:new M({content:m.content,additional_kwargs:m.additional_kwargs,tool_call_chunks:c?[c]:void 0,usage_metadata:m.usage_metadata,response_metadata:m.response_metadata,id:m.id}),text:f??""}),f&&await r?.handleLLMNewToken(f)}let l;(this.streamUsage||t.streamUsage)&&(l={input_tokens:u.input_tokens,output_tokens:u.output_tokens,total_tokens:u.input_tokens+u.output_tokens}),yield new N({message:new M({content:a?"":[],additional_kwargs:{usage:u},usage_metadata:l}),text:""})}async _generateNonStreaming(e,t,r){let i=t.tools!==void 0?{...r,headers:{...r.headers,"anthropic-beta":"tools-2024-04-04"}}:r,o=await this.completionWithRetry({...t,stream:!1,...b(e)},i),{content:a,...s}=o,u=P(a,s),{role:l,type:p,...d}=s;return{generations:u,llmOutput:d}}async _generate(e,t,r){if(this.stopSequences&&t.stop)throw new Error('"stopSequence" parameter found in input and default params');let i=this.invocationParams(t);if(i.stream){let o,a=this._streamResponseChunks(e,t,r);for await(let s of a)o===void 0?o=s:o=o.concat(s);if(o===void 0)throw new Error("No chunks returned from Anthropic API.");return{generations:[{text:o.text,message:o.message}]}}else return this._generateNonStreaming(e,i,{signal:t.signal})}async createStreamWithRetry(e,t){if(!this.streamingClient){let i=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.streamingClient=new j({...this.clientOptions,...i,apiKey:this.apiKey,maxRetries:0})}let r=async()=>this.streamingClient.messages.create({...e,...this.invocationKwargs,stream:!0},t);return this.caller.call(r)}async completionWithRetry(e,t){if(!this.batchClient){let i=this.apiUrl?{baseURL:this.apiUrl}:void 0;if(!this.apiKey)throw new Error("Missing Anthropic API key.");this.batchClient=new j({...this.clientOptions,...i,apiKey:this.apiKey,maxRetries:0})}let r=async()=>this.batchClient.messages.create({...e,...this.invocationKwargs},t);return this.caller.callWithOptions({signal:t.signal??void 0},r)}_llmType(){return"anthropic"}withStructuredOutput(e,t){let r=e,i=t?.name,o=t?.method,a=t?.includeRaw;if(o==="jsonMode")throw new Error('Anthropic only supports "functionCalling" as a method.');let s=i??"extract",u,l;if(H(r)){let c=R(r);l=[{name:s,description:c.description??"A function available to call.",input_schema:c}],u=new g({returnSingle:!0,keyName:s,zodSchema:r})}else{let c;typeof r.name=="string"&&typeof r.description=="string"&&typeof r.input_schema=="object"&&r.input_schema!=null?(c=r,s=r.name):c={name:s,description:r.description??"",input_schema:r},l=[c],u=new g({returnSingle:!0,keyName:s})}let p=this.bind({tools:l,tool_choice:{type:"tool",name:s}});if(!a)return p.pipe(u).withConfig({runName:"ChatAnthropicStructuredOutput"});let d=K.assign({parsed:(c,f)=>u.invoke(c.raw,f)}),m=K.assign({parsed:()=>null}),_=d.withFallbacks({fallbacks:[m]});return B.from([{raw:p},_]).withConfig({runName:"StructuredOutputRunnable"})}},U=class extends w{};export{U as ChatAnthropic,w as ChatAnthropicMessages};
//# sourceMappingURL=anthropic.mjs.map