/* esm.sh - esbuild bundle(@anthropic-ai/sdk@0.22.0/streaming) denonext production */
import { Buffer as __Buffer$ } from "node:buffer";
import{ReadableStream as g}from"/v135/@anthropic-ai/sdk@0.22.0/denonext/_shims.js";import{AnthropicError as l}from"/v135/@anthropic-ai/sdk@0.22.0/denonext/error.js";import{safeJSON as p,createResponseHeaders as y}from"/v135/@anthropic-ai/sdk@0.22.0/denonext/core.js";import{APIError as m}from"/v135/@anthropic-ai/sdk@0.22.0/denonext/error.js";var d=class o{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let n of x(e,t)){if(n.event==="completion")try{yield JSON.parse(n.data)}catch(a){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),a}if(n.event==="message_start"||n.event==="message_delta"||n.event==="message_stop"||n.event==="content_block_start"||n.event==="content_block_delta"||n.event==="content_block_stop")try{yield JSON.parse(n.data)}catch(a){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),a}if(n.event!=="ping"&&n.event==="error"){let a=n.data,f=p(a),u=f?void 0:a;throw m.generate(void 0,f,u,y(e.headers))}}s=!0}catch(n){if(n instanceof Error&&n.name==="AbortError")return;throw n}finally{s||t.abort()}}return new o(i,t)}static fromReadableStream(e,t){let r=!1;async function*i(){let n=new c,a=w(e);for await(let f of a)for(let u of n.decode(f))yield u;for(let f of n.flush())yield f}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(let a of i())n||a&&(yield JSON.parse(a));n=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{n||t.abort()}}return new o(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),i=s=>({next:()=>{if(s.length===0){let n=r.next();e.push(n),t.push(n)}return s.shift()}});return[new o(()=>i(e),this.controller),new o(()=>i(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new g({async start(){t=e[Symbol.asyncIterator]()},async pull(i){try{let{value:s,done:n}=await t.next();if(n)return i.close();let a=r.encode(JSON.stringify(s)+`
`);i.enqueue(a)}catch(s){i.error(s)}},async cancel(){await t.return?.()}})}};async function*x(o,e){if(!o.body)throw e.abort(),new l("Attempted to iterate over a response with no body");let t=new h,r=new c,i=w(o.body);for await(let s of v(i))for(let n of r.decode(s)){let a=t.decode(n);a&&(yield a)}for(let s of r.flush()){let n=t.decode(s);n&&(yield n)}}async function*v(o){let e=new Uint8Array;for await(let t of o){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,i=new Uint8Array(e.length+r.length);i.set(e),i.set(r,e.length),e=i;let s;for(;(s=E(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}function E(o){for(let r=0;r<o.length-2;r++){if(o[r]===10&&o[r+1]===10||o[r]===13&&o[r+1]===13)return r+2;if(o[r]===13&&o[r+1]===10&&r+3<o.length&&o[r+2]===13&&o[r+3]===10)return r+4}return-1}var h=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,i]=S(e,":");return i.startsWith(" ")&&(i=i.substring(1)),t==="event"?this.event=i:t==="data"&&this.data.push(i),null}},c=class o{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=o.NEWLINE_CHARS.has(t[t.length-1]||""),i=t.split(o.NEWLINE_REGEXP);return r&&i.pop(),i.length===1&&!r?(this.buffer.push(i[0]),[]):(this.buffer.length>0&&(i=[this.buffer.join("")+i[0],...i.slice(1)],this.buffer=[]),r||(this.buffer=[i.pop()||""]),i)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof __Buffer$<"u"){if(e instanceof __Buffer$)return e.toString();if(e instanceof Uint8Array)return __Buffer$.from(e).toString();throw new l(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new l(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new l("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};c.NEWLINE_CHARS=new Set([`
`,"\r"]);c.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function C(o){let e=new c,t=[];for(let r of o)t.push(...e.decode(r));return t}function S(o,e){let t=o.indexOf(e);return t!==-1?[o.substring(0,t),e,o.substring(t+e.length)]:[o,"",""]}function w(o){if(o[Symbol.asyncIterator])return o;let e=o.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}export{d as Stream,C as _decodeChunks,x as _iterSSEMessages,w as readableStreamAsyncIterable};
//# sourceMappingURL=streaming.js.map