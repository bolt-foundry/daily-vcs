/* esm.sh - esbuild bundle(@anthropic-ai/sdk@0.22.0/lib/MessageStream) denonext production */
import{AnthropicError as c,APIUserAbortError as y}from"/v135/@anthropic-ai/sdk@0.22.0/denonext/error.js";import{Stream as v}from"/v135/@anthropic-ai/sdk@0.22.0/denonext/streaming.js";import{partialParse as C}from"/v135/@anthropic-ai/sdk@0.22.0/denonext/_vendor/partial-json-parser/parser.js";var i=function(o,t,e,s,a){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?o!==t||!a:!t.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?a.call(o,e):a?a.value=e:t.set(o,e),e},r=function(o,t,e,s){if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?o!==t||!s:!t.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?s:e==="a"?s.call(o):s?s.value:t.get(o)},h,d,p,w,u,_,M,m,l,g,b,S,f,P,R,x,E,j,W,F,T="__json_buf",q=class o{constructor(){h.add(this),this.messages=[],this.receivedMessages=[],d.set(this,void 0),this.controller=new AbortController,p.set(this,void 0),w.set(this,()=>{}),u.set(this,()=>{}),_.set(this,void 0),M.set(this,()=>{}),m.set(this,()=>{}),l.set(this,{}),g.set(this,!1),b.set(this,!1),S.set(this,!1),f.set(this,!1),x.set(this,t=>{if(i(this,b,!0,"f"),t instanceof Error&&t.name==="AbortError"&&(t=new y),t instanceof y)return i(this,S,!0,"f"),this._emit("abort",t);if(t instanceof c)return this._emit("error",t);if(t instanceof Error){let e=new c(t.message);return e.cause=t,this._emit("error",e)}return this._emit("error",new c(String(t)))}),i(this,p,new Promise((t,e)=>{i(this,w,t,"f"),i(this,u,e,"f")}),"f"),i(this,_,new Promise((t,e)=>{i(this,M,t,"f"),i(this,m,e,"f")}),"f"),r(this,p,"f").catch(()=>{}),r(this,_,"f").catch(()=>{})}static fromReadableStream(t){let e=new o;return e._run(()=>e._fromReadableStream(t)),e}static createMessage(t,e,s){let a=new o;for(let n of e.messages)a._addMessageParam(n);return a._run(()=>a._createMessage(t,{...e,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),a}_run(t){t().then(()=>{this._emitFinal(),this._emit("end")},r(this,x,"f"))}_addMessageParam(t){this.messages.push(t)}_addMessage(t,e=!0){this.receivedMessages.push(t),e&&this._emit("message",t)}async _createMessage(t,e,s){let a=s?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),r(this,h,"m",E).call(this);let n=await t.create({...e,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(let k of n)r(this,h,"m",j).call(this,k);if(n.controller.signal?.aborted)throw new y;r(this,h,"m",W).call(this)}_connected(){this.ended||(r(this,w,"f").call(this),this._emit("connect"))}get ended(){return r(this,g,"f")}get errored(){return r(this,b,"f")}get aborted(){return r(this,S,"f")}abort(){this.controller.abort()}on(t,e){return(r(this,l,"f")[t]||(r(this,l,"f")[t]=[])).push({listener:e}),this}off(t,e){let s=r(this,l,"f")[t];if(!s)return this;let a=s.findIndex(n=>n.listener===e);return a>=0&&s.splice(a,1),this}once(t,e){return(r(this,l,"f")[t]||(r(this,l,"f")[t]=[])).push({listener:e,once:!0}),this}emitted(t){return new Promise((e,s)=>{i(this,f,!0,"f"),t!=="error"&&this.once("error",s),this.once(t,e)})}async done(){i(this,f,!0,"f"),await r(this,_,"f")}get currentMessage(){return r(this,d,"f")}async finalMessage(){return await this.done(),r(this,h,"m",P).call(this)}async finalText(){return await this.done(),r(this,h,"m",R).call(this)}_emit(t,...e){if(r(this,g,"f"))return;t==="end"&&(i(this,g,!0,"f"),r(this,M,"f").call(this));let s=r(this,l,"f")[t];if(s&&(r(this,l,"f")[t]=s.filter(a=>!a.once),s.forEach(({listener:a})=>a(...e))),t==="abort"){let a=e[0];!r(this,f,"f")&&!s?.length&&Promise.reject(a),r(this,u,"f").call(this,a),r(this,m,"f").call(this,a),this._emit("end");return}if(t==="error"){let a=e[0];!r(this,f,"f")&&!s?.length&&Promise.reject(a),r(this,u,"f").call(this,a),r(this,m,"f").call(this,a),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",r(this,h,"m",P).call(this))}async _fromReadableStream(t,e){let s=e?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),r(this,h,"m",E).call(this),this._connected();let a=v.fromReadableStream(t,this.controller);for await(let n of a)r(this,h,"m",j).call(this,n);if(a.controller.signal?.aborted)throw new y;r(this,h,"m",W).call(this)}[(d=new WeakMap,p=new WeakMap,w=new WeakMap,u=new WeakMap,_=new WeakMap,M=new WeakMap,m=new WeakMap,l=new WeakMap,g=new WeakMap,b=new WeakMap,S=new WeakMap,f=new WeakMap,x=new WeakMap,h=new WeakSet,P=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},R=function(){if(this.receivedMessages.length===0)throw new c("stream ended without producing a Message with role=assistant");let e=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(e.length===0)throw new c("stream ended without producing a content block with type=text");return e.join(" ")},E=function(){this.ended||i(this,d,void 0,"f")},j=function(e){if(this.ended)return;let s=r(this,h,"m",F).call(this,e);switch(this._emit("streamEvent",e,s),e.type){case"content_block_delta":{let a=s.content.at(-1);e.delta.type==="text_delta"&&a.type==="text"?this._emit("text",e.delta.text,a.text||""):e.delta.type==="input_json_delta"&&a.type==="tool_use"&&a.input&&this._emit("inputJson",e.delta.partial_json,a.input);break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{i(this,d,s,"f");break}case"content_block_start":case"message_delta":break}},W=function(){if(this.ended)throw new c("stream has ended, this shouldn't happen");let e=r(this,d,"f");if(!e)throw new c("request ended without sending any chunks");return i(this,d,void 0,"f"),e},F=function(e){let s=r(this,d,"f");if(e.type==="message_start"){if(s)throw new c(`Unexpected event order, got ${e.type} before receiving "message_stop"`);return e.message}if(!s)throw new c(`Unexpected event order, got ${e.type} before "message_start"`);switch(e.type){case"message_stop":return s;case"message_delta":return s.stop_reason=e.delta.stop_reason,s.stop_sequence=e.delta.stop_sequence,s.usage.output_tokens=e.usage.output_tokens,s;case"content_block_start":return s.content.push(e.content_block),s;case"content_block_delta":{let a=s.content.at(e.index);if(a?.type==="text"&&e.delta.type==="text_delta")a.text+=e.delta.text;else if(a?.type==="tool_use"&&e.delta.type==="input_json_delta"){let n=a[T]||"";n+=e.delta.partial_json,Object.defineProperty(a,T,{value:n,enumerable:!1,writable:!0}),n&&(a.input=C(n))}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){let t=[],e=[],s=!1;return this.on("streamEvent",a=>{let n=e.shift();n?n.resolve(a):t.push(a)}),this.on("end",()=>{s=!0;for(let a of e)a.resolve(void 0);e.length=0}),this.on("abort",a=>{s=!0;for(let n of e)n.reject(a);e.length=0}),this.on("error",a=>{s=!0;for(let n of e)n.reject(a);e.length=0}),{next:async()=>t.length?{value:t.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((n,k)=>e.push({resolve:n,reject:k})).then(n=>n?{value:n,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new v(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};export{q as MessageStream};
//# sourceMappingURL=MessageStream.js.map