/* esm.sh - esbuild bundle(https-proxy-agent@7.0.2) denonext production */
import { Buffer as __Buffer$ } from "node:buffer";
import * as __0$ from "node:net";
import * as __1$ from "node:tls";
import * as __2$ from "node:assert";
import * as __3$ from "/v135/debug@4.3.4/denonext/debug.mjs";
import * as __4$ from "/v135/agent-base@7.1.0/denonext/agent-base.mjs";
import * as __5$ from "/v135/debug@4.3.4/denonext/debug.mjs";
var require=n=>{const e=m=>typeof m.default<"u"?m.default:m,c=m=>Object.assign({},m);switch(n){case"net":return e(__0$);case"tls":return e(__1$);case"assert":return e(__2$);case"debug":return e(__3$);case"agent-base":return c(__4$);default:throw new Error("module \""+n+"\" not found");}};
var G=Object.create;var A=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var V=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var l=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var M=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),X=(e,t)=>{for(var r in t)A(e,r,{get:t[r],enumerable:!0})},T=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Q(t))!W.call(e,o)&&o!==r&&A(e,o,{get:()=>t[o],enumerable:!(n=J(t,o))||n.enumerable});return e},f=(e,t,r)=>(T(e,t,"default"),r&&T(r,t,"default")),R=(e,t,r)=>(r=e!=null?G(V(e)):{},T(t||!e||!e.__esModule?A(r,"default",{value:e,enumerable:!0}):r,e));var D=M(h=>{"use strict";var Y=h&&h.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(h,"__esModule",{value:!0});h.parseProxyResponse=void 0;var Z=Y(l("debug")),m=(0,Z.default)("https-proxy-agent:parse-proxy-response");function k(e){return new Promise((t,r)=>{let n=0,o=[];function c(){let a=e.read();a?_(a):e.once("readable",c)}function p(){e.removeListener("end",y),e.removeListener("error",P),e.removeListener("readable",c)}function y(){p(),m("onend"),r(new Error("Proxy connection ended before receiving CONNECT response"))}function P(a){p(),m("onerror %o",a),r(a)}function _(a){o.push(a),n+=a.length;let d=__Buffer$.concat(o,n),s=d.indexOf(`\r
\r
`);if(s===-1){m("have not received end of HTTP headers yet..."),c();return}let S=d.slice(0,s).toString("ascii").split(`\r
`),w=S.shift();if(!w)return e.destroy(),r(new Error("No header received from proxy CONNECT response"));let E=w.split(" "),K=+E[1],F=E.slice(2).join(" "),v={};for(let g of S){if(!g)continue;let $=g.indexOf(":");if($===-1)return e.destroy(),r(new Error(`Invalid header from proxy CONNECT response: "${g}"`));let H=g.slice(0,$).toLowerCase(),N=g.slice($+1).trimStart(),O=v[H];typeof O=="string"?v[H]=[O,N]:Array.isArray(O)?O.push(N):v[H]=N}m("got proxy server response: %o %o",w,v),p(),t({connect:{statusCode:K,statusText:F,headers:v},buffered:d})}e.on("error",P),e.on("end",y),c()})}h.parseProxyResponse=k});var L=M(i=>{"use strict";var ee=i&&i.__createBinding||(Object.create?function(e,t,r,n){n===void 0&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);(!o||("get"in o?!t.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){n===void 0&&(n=r),e[n]=t[r]}),te=i&&i.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),q=i&&i.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var r in e)r!=="default"&&Object.prototype.hasOwnProperty.call(e,r)&&ee(t,e,r);return te(t,e),t},B=i&&i.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(i,"__esModule",{value:!0});i.HttpsProxyAgent=void 0;var x=q(l("net")),I=q(l("tls")),re=B(l("assert")),ne=B(l("debug")),oe=l("agent-base"),se=D(),b=(0,ne.default)("https-proxy-agent"),C=class extends oe.Agent{constructor(t,r){super(r),this.options={path:void 0},this.proxy=typeof t=="string"?new URL(t):t,this.proxyHeaders=r?.headers??{},b("Creating new HttpsProxyAgent instance: %o",this.proxy.href);let n=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),o=this.proxy.port?parseInt(this.proxy.port,10):this.proxy.protocol==="https:"?443:80;this.connectOpts={ALPNProtocols:["http/1.1"],...r?j(r,"headers"):null,host:n,port:o}}async connect(t,r){let{proxy:n}=this;if(!r.host)throw new TypeError('No "host" provided');let o;if(n.protocol==="https:"){b("Creating `tls.Socket`: %o",this.connectOpts);let s=this.connectOpts.servername||this.connectOpts.host;o=I.connect({...this.connectOpts,servername:s&&x.isIP(s)?void 0:s})}else b("Creating `net.Socket`: %o",this.connectOpts),o=x.connect(this.connectOpts);let c=typeof this.proxyHeaders=="function"?this.proxyHeaders():{...this.proxyHeaders},p=x.isIPv6(r.host)?`[${r.host}]`:r.host,y=`CONNECT ${p}:${r.port} HTTP/1.1\r
`;if(n.username||n.password){let s=`${decodeURIComponent(n.username)}:${decodeURIComponent(n.password)}`;c["Proxy-Authorization"]=`Basic ${__Buffer$.from(s).toString("base64")}`}c.Host=`${p}:${r.port}`,c["Proxy-Connection"]||(c["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close");for(let s of Object.keys(c))y+=`${s}: ${c[s]}\r
`;let P=(0,se.parseProxyResponse)(o);o.write(`${y}\r
`);let{connect:_,buffered:a}=await P;if(t.emit("proxyConnect",_),this.emit("proxyConnect",_,t),_.statusCode===200){if(t.once("socket",ie),r.secureEndpoint){b("Upgrading socket connection to TLS");let s=r.servername||r.host;return I.connect({...j(r,"host","path","port"),socket:o,servername:x.isIP(s)?void 0:s})}return o}o.destroy();let d=new x.Socket({writable:!1});return d.readable=!0,t.once("socket",s=>{b("Replaying proxy buffer for failed request"),(0,re.default)(s.listenerCount("data")>0),s.push(a),s.push(null)}),d}};C.protocols=["http","https"];i.HttpsProxyAgent=C;function ie(e){e.resume()}function j(e,...t){let r={},n;for(n in e)t.includes(n)||(r[n]=e[n]);return r}});var u={};X(u,{HttpsProxyAgent:()=>ae,__esModule:()=>ce,default:()=>fe});var z=R(L());f(u,R(L()));var{__esModule:ce,HttpsProxyAgent:ae}=z,{default:U,...ue}=z,fe=U!==void 0?U:ue;export{ae as HttpsProxyAgent,ce as __esModule,fe as default};
//# sourceMappingURL=https-proxy-agent.mjs.map