/* esm.sh - esbuild bundle(graphql-ws@5.14.0) denonext production */
var __global$ = globalThis || (typeof window !== "undefined" ? window : self);
function P(e){return e===null?"null":Array.isArray(e)?"array":typeof e}function N(e){return P(e)==="object"}function re(e){return typeof Object(e)[Symbol.asyncIterator]=="function"}function K(e){return N(e)&&typeof Object(e)[Symbol.asyncIterator]=="function"&&typeof e.return=="function"}function X(e){return Array.isArray(e)&&e.length>0&&e.every(p=>"message"in p)}function ee(e,p){return e.length<124?e:p}var C="graphql-transport-ws",be="graphql-ws",m;(function(e){e[e.InternalServerError=4500]="InternalServerError",e[e.InternalClientError=4005]="InternalClientError",e[e.BadRequest=4400]="BadRequest",e[e.BadResponse=4004]="BadResponse",e[e.Unauthorized=4401]="Unauthorized",e[e.Forbidden=4403]="Forbidden",e[e.SubprotocolNotAcceptable=4406]="SubprotocolNotAcceptable",e[e.ConnectionInitialisationTimeout=4408]="ConnectionInitialisationTimeout",e[e.ConnectionAcknowledgementTimeout=4504]="ConnectionAcknowledgementTimeout",e[e.SubscriberAlreadyExists=4409]="SubscriberAlreadyExists",e[e.TooManyInitialisationRequests=4429]="TooManyInitialisationRequests"})(m||(m={}));var s;(function(e){e.ConnectionInit="connection_init",e.ConnectionAck="connection_ack",e.Ping="ping",e.Pong="pong",e.Subscribe="subscribe",e.Next="next",e.Error="error",e.Complete="complete"})(s||(s={}));function te(e){if(!N(e))throw new Error(`Message is expected to be an object, but got ${P(e)}`);if(!e.type)throw new Error("Message is missing the 'type' property");if(typeof e.type!="string")throw new Error(`Message is expects the 'type' property to be a string, but got ${P(e.type)}`);switch(e.type){case s.ConnectionInit:case s.ConnectionAck:case s.Ping:case s.Pong:{if(e.payload!=null&&!N(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object or nullish or missing, but got "${e.payload}"`);break}case s.Subscribe:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${P(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!N(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${P(e.payload)}`);if(typeof e.payload.query!="string")throw new Error(`"${e.type}" message payload expects the 'query' property to be a string, but got ${P(e.payload.query)}`);if(e.payload.variables!=null&&!N(e.payload.variables))throw new Error(`"${e.type}" message payload expects the 'variables' property to be a an object or nullish or missing, but got ${P(e.payload.variables)}`);if(e.payload.operationName!=null&&P(e.payload.operationName)!=="string")throw new Error(`"${e.type}" message payload expects the 'operationName' property to be a string or nullish or missing, but got ${P(e.payload.operationName)}`);if(e.payload.extensions!=null&&!N(e.payload.extensions))throw new Error(`"${e.type}" message payload expects the 'extensions' property to be a an object or nullish or missing, but got ${P(e.payload.extensions)}`);break}case s.Next:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${P(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!N(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${P(e.payload)}`);break}case s.Error:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${P(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!X(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an array of GraphQL errors, but got ${JSON.stringify(e.payload)}`);break}case s.Complete:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${P(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);break}default:throw new Error(`Invalid message 'type' property "${e.type}"`)}return e}function we(e){try{return te(e),!0}catch{return!1}}function Y(e,p){return te(typeof e=="string"?JSON.parse(e,p):e)}function _(e,p){return te(e),JSON.stringify(e,p)}var V=function(e){return this instanceof V?(this.v=e,this):new V(e)},oe=function(e,p,T){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var $=T.apply(e,p||[]),A,g=[];return A={},x("next"),x("throw"),x("return"),A[Symbol.asyncIterator]=function(){return this},A;function x(d){$[d]&&(A[d]=function(i){return new Promise(function(M,z){g.push([d,i,M,z])>1||v(d,i)})})}function v(d,i){try{R($[d](i))}catch(M){W(g[0][3],M)}}function R(d){d.value instanceof V?Promise.resolve(d.value.v).then(k,q):W(g[0][2],d)}function k(d){v("next",d)}function q(d){v("throw",d)}function W(d,i){d(i),g.shift(),g.length&&v(g[0][0],g[0][1])}};function Ee(e){let{url:p,connectionParams:T,lazy:$=!0,onNonLazyError:A=console.error,lazyCloseTimeout:g=0,keepAlive:x=0,disablePong:v,connectionAckWaitTimeout:R=0,retryAttempts:k=5,retryWait:q=async function(u){let o=1e3;for(let t=0;t<u;t++)o*=2;await new Promise(t=>setTimeout(t,o+Math.floor(Math.random()*2700+300)))},shouldRetry:W=Z,isFatalConnectionProblem:d,on:i,webSocketImpl:M,generateID:z=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,u=>{let o=Math.random()*16|0;return(u=="x"?o:o&3|8).toString(16)})},jsonMessageReplacer:D,jsonMessageReviver:B}=e,l;if(M){if(!ae(M))throw new Error("Invalid WebSocket implementation provided");l=M}else typeof WebSocket<"u"?l=WebSocket:typeof __global$<"u"?l=__global$.WebSocket||__global$.MozWebSocket:typeof window<"u"&&(l=window.WebSocket||window.MozWebSocket);if(!l)throw new Error("WebSocket implementation missing; on Node you can `import WebSocket from 'ws';` and pass `webSocketImpl: WebSocket` to `createClient`");let G=l,n=(()=>{let a=(()=>{let o={};return{on(t,c){return o[t]=c,()=>{delete o[t]}},emit(t){var c;"id"in t&&((c=o[t.id])===null||c===void 0||c.call(o,t))}}})(),u={connecting:i?.connecting?[i.connecting]:[],opened:i?.opened?[i.opened]:[],connected:i?.connected?[i.connected]:[],ping:i?.ping?[i.ping]:[],pong:i?.pong?[i.pong]:[],message:i?.message?[a.emit,i.message]:[a.emit],closed:i?.closed?[i.closed]:[],error:i?.error?[i.error]:[]};return{onMessage:a.on,on(o,t){let c=u[o];return c.push(t),()=>{c.splice(c.indexOf(t),1)}},emit(o,...t){for(let c of[...u[o]])c(...t)}}})();function H(a){let u=[n.on("error",o=>{u.forEach(t=>t()),a(o)}),n.on("closed",o=>{u.forEach(t=>t()),a(o)})]}let I,O=0,j,F=!1,Q=0,J=!1;async function U(){clearTimeout(j);let[a,u]=await(I??(I=new Promise((c,b)=>(async()=>{if(F){if(await q(Q),!O)return I=void 0,b({code:1e3,reason:"All Subscriptions Gone"});Q++}n.emit("connecting");let r=new G(typeof p=="function"?await p():p,C),f,E;function S(){isFinite(x)&&x>0&&(clearTimeout(E),E=setTimeout(()=>{r.readyState===G.OPEN&&(r.send(_({type:s.Ping})),n.emit("ping",!1,void 0))},x))}H(y=>{I=void 0,clearTimeout(f),clearTimeout(E),b(y),Z(y)&&y.code===4499&&(r.close(4499,"Terminated"),r.onerror=null,r.onclose=null)}),r.onerror=y=>n.emit("error",y),r.onclose=y=>n.emit("closed",y),r.onopen=async()=>{try{n.emit("opened",r);let y=typeof T=="function"?await T():T;if(r.readyState!==G.OPEN)return;r.send(_(y?{type:s.ConnectionInit,payload:y}:{type:s.ConnectionInit},D)),isFinite(R)&&R>0&&(f=setTimeout(()=>{r.close(m.ConnectionAcknowledgementTimeout,"Connection acknowledgement timeout")},R)),S()}catch(y){n.emit("error",y),r.close(m.InternalClientError,ee(y instanceof Error?y.message:new Error(y).message,"Internal client error"))}};let L=!1;r.onmessage=({data:y})=>{try{let w=Y(y,B);if(n.emit("message",w),w.type==="ping"||w.type==="pong"){n.emit(w.type,!0,w.payload),w.type==="pong"?S():v||(r.send(_(w.payload?{type:s.Pong,payload:w.payload}:{type:s.Pong})),n.emit("pong",!1,w.payload));return}if(L)return;if(w.type!==s.ConnectionAck)throw new Error(`First message cannot be of type ${w.type}`);clearTimeout(f),L=!0,n.emit("connected",r,w.payload),F=!1,Q=0,c([r,new Promise((ye,ne)=>H(ne))])}catch(w){r.onmessage=null,n.emit("error",w),r.close(m.BadResponse,ee(w instanceof Error?w.message:new Error(w).message,"Bad response"))}}})())));a.readyState===G.CLOSING&&await u;let o=()=>{},t=new Promise(c=>o=c);return[a,o,Promise.race([t.then(()=>{if(!O){let c=()=>a.close(1e3,"Normal Closure");isFinite(g)&&g>0?j=setTimeout(()=>{a.readyState===G.OPEN&&c()},g):c()}}),u])]}function h(a){if(Z(a)&&(ie(a.code)||[m.InternalServerError,m.InternalClientError,m.BadRequest,m.BadResponse,m.Unauthorized,m.SubprotocolNotAcceptable,m.SubscriberAlreadyExists,m.TooManyInitialisationRequests].includes(a.code)))throw a;if(J)return!1;if(Z(a)&&a.code===1e3)return O>0;if(!k||Q>=k||!W(a)||d?.(a))throw a;return F=!0}return $||(async()=>{for(O++;;)try{let[,,a]=await U();await a}catch(a){try{if(!h(a))return}catch(u){return A?.(u)}}})(),{on:n.on,subscribe(a,u){let o=z(a),t=!1,c=!1,b=()=>{O--,t=!0};return(async()=>{for(O++;;)try{let[r,f,E]=await U();if(t)return f();let S=n.onMessage(o,L=>{switch(L.type){case s.Next:{u.next(L.payload);return}case s.Error:{c=!0,t=!0,u.error(L.payload),b();return}case s.Complete:{t=!0,b();return}}});r.send(_({id:o,type:s.Subscribe,payload:a},D)),b=()=>{!t&&r.readyState===G.OPEN&&r.send(_({id:o,type:s.Complete},D)),O--,t=!0,f()},await E.finally(S);return}catch(r){if(!h(r))return}})().then(()=>{c||u.complete()}).catch(r=>{u.error(r)}),()=>{t||b()}},iterate(a){let u=[],o={done:!1,error:null,resolve:()=>{}},t=this.subscribe(a,{next(b){u.push(b),o.resolve()},error(b){o.done=!0,o.error=b,o.resolve()},complete(){o.done=!0,o.resolve()}}),c=function(){return oe(this,arguments,function*(){for(;;){for(u.length||(yield V(new Promise(f=>o.resolve=f)));u.length;)yield yield V(u.shift());if(o.error)throw o.error;if(o.done)return yield V(void 0)}})}();return c.throw=async b=>(o.done||(o.done=!0,o.error=b,o.resolve()),{done:!0,value:void 0}),c.return=async()=>(t(),{done:!0,value:void 0}),c},async dispose(){if(J=!0,I){let[a]=await I;a.close(1e3,"Normal Closure")}},terminate(){I&&n.emit("closed",{code:4499,reason:"Terminated",wasClean:!1})}}}function Z(e){return N(e)&&"code"in e&&"reason"in e}function ie(e){return[1e3,1001,1006,1005,1012,1013,1013].includes(e)?!1:e>=1e3&&e<=1999}function ae(e){return typeof e=="function"&&"constructor"in e&&"CLOSED"in e&&"CLOSING"in e&&"CONNECTING"in e&&"OPEN"in e}import{parse as ce,validate as ue,execute as le,subscribe as pe,getOperationAST as de,GraphQLError as fe}from"/v135/graphql@16.8.1/denonext/graphql.mjs";var se=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var p=e[Symbol.asyncIterator],T;return p?p.call(e):(e=typeof __values=="function"?__values(e):e[Symbol.iterator](),T={},$("next"),$("throw"),$("return"),T[Symbol.asyncIterator]=function(){return this},T);function $(g){T[g]=e[g]&&function(x){return new Promise(function(v,R){x=e[g](x),A(v,R,x.done,x.value)})}}function A(g,x,v,R){Promise.resolve(R).then(function(k){g({value:k,done:v})},x)}};function Oe(e){let{schema:p,context:T,roots:$,validate:A,execute:g,subscribe:x,connectionInitWaitTimeout:v=3e3,onConnect:R,onDisconnect:k,onClose:q,onSubscribe:W,onOperation:d,onNext:i,onError:M,onComplete:z,jsonMessageReviver:D,jsonMessageReplacer:B}=e;return{opened(l,G){let n={connectionInitReceived:!1,acknowledged:!1,subscriptions:{},extra:G};if(l.protocol!==C)return l.close(m.SubprotocolNotAcceptable,"Subprotocol not acceptable"),async(I,O)=>{await q?.(n,I,O)};let H=v>0&&isFinite(v)?setTimeout(()=>{n.connectionInitReceived||l.close(m.ConnectionInitialisationTimeout,"Connection initialisation timeout")},v):null;return l.onMessage(async function(O){var j,F,Q,J,U;let h;try{h=Y(O,D)}catch{return l.close(m.BadRequest,"Invalid message received")}switch(h.type){case s.ConnectionInit:{if(n.connectionInitReceived)return l.close(m.TooManyInitialisationRequests,"Too many initialisation requests");n.connectionInitReceived=!0,N(h.payload)&&(n.connectionParams=h.payload);let t=await R?.(n);if(t===!1)return l.close(m.Forbidden,"Forbidden");await l.send(_(N(t)?{type:s.ConnectionAck,payload:t}:{type:s.ConnectionAck},B)),n.acknowledged=!0;return}case s.Ping:{if(l.onPing)return await l.onPing(h.payload);await l.send(_(h.payload?{type:s.Pong,payload:h.payload}:{type:s.Pong}));return}case s.Pong:return await((U=l.onPong)===null||U===void 0?void 0:U.call(l,h.payload));case s.Subscribe:{if(!n.acknowledged)return l.close(m.Unauthorized,"Unauthorized");let{id:t,payload:c}=h;if(t in n.subscriptions)return l.close(m.SubscriberAlreadyExists,`Subscriber for ${t} already exists`);n.subscriptions[t]=null;let b={next:async(r,f)=>{let E={id:t,type:s.Next,payload:r},S=await i?.(n,E,f,r);S&&(E=Object.assign(Object.assign({},E),{payload:S})),await l.send(_(E,B))},error:async r=>{let f={id:t,type:s.Error,payload:r},E=await M?.(n,f,r);E&&(f=Object.assign(Object.assign({},f),{payload:E})),await l.send(_(f,B))},complete:async r=>{let f={id:t,type:s.Complete};await z?.(n,f),r&&await l.send(_(f,B))}};try{let r,f=await W?.(n,h);if(f){if(X(f))return await b.error(f);if(Array.isArray(f))throw new Error("Invalid return value from onSubscribe hook, expected an array of GraphQLError objects");r=f}else{if(!p)throw new Error("The GraphQL schema is not provided");let y={operationName:c.operationName,document:ce(c.query),variableValues:c.variables};r=Object.assign(Object.assign({},y),{schema:typeof p=="function"?await p(n,h,y):p});let w=(A??ue)(r.schema,r.document);if(w.length>0)return await b.error(w)}let E=de(r.document,r.operationName);if(!E)return await b.error([new fe("Unable to identify operation")]);"rootValue"in r||(r.rootValue=$?.[E.operation]),"contextValue"in r||(r.contextValue=typeof T=="function"?await T(n,h,r):T);let S;E.operation==="subscription"?S=await(x??pe)(r):S=await(g??le)(r);let L=await d?.(n,h,r,S);if(L&&(S=L),re(S))if(!(t in n.subscriptions))K(S)&&S.return(void 0);else{n.subscriptions[t]=S;try{for(var a=!0,u=se(S),o;o=await u.next(),j=o.done,!j;a=!0){J=o.value,a=!1;let y=J;await b.next(y,r)}}catch(y){F={error:y}}finally{try{!a&&!j&&(Q=u.return)&&await Q.call(u)}finally{if(F)throw F.error}}}else t in n.subscriptions&&await b.next(S,r);await b.complete(t in n.subscriptions)}finally{delete n.subscriptions[t]}return}case s.Complete:{let t=n.subscriptions[h.id];delete n.subscriptions[h.id],K(t)&&await t.return(void 0);return}default:throw new Error(`Unexpected message of type ${h.type} received`)}}),async(I,O)=>{H&&clearTimeout(H);for(let j of Object.values(n.subscriptions))K(j)&&await j.return(void 0);n.acknowledged&&await k?.(n,I,O),await q?.(n,I,O)}}}}function Re(e){switch(!0){case(e instanceof Set&&e.has(C)):case(Array.isArray(e)&&e.includes(C)):case(typeof e=="string"&&e.split(",").map(p=>p.trim()).includes(C)):return C;default:return!1}}export{m as CloseCode,be as DEPRECATED_GRAPHQL_WS_PROTOCOL,C as GRAPHQL_TRANSPORT_WS_PROTOCOL,s as MessageType,Ee as createClient,Re as handleProtocols,we as isMessage,Oe as makeServer,Y as parseMessage,_ as stringifyMessage,te as validateMessage};
//# sourceMappingURL=graphql-ws.mjs.map