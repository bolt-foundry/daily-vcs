/* esm.sh - esbuild bundle(follow-redirects@1.15.3) denonext production */
import * as __0$ from "node:url";
import * as __1$ from "node:http";
import * as __2$ from "node:https";
import * as __3$ from "node:stream";
import * as __4$ from "node:assert";
import * as __5$ from "/v135/debug@4.3.4/denonext/debug.mjs";
var require=n=>{const e=m=>typeof m.default<"u"?m.default:m,c=m=>Object.assign({},m);switch(n){case"url":return e(__0$);case"http":return e(__1$);case"https":return e(__2$);case"stream":return e(__3$);case"assert":return e(__4$);case"debug":return e(__5$);default:throw new Error("module \""+n+"\" not found");}};
var X=Object.create;var L=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var R=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var C=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Q=(e,t)=>{for(var r in t)L(e,r,{get:t[r],enumerable:!0})},w=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of j(t))!J.call(e,i)&&i!==r&&L(e,i,{get:()=>t[i],enumerable:!(o=Y(t,i))||o.enumerable});return e},l=(e,t,r)=>(w(e,t,"default"),r&&w(r,t,"default")),D=(e,t,r)=>(r=e!=null?X(K(e)):{},w(t||!e||!e.__esModule?L(r,"default",{value:e,enumerable:!0}):r,e));var P=C((fe,I)=>{var q;I.exports=function(){if(!q){try{q=R("debug")("follow-redirects")}catch{}typeof q!="function"&&(q=function(){})}q.apply(null,arguments)}});var A=C((de,O)=>{var m=R("url"),T=m.URL,Z=R("http"),k=R("https"),B=R("stream").Writable,F=R("assert"),W=P(),U=["abort","aborted","connect","error","socket","timeout"],H=Object.create(null);U.forEach(function(e){H[e]=function(t,r,o){this._redirectable.emit(e,t,r,o)}});var ee=E("ERR_INVALID_URL","Invalid URL",TypeError),S=E("ERR_FR_REDIRECTION_FAILURE","Redirected request failed"),te=E("ERR_FR_TOO_MANY_REDIRECTS","Maximum number of redirects exceeded"),re=E("ERR_FR_MAX_BODY_LENGTH_EXCEEDED","Request body larger than maxBodyLength limit"),oe=E("ERR_STREAM_WRITE_AFTER_END","write after end"),ie=B.prototype.destroy||G;function a(e,t){B.call(this),this._sanitizeOptions(e),this._options=e,this._ended=!1,this._ending=!1,this._redirectCount=0,this._redirects=[],this._requestBodyLength=0,this._requestBodyBuffers=[],t&&this.on("response",t);var r=this;this._onNativeResponse=function(o){r._processResponse(o)},this._performRequest()}a.prototype=Object.create(B.prototype);a.prototype.abort=function(){b(this._currentRequest),this._currentRequest.abort(),this.emit("abort")};a.prototype.destroy=function(e){return b(this._currentRequest,e),ie.call(this,e),this};a.prototype.write=function(e,t,r){if(this._ending)throw new oe;if(!v(e)&&!ne(e))throw new TypeError("data should be a string, Buffer or Uint8Array");if(g(t)&&(r=t,t=null),e.length===0){r&&r();return}this._requestBodyLength+e.length<=this._options.maxBodyLength?(this._requestBodyLength+=e.length,this._requestBodyBuffers.push({data:e,encoding:t}),this._currentRequest.write(e,t,r)):(this.emit("error",new re),this.abort())};a.prototype.end=function(e,t,r){if(g(e)?(r=e,e=t=null):g(t)&&(r=t,t=null),!e)this._ended=this._ending=!0,this._currentRequest.end(null,null,r);else{var o=this,i=this._currentRequest;this.write(e,t,function(){o._ended=!0,i.end(null,null,r)}),this._ending=!0}};a.prototype.setHeader=function(e,t){this._options.headers[e]=t,this._currentRequest.setHeader(e,t)};a.prototype.removeHeader=function(e){delete this._options.headers[e],this._currentRequest.removeHeader(e)};a.prototype.setTimeout=function(e,t){var r=this;function o(u){u.setTimeout(e),u.removeListener("timeout",u.destroy),u.addListener("timeout",u.destroy)}function i(u){r._timeout&&clearTimeout(r._timeout),r._timeout=setTimeout(function(){r.emit("timeout"),h()},e),o(u)}function h(){r._timeout&&(clearTimeout(r._timeout),r._timeout=null),r.removeListener("abort",h),r.removeListener("error",h),r.removeListener("response",h),r.removeListener("close",h),t&&r.removeListener("timeout",t),r.socket||r._currentRequest.removeListener("socket",i)}return t&&this.on("timeout",t),this.socket?i(this.socket):this._currentRequest.once("socket",i),this.on("socket",o),this.on("abort",h),this.on("error",h),this.on("response",h),this.on("close",h),this};["flushHeaders","getHeader","setNoDelay","setSocketKeepAlive"].forEach(function(e){a.prototype[e]=function(t,r){return this._currentRequest[e](t,r)}});["aborted","connection","socket"].forEach(function(e){Object.defineProperty(a.prototype,e,{get:function(){return this._currentRequest[e]}})});a.prototype._sanitizeOptions=function(e){if(e.headers||(e.headers={}),e.host&&(e.hostname||(e.hostname=e.host),delete e.host),!e.pathname&&e.path){var t=e.path.indexOf("?");t<0?e.pathname=e.path:(e.pathname=e.path.substring(0,t),e.search=e.path.substring(t))}};a.prototype._performRequest=function(){var e=this._options.protocol,t=this._options.nativeProtocols[e];if(!t){this.emit("error",new TypeError("Unsupported protocol "+e));return}if(this._options.agents){var r=e.slice(0,-1);this._options.agent=this._options.agents[r]}var o=this._currentRequest=t.request(this._options,this._onNativeResponse);o._redirectable=this;for(var i of U)o.on(i,H[i]);if(this._currentUrl=/^\//.test(this._options.path)?m.format(this._options):this._options.path,this._isRedirect){var h=0,u=this,d=this._requestBodyBuffers;(function p(n){if(o===u._currentRequest)if(n)u.emit("error",n);else if(h<d.length){var s=d[h++];o.finished||o.write(s.data,s.encoding,p)}else u._ended&&o.end()})()}};a.prototype._processResponse=function(e){var t=e.statusCode;this._options.trackRedirects&&this._redirects.push({url:this._currentUrl,headers:e.headers,statusCode:t});var r=e.headers.location;if(!r||this._options.followRedirects===!1||t<300||t>=400){e.responseUrl=this._currentUrl,e.redirects=this._redirects,this.emit("response",e),this._requestBodyBuffers=[];return}if(b(this._currentRequest),e.destroy(),++this._redirectCount>this._options.maxRedirects){this.emit("error",new te);return}var o,i=this._options.beforeRedirect;i&&(o=Object.assign({Host:e.req.getHeader("host")},this._options.headers));var h=this._options.method;((t===301||t===302)&&this._options.method==="POST"||t===303&&!/^(?:GET|HEAD)$/.test(this._options.method))&&(this._options.method="GET",this._requestBodyBuffers=[],x(/^content-/i,this._options.headers));var u=x(/^host$/i,this._options.headers),d=m.parse(this._currentUrl),p=u||d.host,n=/^\w+:/.test(r)?this._currentUrl:m.format(Object.assign(d,{host:p})),s;try{s=m.resolve(n,r)}catch(y){this.emit("error",new S({cause:y}));return}W("redirecting to",s),this._isRedirect=!0;var c=m.parse(s);if(Object.assign(this._options,c),(c.protocol!==d.protocol&&c.protocol!=="https:"||c.host!==p&&!se(c.host,p))&&x(/^(?:authorization|cookie)$/i,this._options.headers),g(i)){var f={headers:e.headers,statusCode:t},N={url:n,method:h,headers:o};try{i(this._options,f,N)}catch(y){this.emit("error",y);return}this._sanitizeOptions(this._options)}try{this._performRequest()}catch(y){this.emit("error",new S({cause:y}))}};function z(e){var t={maxRedirects:21,maxBodyLength:10485760},r={};return Object.keys(e).forEach(function(o){var i=o+":",h=r[i]=e[o],u=t[o]=Object.create(h);function d(n,s,c){if(v(n)){var f;try{f=M(new T(n))}catch{f=m.parse(n)}if(!v(f.protocol))throw new ee({input:n});n=f}else T&&n instanceof T?n=M(n):(c=s,s=n,n={protocol:i});return g(s)&&(c=s,s=null),s=Object.assign({maxRedirects:t.maxRedirects,maxBodyLength:t.maxBodyLength},n,s),s.nativeProtocols=r,!v(s.host)&&!v(s.hostname)&&(s.hostname="::1"),F.equal(s.protocol,i,"protocol mismatch"),W("options",s),new a(s,c)}function p(n,s,c){var f=u.request(n,s,c);return f.end(),f}Object.defineProperties(u,{request:{value:d,configurable:!0,enumerable:!0,writable:!0},get:{value:p,configurable:!0,enumerable:!0,writable:!0}})}),t}function G(){}function M(e){var t={protocol:e.protocol,hostname:e.hostname.startsWith("[")?e.hostname.slice(1,-1):e.hostname,hash:e.hash,search:e.search,pathname:e.pathname,path:e.pathname+e.search,href:e.href};return e.port!==""&&(t.port=Number(e.port)),t}function x(e,t){var r;for(var o in t)e.test(o)&&(r=t[o],delete t[o]);return r===null||typeof r>"u"?void 0:String(r).trim()}function E(e,t,r){function o(i){Error.captureStackTrace(this,this.constructor),Object.assign(this,i||{}),this.code=e,this.message=this.cause?t+": "+this.cause.message:t}return o.prototype=new(r||Error),o.prototype.constructor=o,o.prototype.name="Error ["+e+"]",o}function b(e,t){for(var r of U)e.removeListener(r,H[r]);e.on("error",G),e.destroy(t)}function se(e,t){F(v(e)&&v(t));var r=e.length-t.length-1;return r>0&&e[r]==="."&&e.endsWith(t)}function v(e){return typeof e=="string"||e instanceof String}function g(e){return typeof e=="function"}function ne(e){return typeof e=="object"&&"length"in e}O.exports=z({http:Z,https:k});O.exports.wrap=z});var _={};Q(_,{default:()=>ae,wrap:()=>he});var V=D(A());l(_,D(A()));var{wrap:he}=V,{default:$,...ue}=V,ae=$!==void 0?$:ue;export{ae as default,he as wrap};
//# sourceMappingURL=follow-redirects.mjs.map