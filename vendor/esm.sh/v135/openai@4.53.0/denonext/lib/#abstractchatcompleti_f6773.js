/* esm.sh - esbuild bundle(openai@4.53.0/lib/AbstractChatCompletionRunner) denonext production */
import{APIUserAbortError as X,OpenAIError as C}from"/v135/openai@4.53.0/denonext/error.js";import{isRunnableFunctionWithParse as z}from"/v135/openai@4.53.0/denonext/lib/RunnableFunction.js";import{isAssistantMessage as k,isFunctionMessage as Y,isToolMessage as Z}from"/v135/openai@4.53.0/denonext/lib/chatCompletionUtils.js";var h=function(a,t,n,e,s){if(e==="m")throw new TypeError("Private method is not writable");if(e==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?a!==t||!s:!t.has(a))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e==="a"?s.call(a,n):s?s.value=n:t.set(a,n),n},i=function(a,t,n,e){if(n==="a"&&!e)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?a!==t||!e:!t.has(a))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?e:n==="a"?e.call(a):e?e.value:t.get(a)},r,T,W,R,F,v,P,_,E,N,O,b,L,I,q,B,G,D,V,H,K=10,Q=class{constructor(){r.add(this),this.controller=new AbortController,T.set(this,void 0),W.set(this,()=>{}),R.set(this,()=>{}),F.set(this,void 0),v.set(this,()=>{}),P.set(this,()=>{}),_.set(this,{}),this._chatCompletions=[],this.messages=[],E.set(this,!1),N.set(this,!1),O.set(this,!1),b.set(this,!1),D.set(this,t=>{if(h(this,N,!0,"f"),t instanceof Error&&t.name==="AbortError"&&(t=new X),t instanceof X)return h(this,O,!0,"f"),this._emit("abort",t);if(t instanceof C)return this._emit("error",t);if(t instanceof Error){let n=new C(t.message);return n.cause=t,this._emit("error",n)}return this._emit("error",new C(String(t)))}),h(this,T,new Promise((t,n)=>{h(this,W,t,"f"),h(this,R,n,"f")}),"f"),h(this,F,new Promise((t,n)=>{h(this,v,t,"f"),h(this,P,n,"f")}),"f"),i(this,T,"f").catch(()=>{}),i(this,F,"f").catch(()=>{})}_run(t){setTimeout(()=>{t().then(()=>{this._emitFinal(),this._emit("end")},i(this,D,"f"))},0)}_addChatCompletion(t){this._chatCompletions.push(t),this._emit("chatCompletion",t);let n=t.choices[0]?.message;return n&&this._addMessage(n),t}_addMessage(t,n=!0){if("content"in t||(t.content=null),this.messages.push(t),n){if(this._emit("message",t),(Y(t)||Z(t))&&t.content)this._emit("functionCallResult",t.content);else if(k(t)&&t.function_call)this._emit("functionCall",t.function_call);else if(k(t)&&t.tool_calls)for(let e of t.tool_calls)e.type==="function"&&this._emit("functionCall",e.function)}}_connected(){this.ended||(i(this,W,"f").call(this),this._emit("connect"))}get ended(){return i(this,E,"f")}get errored(){return i(this,N,"f")}get aborted(){return i(this,O,"f")}abort(){this.controller.abort()}on(t,n){return(i(this,_,"f")[t]||(i(this,_,"f")[t]=[])).push({listener:n}),this}off(t,n){let e=i(this,_,"f")[t];if(!e)return this;let s=e.findIndex(l=>l.listener===n);return s>=0&&e.splice(s,1),this}once(t,n){return(i(this,_,"f")[t]||(i(this,_,"f")[t]=[])).push({listener:n,once:!0}),this}emitted(t){return new Promise((n,e)=>{h(this,b,!0,"f"),t!=="error"&&this.once("error",e),this.once(t,n)})}async done(){h(this,b,!0,"f"),await i(this,F,"f")}async finalChatCompletion(){await this.done();let t=this._chatCompletions[this._chatCompletions.length-1];if(!t)throw new C("stream ended without producing a ChatCompletion");return t}async finalContent(){return await this.done(),i(this,r,"m",L).call(this)}async finalMessage(){return await this.done(),i(this,r,"m",I).call(this)}async finalFunctionCall(){return await this.done(),i(this,r,"m",q).call(this)}async finalFunctionCallResult(){return await this.done(),i(this,r,"m",B).call(this)}async totalUsage(){return await this.done(),i(this,r,"m",G).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(t,...n){if(i(this,E,"f"))return;t==="end"&&(h(this,E,!0,"f"),i(this,v,"f").call(this));let e=i(this,_,"f")[t];if(e&&(i(this,_,"f")[t]=e.filter(s=>!s.once),e.forEach(({listener:s})=>s(...n))),t==="abort"){let s=n[0];!i(this,b,"f")&&!e?.length&&Promise.reject(s),i(this,R,"f").call(this,s),i(this,P,"f").call(this,s),this._emit("end");return}if(t==="error"){let s=n[0];!i(this,b,"f")&&!e?.length&&Promise.reject(s),i(this,R,"f").call(this,s),i(this,P,"f").call(this,s),this._emit("end")}}_emitFinal(){let t=this._chatCompletions[this._chatCompletions.length-1];t&&this._emit("finalChatCompletion",t);let n=i(this,r,"m",I).call(this);n&&this._emit("finalMessage",n);let e=i(this,r,"m",L).call(this);e&&this._emit("finalContent",e);let s=i(this,r,"m",q).call(this);s&&this._emit("finalFunctionCall",s);let l=i(this,r,"m",B).call(this);l!=null&&this._emit("finalFunctionCallResult",l),this._chatCompletions.some(J=>J.usage)&&this._emit("totalUsage",i(this,r,"m",G).call(this))}async _createChatCompletion(t,n,e){let s=e?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),i(this,r,"m",V).call(this,n);let l=await t.create({...n,stream:!1},{...e,signal:this.controller.signal});return this._connected(),this._addChatCompletion(l)}async _runChatCompletion(t,n,e){for(let s of n.messages)this._addMessage(s,!1);return await this._createChatCompletion(t,n,e)}async _runFunctions(t,n,e){let s="function",{function_call:l="auto",stream:J,...j}=n,f=typeof l!="string"&&l?.name,{maxChatCompletions:$=K}=e||{},y={};for(let o of n.functions)y[o.name||o.function.name]=o;let A=n.functions.map(o=>({name:o.name||o.function.name,parameters:o.parameters,description:o.description}));for(let o of n.messages)this._addMessage(o,!1);for(let o=0;o<$;++o){let p=(await this._createChatCompletion(t,{...j,function_call:l,functions:A,messages:[...this.messages]},e)).choices[0]?.message;if(!p)throw new C("missing message in ChatCompletion response");if(!p.function_call)return;let{name:c,arguments:d}=p.function_call,u=y[c];if(u){if(f&&f!==c){let m=`Invalid function_call: ${JSON.stringify(c)}. ${JSON.stringify(f)} requested. Please try again`;this._addMessage({role:s,name:c,content:m});continue}}else{let m=`Invalid function_call: ${JSON.stringify(c)}. Available options are: ${A.map(U=>JSON.stringify(U.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:c,content:m});continue}let M;try{M=z(u)?await u.parse(d):d}catch(m){this._addMessage({role:s,name:c,content:m instanceof Error?m.message:String(m)});continue}let w=await u.function(M,this),S=i(this,r,"m",H).call(this,w);if(this._addMessage({role:s,name:c,content:S}),f)return}}async _runTools(t,n,e){let s="tool",{tool_choice:l="auto",stream:J,...j}=n,f=typeof l!="string"&&l?.function?.name,{maxChatCompletions:$=K}=e||{},y={};for(let o of n.tools)o.type==="function"&&(y[o.function.name||o.function.function.name]=o.function);let A="tools"in n?n.tools.map(o=>o.type==="function"?{type:"function",function:{name:o.function.name||o.function.function.name,parameters:o.function.parameters,description:o.function.description}}:o):void 0;for(let o of n.messages)this._addMessage(o,!1);for(let o=0;o<$;++o){let p=(await this._createChatCompletion(t,{...j,tool_choice:l,tools:A,messages:[...this.messages]},e)).choices[0]?.message;if(!p)throw new C("missing message in ChatCompletion response");if(!p.tool_calls)return;for(let c of p.tool_calls){if(c.type!=="function")continue;let d=c.id,{name:u,arguments:M}=c.function,w=y[u];if(w){if(f&&f!==u){let g=`Invalid tool_call: ${JSON.stringify(u)}. ${JSON.stringify(f)} requested. Please try again`;this._addMessage({role:s,tool_call_id:d,content:g});continue}}else{let g=`Invalid tool_call: ${JSON.stringify(u)}. Available options are: ${A.map(x=>JSON.stringify(x.function.name)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:d,content:g});continue}let S;try{S=z(w)?await w.parse(M):M}catch(g){let x=g instanceof Error?g.message:String(g);this._addMessage({role:s,tool_call_id:d,content:x});continue}let m=await w.function(S,this),U=i(this,r,"m",H).call(this,m);if(this._addMessage({role:s,tool_call_id:d,content:U}),f)return}}}};T=new WeakMap,W=new WeakMap,R=new WeakMap,F=new WeakMap,v=new WeakMap,P=new WeakMap,_=new WeakMap,E=new WeakMap,N=new WeakMap,O=new WeakMap,b=new WeakMap,D=new WeakMap,r=new WeakSet,L=function(){return i(this,r,"m",I).call(this).content??null},I=function(){let t=this.messages.length;for(;t-- >0;){let n=this.messages[t];if(k(n)){let{function_call:e,...s}=n,l={...s,content:n.content??null};return e&&(l.function_call=e),l}}throw new C("stream ended without producing a ChatCompletionMessage with role=assistant")},q=function(){for(let t=this.messages.length-1;t>=0;t--){let n=this.messages[t];if(k(n)&&n?.function_call)return n.function_call;if(k(n)&&n?.tool_calls?.length)return n.tool_calls.at(-1)?.function}},B=function(){for(let t=this.messages.length-1;t>=0;t--){let n=this.messages[t];if(Y(n)&&n.content!=null||Z(n)&&n.content!=null&&this.messages.some(e=>e.role==="assistant"&&e.tool_calls?.some(s=>s.type==="function"&&s.id===n.tool_call_id)))return n.content}},G=function(){let t={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:n}of this._chatCompletions)n&&(t.completion_tokens+=n.completion_tokens,t.prompt_tokens+=n.prompt_tokens,t.total_tokens+=n.total_tokens);return t},V=function(t){if(t.n!=null&&t.n>1)throw new C("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},H=function(t){return typeof t=="string"?t:t===void 0?"undefined":JSON.stringify(t)};export{Q as AbstractChatCompletionRunner};
//# sourceMappingURL=AbstractChatCompletionRunner.js.map